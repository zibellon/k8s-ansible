# =============================================================================
# Prepare servers for Kubernetes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbooks/server-prepare.yaml --limit k8s-worker-1
# =============================================================================
# - disable swap
# - kernel modules (overlay, br_netfilter)
# - sysctl params
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate limit specified
# =============================================================================
- name: Pre-check - validate limit specified
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/server-prepare.yaml --limit <node>"
      when: ansible_limit is not defined
      run_once: true

    - name: Confirm target
      debug:
        msg: "Preparing server: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Prepare servers for Kubernetes
# =============================================================================
- name: Prepare servers for Kubernetes
  hosts: all
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # DISABLE SWAP
    # =========================================================================

    - name: Pre-Check swap status
      command: swapon --show
      register: swap_pre_check
      changed_when: false

    - name: Disable swap
      command: swapoff -a
      when: swap_pre_check.stdout | length > 0

    - name: Comment swap in /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*\s+swap\s+.*)$'
        replace: '# \1'
        backup: yes
      when: swap_pre_check.stdout | length > 0

    - name: Mask swap.target
      systemd:
        name: swap.target
        masked: yes
      when: swap_pre_check.stdout | length > 0

    # =========================================================================
    # SYSCTL PARAMETERS
    # =========================================================================

    - name: Create /etc/sysctl.d/k8s.conf
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          {% for param in k8s_sysctl_list %}
          {{ param }} = 1
          {% endfor %}
        mode: '0644'
      register: sysctl_conf_create_result

    # =========================================================================
    # KERNEL MODULES (overlay, br_netfilter)
    # =========================================================================

    - name: Create /etc/modules-load.d/k8s.conf
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          {% for module in k8s_module_list %}
          {{ module }}
          {% endfor %}
        mode: '0644'
      register: modules_conf_create_result

    # =========================================================================
    # SOFTDOG (WATCHDOG FOR MEDIK8S)
    # =========================================================================

    - name: Create softdog modprobe config
      copy:
        dest: /etc/modprobe.d/softdog.conf
        content: |
          options softdog soft_margin={{ softdog_timeout }}
          install softdog /sbin/modprobe --ignore-install softdog
        mode: '0644'
      register: softdog_conf_result

    - name: Create softdog systemd service
      copy:
        dest: /etc/systemd/system/softdog.service
        content: |
          [Unit]
          Description=Load softdog watchdog module
          After=systemd-modules-load.service

          [Service]
          Type=oneshot
          ExecStart=/sbin/modprobe softdog
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      register: softdog_service_result

    - name: Enable softdog service
      systemd:
        name: softdog.service
        enabled: true
        daemon_reload: true

    # =========================================================================
    # REBOOT
    # =========================================================================

    - name: Reboot servers
      reboot:
        reboot_timeout: 300
        msg: "Reboot"
      when: >-
        sysctl_conf_create_result.changed
        or modules_conf_create_result.changed
        or softdog_conf_result.changed
        or softdog_service_result.changed
        or (swap_pre_check.stdout | length > 0)

    # =========================================================================
    # FINAL VERIFICATION
    # =========================================================================

    # ======
    # SWAP
    # ======
    - name: Check swap status
      command: swapon --show
      register: swap_check
      changed_when: false

    - name: Assert swap is disabled
      assert:
        that:
          - swap_check.stdout | length == 0
        fail_msg: "Swap is still active"
        success_msg: "Swap disabled"

    # ======
    # SYSCTL
    # ======
    - name: Check sysctl parameter
      command: sysctl -n {{ item }}
      register: sysctl_check
      changed_when: false
      loop: "{{ k8s_sysctl_list }}"

    - name: Assert all sysctl parameters are 1
      assert:
        that:
          - item.stdout | trim == '1'
        fail_msg: "{{ item.item }} is NOT 1!"
        quiet: true
      loop: "{{ sysctl_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    # ======
    # MODULES
    # ======
    - name: Check loaded modules
      command: lsmod
      register: lsmod_check
      changed_when: false

    - name: Assert k8s modules are loaded
      assert:
        that:
          - "item in lsmod_check.stdout"
        fail_msg: "{{ item }} module is NOT loaded!"
        success_msg: "{{ item }}: OK"
      loop: "{{ k8s_module_list }}"

    - name: Print final status
      debug:
        msg: "=== Server Preparation Complete ==="
