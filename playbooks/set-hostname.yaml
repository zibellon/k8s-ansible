---
# =============================================================================
# Set hostname on server
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbooks/set-hostname.yaml --limit k8s-worker-1
# =============================================================================

# =============================================================================
# Play 0: Pre-check - validate limit specified
# =============================================================================
- name: Pre-check - validate limit specified
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/set-hostname.yaml --limit <node>"
      when: ansible_limit is not defined
      run_once: true

    - name: Confirm target
      debug:
        msg: "Setting hostname on: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Set hostname
# =============================================================================
- name: Set hostname on server
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Check current hostname
      command: hostname
      register: current_hostname_result
      changed_when: false

    - name: Set hostname
      command: hostnamectl set-hostname {{ new_hostname }}
      when: current_hostname_result.stdout != new_hostname
      register: hostname_change_result

    - name: Show result
      command: hostnamectl
      register: hostname_result
      changed_when: false

    - name: Print hostname info
      debug:
        msg: "{{ hostname_result.stdout_lines }}"

    - name: Reboot servers
      reboot:
        reboot_timeout: 300
        msg: "Rebooting"
      when: hostname_change_result is defined and hostname_change_result.changed
