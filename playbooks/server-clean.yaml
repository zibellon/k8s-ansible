---
# =============================================================================
# Clean server from Kubernetes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbooks/server-clean.yaml --limit k8s-worker-1
# =============================================================================
# Removes all Kubernetes configs and resets the node
# Can be used standalone or imported from other playbooks
# =============================================================================

# =============================================================================
# Play 0: Pre-check - validate limit specified
# =============================================================================
- name: Pre-check - validate limit specified
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/server-clean.yaml --limit <node>"
      when: ansible_limit is not defined
      run_once: true

    - name: Confirm target
      debug:
        msg: "Cleaning server: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Clean server from Kubernetes
# =============================================================================
- name: Clean server from Kubernetes
  hosts: all
  become: true

  tasks:
    - name: Reset kubeadm
      command: kubeadm reset --force
      register: reset_result
      failed_when: false

    - name: Print reset result
      debug:
        msg: "{{ reset_result.stdout_lines | default(['Reset done']) }}"

    - name: Stop kubelet
      systemd:
        name: kubelet
        state: stopped
      failed_when: false

    - name: Remove CNI config
      file:
        path: /etc/cni/net.d
        state: absent

    - name: Remove kubernetes directories
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /root/.kube

    - name: Print cleanup status
      debug:
        msg: "{{ new_hostname }}: cleanup complete"
