---
# =============================================================================
# Prepare servers for Cilium
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbooks/cilium-prepare.yaml --limit k8s-worker-1
# =============================================================================

# =============================================================================
# Play 0: Pre-check - validate limit specified
# =============================================================================
- name: Pre-check - validate limit specified
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/cilium-prepare.yaml --limit <node>"
      when: ansible_limit is not defined
      run_once: true

    - name: Confirm target
      debug:
        msg: "Preparing Cilium on: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Prepare servers for Cilium
# =============================================================================
- name: Prepare servers for Cilium
  hosts: all
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # LLVM + CLANG INSTALLATION
    # =========================================================================

    - name: PreCheck clang is installed
      command: which clang-{{ llvm_version }}
      register: clang_pre_check
      changed_when: false
      failed_when: false

    - name: Download LLVM install script
      get_url:
        url: https://apt.llvm.org/llvm.sh
        dest: /tmp/llvm.sh
        mode: '0755'
      when: clang_pre_check.rc != 0

    - name: Install LLVM {{ llvm_version }}
      command: /tmp/llvm.sh {{ llvm_version }} all
      when: clang_pre_check.rc != 0
      register: llvm_install

    # =========================================================================
    # eBPF MOUNT (sys-fs-bpf.mount)
    # =========================================================================

    - name: Pre-Check if BPF is already mounted
      command: findmnt -t bpf /sys/fs/bpf
      register: bpf_pre_check
      changed_when: false
      failed_when: false

    - name: Create sys-fs-bpf.mount unit
      copy:
        dest: /etc/systemd/system/sys-fs-bpf.mount
        content: |
          [Unit]
          Description=Cilium BPF mounts
          Documentation=https://docs.cilium.io/
          DefaultDependencies=no
          Before=local-fs.target umount.target kubelet.service
          After=swap.target

          [Mount]
          What=bpffs
          Where=/sys/fs/bpf
          Type=bpf
          Options=rw,nosuid,nodev,noexec,relatime,mode=700

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      register: bpf_mount_unit_create_result
      when: bpf_pre_check.rc != 0

    - name: Enable and start sys-fs-bpf.mount
      systemd:
        name: sys-fs-bpf.mount
        enabled: yes
        state: started
        daemon_reload: yes
      when: bpf_pre_check.rc != 0

    # =========================================================================
    # KERNEL MODULES FOR CILIUM
    # =========================================================================

    - name: Create /etc/modules-load.d/k8s-cilium.conf
      copy:
        dest: /etc/modules-load.d/k8s-cilium.conf
        content: |
          # Cilium required kernel modules
          {% for module in cilium_modules %}
          {{ module }}
          {% endfor %}
        mode: '0644'
      register: cilium_modules_conf_create_result

    # =========================================================================
    # REBOOT
    # =========================================================================

    - name: Reboot servers
      reboot:
        reboot_timeout: 300
        msg: "Rebooting"
      when: >-
        cilium_modules_conf_create_result.changed
        or (bpf_mount_unit_create_result is defined and bpf_mount_unit_create_result.changed)

    # =========================================================================
    # FINAL VERIFICATION
    # =========================================================================

    # ======
    # BPF
    # ======
    # rc=0 if OK, rc=1 if not
    - name: Check BPF mount after reboot
      command: mountpoint /sys/fs/bpf
      register: bpf_mount_check
      changed_when: false
      failed_when: false

    # rc=0 if OK, rc=1 if not
    - name: Check BPF filesystem type after reboot
      command: findmnt -t bpf /sys/fs/bpf
      register: bpf_type_check
      changed_when: false
      failed_when: false

    - name: Assert BPF mount is correct after reboot
      assert:
        that:
          - bpf_mount_check.rc == 0
          - bpf_type_check.rc == 0
        fail_msg: "BPF filesystem is not mounted correctly after reboot!"
        success_msg: "BPF mount: OK (type=bpf)"

    # ======
    # CLANG
    # ======

    # rc=0 if OK, rc=XXX if not found
    - name: Check clang version
      command: clang-{{ llvm_version }} --version
      register: clang_check
      changed_when: false
      failed_when: false

    - name: Assert clang is installed
      assert:
        that:
          - clang_check.rc == 0
        fail_msg: "clang-{{ llvm_version }} is NOT installed!"
        success_msg: "clang-{{ llvm_version }}: OK"

    # ======
    # MODULES
    # ======

    - name: Get loaded modules
      command: lsmod
      register: lsmod_check
      changed_when: false

    - name: Verify ALL modules are loaded
      assert:
        that:
          - "item in lsmod_check.stdout"
        fail_msg: "Module {{ item }} is NOT loaded!"
        success_msg: "{{ item }}: OK"
      loop: "{{ cilium_modules }}"

    - name: Print final status
      debug:
        msg:
          - "=== Cilium Complete ==="
          - "clang-{{ llvm_version }}: {{ 'OK' if clang_check.rc == 0 else 'NOT_OK' }}"
          - "bpf_mount: {{ 'OK' if bpf_mount_check.rc == 0 else 'NOT_OK' }}"
          - "bpf_type: {{ 'OK' if bpf_type_check.rc == 0 else 'NOT_OK' }}"
          - "modules: ALL {{ cilium_modules | length }} loaded"
