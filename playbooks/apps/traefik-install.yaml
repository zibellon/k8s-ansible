# =============================================================================
# TRAEFIK INSTALLATION VIA LOCAL HELM CHART
# Installs Traefik CRDs first, then Traefik as DaemonSet
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/traefik-install.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Installing Traefik on master manager: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Install Traefik via local Helm chart
# =============================================================================
- name: Install Traefik via local Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # -------------------------------------------------------------------------
    # COPY LOCAL HELM CHARTS
    # -------------------------------------------------------------------------

    - name: Ensure remote charts directory exists
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    # traefik chart (includes crds/ subdirectory)
    - name: Remove old traefik chart from remote server
      file:
        path: "{{ remote_charts_dir }}/traefik"
        state: absent

    - name: Copy traefik chart to remote server
      copy:
        src: "{{ playbook_dir }}/charts/traefik/"
        dest: "{{ remote_charts_dir }}/traefik/"
        mode: "0644"

    # -------------------------------------------------------------------------
    # INSTALL TRAEFIK CRDs FIRST
    # -------------------------------------------------------------------------

    - name: Install traefik CRDs via kubectl
      command: kubectl create -f {{ remote_charts_dir }}/traefik/crds/crds.yaml
      failed_when: false

    - name: Wait for Traefik CRDs to be established
      command: >
        kubectl wait --for=condition=Established crd/ingressroutes.traefik.io
        crd/ingressroutetcps.traefik.io
        crd/ingressrouteudps.traefik.io
        crd/middlewares.traefik.io
        crd/middlewaretcps.traefik.io
        crd/serverstransports.traefik.io
        crd/serverstransporttcps.traefik.io
        crd/tlsoptions.traefik.io
        crd/tlsstores.traefik.io
        crd/traefikservices.traefik.io
        --timeout=60s
      changed_when: false

    # -------------------------------------------------------------------------
    # CREATE VALUES FILE
    # -------------------------------------------------------------------------

    - name: Create traefik values file
      copy:
        dest: "{{ remote_charts_dir }}/traefik/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
          image: "traefik:v{{ traefik_version }}"
          ingressClass: {{ traefik_ingress_class }}
          entryPoints:
            web: {{ traefik_web_entrypoint }}
            websecure: {{ traefik_websecure_entrypoint }}
          vpnIps: {{ vpn_ips | to_json }}
          dashboard:
            domain: {{ traefik_dashboard_domain }}
            secretName: {{ traefik_dashboard_https_secret_name }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            vpnOnlyEnabled: {{ traefik_dashboard_vpn_only_enabled }}

    # -------------------------------------------------------------------------
    # INSTALL OR UPGRADE TRAEFIK
    # -------------------------------------------------------------------------

    - name: Install or upgrade traefik via Helm
      command: >
        helm upgrade --install traefik {{ remote_charts_dir }}/traefik
        --namespace {{ traefik_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/traefik/values-override.yaml
        --skip-crds
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # -------------------------------------------------------------------------
    # VERIFY INSTALLATION
    # -------------------------------------------------------------------------

    - name: Wait for Traefik DaemonSet to be ready
      command: kubectl rollout status daemonset/traefik-master -n {{ traefik_namespace }} --timeout=300s

    - name: Verify Traefik installation
      command: helm list -n {{ traefik_namespace }}
      register: helm_verify
      changed_when: false

    - name: Show Traefik Helm release
      debug:
        var: helm_verify.stdout_lines
