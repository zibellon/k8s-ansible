# =============================================================================
# Install Traefik via official Helm chart (traefik/traefik)
# Steps:
#   1. traefik/pre: NetworkPolicies for traefik namespace
#   2. Official traefik/traefik chart (DaemonSet, Services, RBAC, CRDs)
#   3. traefik/post: Middlewares + Dashboard Ingress
# =============================================================================

---
- name: Install Traefik via official Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # STEP 1: TRAEFIK/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[traefik-pre] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[traefik-pre] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/traefik/pre"
        state: absent

    - name: "[traefik-pre] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/traefik/pre/"
        dest: "{{ remote_charts_dir }}/traefik/pre/"
        mode: "0644"

    - name: "[traefik-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}

    - name: "[traefik-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-pre {{ remote_charts_dir }}/traefik/pre
        --namespace {{ traefik_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/traefik/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # STEP 2: OFFICIAL TRAEFIK CHART
    # =========================================================================

    - name: "[traefik-install] Add Traefik Helm repository"
      command: helm repo add traefik https://traefik.github.io/charts
      register: helm_repo_add
      changed_when: "'has been added' in helm_repo_add.stdout"
      failed_when: false

    - name: "[traefik-install] Update Helm repositories"
      command: helm repo update traefik

    - name: "[traefik-install] Create values directory"
      file:
        path: "{{ remote_charts_dir }}/traefik/install"
        state: directory
        mode: "0755"

    - name: "[traefik-install] Create values-override.yaml"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/install/values-override.yaml"
        mode: "0644"
        content: |
          # Traefik Helm Chart Values
          # Generated from hosts.yaml variables

          image:
            tag: v{{ traefik_version }}

          fullnameOverride: "{{ traefik_daemonset_name }}"

          serviceAccountAnnotations:
            app.kubernetes.io/component: ingress-controller

          deployment:
            kind: DaemonSet
            annotations:
              app.kubernetes.io/component: ingress-controller

          ingressClass:
            enabled: true
            name: "{{ traefik_ingress_class }}"
            isDefaultClass: false

          service:
            type: NodePort
            annotations:
              app.kubernetes.io/component: ingress-controller
            spec:
              externalTrafficPolicy: Local

          ports:
            traefik:
              port: 8080
              expose:
                default: false
            web:
              asDefault: true
              port: 80
              nodePort: 80
              expose:
                default: true
              exposedPort: 80
              forwardedHeaders:
                insecure: true
              proxyProtocol:
                insecure: true
              transport:
                respondingTimeouts:
                  idleTimeout: 600
                  writeTimeout: 600
                  readTimeout: 600
            websecure:
              asDefault: true
              port: 443
              nodePort: 443
              expose:
                default: true
              exposedPort: 443
              http:
                tls:
                  enabled: true
              forwardedHeaders:
                insecure: true
              proxyProtocol:
                insecure: true
              transport:
                respondingTimeouts:
                  idleTimeout: 600
                  writeTimeout: 600
                  readTimeout: 600
            metrics:
              expose:
                default: false

          providers:
            kubernetesCRD:
              enabled: true
              ingressClass: "{{ traefik_ingress_class }}"
              allowCrossNamespace: true
            kubernetesIngress:
              enabled: true
              ingressClass: "{{ traefik_ingress_class }}"
              publishedService:
                enabled: false

          logs:
            general:
              level: DEBUG
              format: json
            access:
              enabled: true
              format: json

          api:
            dashboard: true

          metrics:
            prometheus:
              entryPoint: metrics

          additionalArguments:
            - "--api.insecure=true"

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532

          podSecurityContext:
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532

          # Separate Service for dashboard (ClusterIP)
          extraObjects:
            - apiVersion: v1
              kind: Service
              metadata:
                name: {{ traefik_dashboard_service_name }}
                labels:
                  app.kubernetes.io/name: traefik
                  app.kubernetes.io/instance: traefik-{{ traefik_namespace }}
              spec:
                type: ClusterIP
                selector:
                  app.kubernetes.io/name: traefik
                  app.kubernetes.io/instance: traefik-{{ traefik_namespace }}
                ports:
                  - name: dashboard
                    protocol: TCP
                    port: 8080
                    targetPort: 8080

    - name: "[traefik-install] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik traefik/traefik
        --namespace {{ traefik_namespace }}
        --version {{ traefik_chart_version }}
        --values {{ remote_charts_dir }}/traefik/install/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # WAIT FOR TRAEFIK CRDs
    # =========================================================================

    - name: "[traefik-install] Wait for CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/ingressroutes.traefik.io
        crd/ingressroutetcps.traefik.io
        crd/ingressrouteudps.traefik.io
        crd/middlewares.traefik.io
        crd/middlewaretcps.traefik.io
        crd/serverstransports.traefik.io
        crd/serverstransporttcps.traefik.io
        crd/tlsoptions.traefik.io
        crd/tlsstores.traefik.io
        crd/traefikservices.traefik.io
        --timeout={{ crds_wait.timeout }}
      register: traefik_crds_wait
      until: traefik_crds_wait.rc == 0
      retries: "{{ crds_wait.retries }}"
      delay: "{{ crds_wait.delay }}"
      changed_when: false

    # =========================================================================
    # WAIT FOR TRAEFIK TO BE READY
    # =========================================================================

    - name: "[traefik-install] Wait for DaemonSet to be ready"
      command: kubectl rollout status daemonset/{{ traefik_daemonset_name }} -n {{ traefik_namespace }} --timeout={{ traefik_rollout_timeout }}

    # =========================================================================
    # STEP 3: TRAEFIK/POST (Middlewares + Dashboard Ingress)
    # =========================================================================

    - name: "[traefik-post] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/traefik/post"
        state: absent

    - name: "[traefik-post] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/traefik/post/"
        dest: "{{ remote_charts_dir }}/traefik/post/"
        mode: "0644"

    - name: "[traefik-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
          ingressClass: {{ traefik_ingress_class }}
          entryPoints:
            web: {{ traefik_web_entrypoint }}
            websecure: {{ traefik_websecure_entrypoint }}
          vpnIps: {{ vpn_ips | to_json }}
          dashboard:
            serviceName: {{ traefik_dashboard_service_name }}
            domain: {{ traefik_dashboard_domain }}
            secretName: {{ traefik_dashboard_https_secret_name }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            vpnOnlyEnabled: {{ traefik_dashboard_vpn_only_enabled }}

    - name: "[traefik-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-post {{ remote_charts_dir }}/traefik/post
        --namespace {{ traefik_namespace }}
        --values {{ remote_charts_dir }}/traefik/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: Get Traefik Helm releases
      command: helm list -n {{ traefik_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Installation complete
      debug:
        msg: "traefik-pre + traefik + traefik-post: OK"
