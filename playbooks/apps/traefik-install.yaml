# =============================================================================
# Install Traefik via local Helm chart
# Steps:
#   1. traefik/pre: NetworkPolicies for traefik namespace
#   2. CRDs (kubectl create -f) + traefik/install (DaemonSet, Services, RBAC)
#   3. traefik/post: Middlewares + Dashboard Ingress
# =============================================================================

---
- name: Install Traefik via local Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # STEP 1: TRAEFIK/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[traefik-pre] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[traefik-pre] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/traefik/pre"
        state: absent

    - name: "[traefik-pre] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/traefik/pre/"
        dest: "{{ remote_charts_dir }}/traefik/pre/"
        mode: "0644"

    - name: "[traefik-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}

    - name: "[traefik-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-pre {{ remote_charts_dir }}/traefik/pre
        --namespace {{ traefik_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/traefik/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # STEP 2: CRDs + TRAEFIK/INSTALL
    # =========================================================================

    - name: "[traefik-install] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/traefik/install"
        state: absent

    - name: "[traefik-install] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/traefik/install/"
        dest: "{{ remote_charts_dir }}/traefik/install/"
        mode: "0644"

    # Install CRDs separately via kubectl
    - name: "[traefik-install] Install Traefik CRDs via kubectl"
      command: kubectl create -f {{ remote_charts_dir }}/traefik/install/crds/crds.yaml
      failed_when: false

    - name: "[traefik-install] Wait for CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/ingressroutes.traefik.io
        crd/ingressroutetcps.traefik.io
        crd/ingressrouteudps.traefik.io
        crd/middlewares.traefik.io
        crd/middlewaretcps.traefik.io
        crd/serverstransports.traefik.io
        crd/serverstransporttcps.traefik.io
        crd/tlsoptions.traefik.io
        crd/tlsstores.traefik.io
        crd/traefikservices.traefik.io
        --timeout={{ traefik_crds_timeout }}
      changed_when: false

    - name: "[traefik-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/install/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
          daemonsetName: {{ traefik_daemonset_name }}
          image: "traefik:v{{ traefik_version }}"
          ingressClass: {{ traefik_ingress_class }}
          entryPoints:
            web: {{ traefik_web_entrypoint }}
            websecure: {{ traefik_websecure_entrypoint }}

    - name: "[traefik-install] Install or upgrade via Helm (skip-crds)"
      command: >
        helm upgrade --install traefik {{ remote_charts_dir }}/traefik/install
        --namespace {{ traefik_namespace }}
        --values {{ remote_charts_dir }}/traefik/install/values-override.yaml
        --skip-crds
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # WAIT FOR TRAEFIK TO BE READY
    # =========================================================================

    - name: "[traefik-install] Wait for DaemonSet to be ready"
      command: kubectl rollout status daemonset/{{ traefik_daemonset_name }} -n {{ traefik_namespace }} --timeout={{ traefik_rollout_timeout }}

    # =========================================================================
    # STEP 3: TRAEFIK/POST (Middlewares + Dashboard Ingress)
    # =========================================================================

    - name: "[traefik-post] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/traefik/post"
        state: absent

    - name: "[traefik-post] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/traefik/post/"
        dest: "{{ remote_charts_dir }}/traefik/post/"
        mode: "0644"

    - name: "[traefik-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
          ingressClass: {{ traefik_ingress_class }}
          entryPoints:
            web: {{ traefik_web_entrypoint }}
            websecure: {{ traefik_websecure_entrypoint }}
          vpnIps: {{ vpn_ips | to_json }}
          dashboard:
            domain: {{ traefik_dashboard_domain }}
            secretName: {{ traefik_dashboard_https_secret_name }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            vpnOnlyEnabled: {{ traefik_dashboard_vpn_only_enabled }}

    - name: "[traefik-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-post {{ remote_charts_dir }}/traefik/post
        --namespace {{ traefik_namespace }}
        --values {{ remote_charts_dir }}/traefik/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: Get Traefik Helm releases
      command: helm list -n {{ traefik_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Installation complete
      debug:
        msg: "traefik-pre + traefik + traefik-post: OK"
