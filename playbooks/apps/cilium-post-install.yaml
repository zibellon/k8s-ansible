# =============================================================================
# Install Cilium post-config via Helm on manager node
# Requires: Cilium, cert-manager, traefik
# Includes: Hubble UI Ingress + NetworkPolicy for cilium namespace
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/cilium-post-install.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Installing Cilium Post-Config: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Install Cilium Post-Config via Helm
# =============================================================================
- name: Install Cilium Post-Config
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # COPY CHART TO SERVER
    # =========================================================================
    - name: Ensure remote charts directory exists
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: Remove old cilium-post-config chart from remote server
      file:
        path: "{{ remote_charts_dir }}/cilium-post-config"
        state: absent

    - name: Copy cilium-post-config chart to server
      copy:
        src: "{{ playbook_dir }}/charts/cilium-post-config/"
        dest: "{{ remote_charts_dir }}/cilium-post-config/"
        mode: "0644"

    - name: Create cilium-post-config values file
      copy:
        dest: "{{ remote_charts_dir }}/cilium-post-config/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cilium_namespace }}
          hubbleUi:
            domain: {{ cilium_hubble_ui_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            secretName: {{ cilium_hubble_ui_https_secret_name }}
            vpnOnlyEnabled: {{ cilium_hubble_ui_vpn_only_enabled }}
          traefik:
            namespace: {{ traefik_namespace }}

    # =========================================================================
    # INSTALL CILIUM-POST-CONFIG
    # =========================================================================
    - name: Install or upgrade cilium-post-config via Helm
      command: >
        helm upgrade --install cilium-post-config {{ remote_charts_dir }}/cilium-post-config
        --namespace {{ cilium_namespace }}
        --values {{ remote_charts_dir }}/cilium-post-config/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_post_config_helm_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================
    - name: Get Helm release info
      command: helm list -n {{ cilium_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm release info
      debug:
        msg: "{{ helm_list.stdout_lines }}"
