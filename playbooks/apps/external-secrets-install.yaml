# =============================================================================
# Install External Secrets Operator
# Steps:
#   1. external-secrets/pre: NetworkPolicies
#   2. CRDs (kubectl create -f) + official Helm chart (--skip-crds)
#   3. external-secrets/post: empty
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/external-secrets-install.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Installing External Secrets Operator on master manager: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Install External Secrets Operator
# =============================================================================
- name: Install External Secrets Operator
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # STEP 1: EXTERNAL-SECRETS/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[external-secrets-pre] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[external-secrets-pre] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/external-secrets/pre"
        state: absent

    - name: "[external-secrets-pre] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/external-secrets/pre/"
        dest: "{{ remote_charts_dir }}/external-secrets/pre/"
        mode: "0644"

    - name: "[external-secrets-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/external-secrets/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ external_secrets_namespace }}

    - name: "[external-secrets-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install external-secrets-pre {{ remote_charts_dir }}/external-secrets/pre
        --namespace {{ external_secrets_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/external-secrets/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ external_secrets_helm_timeout }}

    # =========================================================================
    # STEP 2: CRDs + OFFICIAL HELM CHART
    # =========================================================================

    - name: "[external-secrets-install] Remove old CRDs from remote server"
      file:
        path: "{{ remote_charts_dir }}/external-secrets/install"
        state: absent

    - name: "[external-secrets-install] Copy CRDs to server"
      copy:
        src: "{{ playbook_dir }}/charts/external-secrets/install/"
        dest: "{{ remote_charts_dir }}/external-secrets/install/"
        mode: "0644"

    # Install CRDs separately via kubectl (server-side apply required for large CRDs)
    - name: "[external-secrets-install] Install CRDs via kubectl"
      command: kubectl create -f {{ remote_charts_dir }}/external-secrets/install/crds/crds.yaml
      failed_when: false

    - name: "[external-secrets-install] Wait for CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/externalsecrets.external-secrets.io
        crd/clustersecretstores.external-secrets.io
        crd/secretstores.external-secrets.io
        crd/clusterexternalsecrets.external-secrets.io
        crd/pushsecrets.external-secrets.io
        crd/clusterpushsecrets.external-secrets.io
        --timeout={{ external_secrets_crds_timeout }}
      changed_when: false

    # Add Helm repository
    - name: "[external-secrets-install] Add Helm repository"
      command: helm repo add external-secrets https://charts.external-secrets.io --force-update

    - name: "[external-secrets-install] Update Helm repositories"
      command: helm repo update

    # Create values file for official chart
    - name: "[external-secrets-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/external-secrets/install/values-override.yaml"
        mode: "0644"
        content: |
          # Disable CRDs installation (installed via kubectl)
          installCRDs: false

          # Image settings
          image:
            repository: ghcr.io/external-secrets/external-secrets
            tag: "v{{ external_secrets_version }}"

          # Webhook settings
          webhook:
            image:
              repository: ghcr.io/external-secrets/external-secrets
              tag: "v{{ external_secrets_version }}"

          # Cert controller settings
          certController:
            image:
              repository: ghcr.io/external-secrets/external-secrets
              tag: "v{{ external_secrets_version }}"

    # Install official Helm chart
    - name: "[external-secrets-install] Install or upgrade via Helm (skip-crds)"
      command: >
        helm upgrade --install external-secrets external-secrets/external-secrets
        --namespace {{ external_secrets_namespace }}
        --values {{ remote_charts_dir }}/external-secrets/install/values-override.yaml
        --skip-crds
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ external_secrets_helm_timeout }}

    # =========================================================================
    # WAIT FOR DEPLOYMENT
    # =========================================================================

    - name: "[external-secrets-install] Wait for deployment to be ready"
      command: kubectl rollout status deployment/external-secrets -n {{ external_secrets_namespace }} --timeout={{ external_secrets_rollout_timeout }}

    - name: "[external-secrets-install] Wait for webhook deployment to be ready"
      command: kubectl rollout status deployment/external-secrets-webhook -n {{ external_secrets_namespace }} --timeout={{ external_secrets_rollout_timeout }}

    - name: "[external-secrets-install] Wait for cert-controller deployment to be ready"
      command: kubectl rollout status deployment/external-secrets-cert-controller -n {{ external_secrets_namespace }} --timeout={{ external_secrets_rollout_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[verify] Get Helm releases"
      command: helm list -n {{ external_secrets_namespace }}
      register: helm_list
      changed_when: false

    - name: "[verify] Print Helm releases"
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: "[verify] Installation complete"
      debug:
        msg: "external-secrets-pre + external-secrets: OK"
