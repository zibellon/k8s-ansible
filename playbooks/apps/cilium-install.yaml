# =============================================================================
# Install Cilium CNI via Helm on manager node
# Replaces kube-proxy, enables Hubble and host firewall
# Includes: cilium-config (NetworkPolicies)
# For Hubble UI Ingress use: cilium-hubble-install.yaml
# =============================================================================

---
- name: Install Cilium CNI
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # ADD HELM REPO
    # =========================================================================
    - name: Add Cilium Helm repository
      command: helm repo add cilium https://helm.cilium.io/ --force-update
      failed_when: false

    - name: Update Helm repositories
      command: helm repo update
      changed_when: false

    # =========================================================================
    # CREATE VALUES FILE
    # =========================================================================
    - name: Ensure cilium charts directory exists
      file:
        path: "{{ remote_charts_dir }}/cilium"
        state: directory
        mode: "0755"

    - name: Create cilium values file
      copy:
        dest: "{{ remote_charts_dir }}/cilium/values-override.yaml"
        mode: "0644"
        content: |
          ipam:
            operator:
              clusterPoolIPv4PodCIDRList:
                - {{ pod_subnet }}
              clusterPoolIPv4MaskSize: {{ cilium_mask_size }}
          operator:
            replicas: {{ cilium_operator_replicas }}
          kubeProxyReplacement: true
          kubeProxyReplacementHealthzBindAddr: "0.0.0.0:10256"
          k8sServiceHost: {{ haproxy_apiserver_lb_host }}
          k8sServicePort: {{ haproxy_apiserver_lb_port }}
          nodePort:
            range: "{{ node_port_start }},{{ node_port_end }}"
          hubble:
            relay:
              enabled: true
            ui:
              enabled: true
            peerService:
              clusterDomain: {{ dns_domain }}
          hostFirewall:
            enabled: true

    # =========================================================================
    # INSTALL CILIUM
    # =========================================================================
    - name: Install or upgrade Cilium via Helm
      command: >
        helm upgrade --install cilium cilium/cilium
        --version {{ cilium_version }}
        --namespace {{ cilium_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/cilium/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_helm_timeout }}

    # =========================================================================
    # WAIT FOR CILIUM CRDs
    # =========================================================================
    - name: Wait for Cilium CRDs to be established
      command: >
        kubectl wait --for=condition=Established
        crd/ciliumcidrgroups.cilium.io
        crd/ciliumclusterwidenetworkpolicies.cilium.io
        crd/ciliumendpoints.cilium.io
        crd/ciliumidentities.cilium.io
        crd/ciliuml2announcementpolicies.cilium.io
        crd/ciliumloadbalancerippools.cilium.io
        crd/ciliumnetworkpolicies.cilium.io
        crd/ciliumnodeconfigs.cilium.io
        crd/ciliumnodes.cilium.io
        crd/ciliumpodippools.cilium.io
        --timeout={{ cilium_crds_timeout }}
      changed_when: false

    # =========================================================================
    # INSTALL CILIUM-CONFIG
    # =========================================================================
    - name: Ensure remote charts directory exists
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: Remove old cilium-config chart from remote server
      file:
        path: "{{ remote_charts_dir }}/cilium-config"
        state: absent

    - name: Copy cilium-config chart to server
      copy:
        src: "{{ playbook_dir }}/charts/cilium-config/"
        dest: "{{ remote_charts_dir }}/cilium-config/"
        mode: "0644"

    - name: Create cilium-config values file
      copy:
        dest: "{{ remote_charts_dir }}/cilium-config/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cilium_namespace }}
          nodeIps: {{
            (
              (groups['managers'] + groups['workers'])
              | map('extract', hostvars, 'ansible_host')
              | map('regex_replace', '$', '/32')
              | list
              +
              (groups['managers'] + groups['workers'])
              | map('extract', hostvars, 'internal_ip')
              | map('regex_replace', '$', '/32')
              | list
            ) | to_json }}

    - name: Install or upgrade cilium-config via Helm
      command: >
        helm upgrade --install cilium-config {{ remote_charts_dir }}/cilium-config
        --namespace {{ cilium_namespace }}
        --values {{ remote_charts_dir }}/cilium-config/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_config_helm_timeout }}

    # =========================================================================
    # WAIT FOR CILIUM TO BE READY
    # =========================================================================
    - name: Wait for Cilium DaemonSet rollouts to complete
      command: kubectl rollout status daemonset/{{ item }} -n {{ cilium_namespace }} --timeout={{ cilium_daemonset_rollout_timeout }}
      loop:
        - cilium
        - cilium-envoy

    - name: Wait for Cilium Deployment rollouts to complete
      command: kubectl rollout status deployment/{{ item }} -n {{ cilium_namespace }} --timeout={{ cilium_deployment_rollout_timeout }}
      loop:
        - cilium-operator

    # =========================================================================
    # VERIFICATION
    # =========================================================================
    - name: Get Cilium Helm release info
      command: helm list -n {{ cilium_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm release info
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Get Cilium pods status
      command: kubectl get pods -n {{ cilium_namespace }} -o wide
      register: cilium_pods
      changed_when: false

    - name: Print Cilium pods status
      debug:
        msg: "{{ cilium_pods.stdout_lines }}"
