# =============================================================================
# Install OLM v0 via local Helm chart
# Steps:
#   1. olm-v0/pre: No resources (README only)
#   2. olm-v0/install: CRDs + Namespaces + Helm chart
#   3. olm-v0/post: No resources (README only)
# =============================================================================

---
- name: Install OLM-v0 via local Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # STEP 1: OLM-V0/PRE (No resources)
    # =========================================================================

    - name: "[olm-v0-pre] Skip - no pre-install resources"
      debug:
        msg: "olm-v0/pre: No resources to install"

    # =========================================================================
    # STEP 2: OLM-V0/INSTALL (CRDs + Namespaces + Helm)
    # =========================================================================

    - name: "[olm-v0-install] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[olm-v0-install] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/olm-v0/install"
        state: absent

    - name: "[olm-v0-install] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/olm-v0/install/"
        dest: "{{ remote_charts_dir }}/olm-v0/install/"
        mode: "0644"

    # Install CRDs first
    - name: "[olm-v0-install] Install OLM CRDs via kubectl"
      command: kubectl create -f {{ remote_charts_dir }}/olm-v0/install/crds/crds.yaml
      failed_when: false

    - name: "[olm-v0-install] Wait for OLM CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/catalogsources.operators.coreos.com
        crd/clusterserviceversions.operators.coreos.com
        crd/installplans.operators.coreos.com
        crd/olmconfigs.operators.coreos.com
        crd/operatorconditions.operators.coreos.com
        crd/operatorgroups.operators.coreos.com
        crd/operators.operators.coreos.com
        crd/subscriptions.operators.coreos.com
        --timeout={{ olm_crds_timeout }}
      changed_when: false

    # Create namespaces
    - name: "[olm-v0-install] Apply OLM namespaces (olm + operators)"
      command: kubectl apply -f {{ remote_charts_dir }}/olm-v0/install/namespaces.yaml

    # Create values file
    - name: "[olm-v0-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/olm-v0/install/values-override.yaml"
        mode: "0644"
        content: |
          replicas: 1

    # Install Helm chart
    - name: "[olm-v0-install] Install or upgrade via Helm (skip-crds)"
      command: >
        helm upgrade --install olm-v0 {{ remote_charts_dir }}/olm-v0/install
        --namespace {{ olm_namespace }}
        --values {{ remote_charts_dir }}/olm-v0/install/values-override.yaml
        --skip-crds
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ olm_helm_timeout }}

    # =========================================================================
    # WAIT FOR OLM TO BE READY
    # =========================================================================

    - name: "[olm-v0-install] Wait for OLM operators to be ready"
      command: kubectl rollout status deployment/{{ item }} -n {{ olm_namespace }} --timeout={{ olm_rollout_timeout }}
      loop:
        - olm-operator
        - catalog-operator

    - name: "[olm-v0-install] Wait for PackageServer CSV to succeed"
      command: >
        kubectl wait --for=jsonpath='{.status.phase}'=Succeeded
        csv/packageserver -n {{ olm_namespace }}
        --timeout={{ olm_rollout_timeout }}
      register: packageserver_wait
      retries: 3
      delay: 10
      until: packageserver_wait.rc == 0

    # =========================================================================
    # STEP 3: OLM-V0/POST (No resources)
    # =========================================================================

    - name: "[olm-v0-post] Skip - no post-install resources"
      debug:
        msg: "olm-v0/post: No resources to install"

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: Get OLM Helm releases
      command: helm list -n {{ olm_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Installation complete
      debug:
        msg: "olm-v0: OK"
