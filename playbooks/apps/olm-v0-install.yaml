# =============================================================================
# OLM V0 INSTALLATION VIA LOCAL HELM CHART
# Installs OLM CRDs first, then OLM components
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/olm-v0-install.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Installing OLM-v0: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Install OLM-v0 via local Helm chart
# =============================================================================
- name: Install OLM-v0 via local Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # -------------------------------------------------------------------------
    # COPY LOCAL HELM CHARTS
    # -------------------------------------------------------------------------

    - name: Ensure remote charts directory exists
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    # olm-v0 chart (includes crds/ subdirectory)
    - name: Remove old olm-v0 chart from remote server
      file:
        path: "{{ remote_charts_dir }}/olm-v0"
        state: absent

    - name: Copy olm-v0 chart to remote server
      copy:
        src: "{{ playbook_dir }}/charts/olm-v0/"
        dest: "{{ remote_charts_dir }}/olm-v0/"
        mode: "0644"

    # -------------------------------------------------------------------------
    # INSTALL OLM CRDs FIRST
    # -------------------------------------------------------------------------

    - name: Install olm-v0 CRDs via kubectl
      command: kubectl create -f {{ remote_charts_dir }}/olm-v0/crds/crds.yaml
      failed_when: false

    - name: Wait for OLM CRDs to be established
      command: >
        kubectl wait --for=condition=Established
        crd/catalogsources.operators.coreos.com
        crd/clusterserviceversions.operators.coreos.com
        crd/installplans.operators.coreos.com
        crd/olmconfigs.operators.coreos.com
        crd/operatorconditions.operators.coreos.com
        crd/operatorgroups.operators.coreos.com
        crd/operators.operators.coreos.com
        crd/subscriptions.operators.coreos.com
        --timeout=60s
      changed_when: false

    # -------------------------------------------------------------------------
    # CREATE OLM NAMESPACES
    # -------------------------------------------------------------------------

    - name: Apply OLM namespaces (olm + operators)
      command: kubectl apply -f {{ remote_charts_dir }}/olm-v0/namespaces.yaml

    # -------------------------------------------------------------------------
    # CREATE VALUES FILE
    # -------------------------------------------------------------------------

    - name: Create olm-v0 values file
      copy:
        dest: "{{ remote_charts_dir }}/olm-v0/values-override.yaml"
        mode: "0644"
        content: |
          replicas: 1

    # -------------------------------------------------------------------------
    # INSTALL OR UPGRADE OLM
    # -------------------------------------------------------------------------

    - name: Install or upgrade olm-v0 via Helm
      command: >
        helm upgrade --install olm-v0 {{ remote_charts_dir }}/olm-v0
        --namespace {{ olm_namespace }}
        --values {{ remote_charts_dir }}/olm-v0/values-override.yaml
        --skip-crds
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ olm_helm_timeout }}

    # -------------------------------------------------------------------------
    # VERIFY INSTALLATION
    # -------------------------------------------------------------------------

    - name: Wait for OLM Operator to be ready
      command: kubectl rollout status deployment/olm-operator -n {{ olm_namespace }} --timeout=300s

    - name: Wait for Catalog Operator to be ready
      command: kubectl rollout status deployment/catalog-operator -n {{ olm_namespace }} --timeout=300s

    - name: Wait for PackageServer CSV to succeed
      command: >
        kubectl wait --for=jsonpath='{.status.phase}'=Succeeded
        csv/packageserver -n {{ olm_namespace }}
        --timeout=300s
      register: packageserver_wait
      retries: 3
      delay: 10
      until: packageserver_wait.rc == 0

    - name: Verify OLM installation
      command: helm list -n {{ olm_namespace }}
      register: helm_verify
      changed_when: false

    - name: Show OLM Helm release
      debug:
        var: helm_verify.stdout_lines
