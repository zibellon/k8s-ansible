# =============================================================================
# Install HashiCorp Vault
# - pre: NetworkPolicies
# - install: Official Helm chart (hashicorp/vault)
# - post: Ingress
# - install-self-eso: ESO integration for self credentials
# =============================================================================

---
- name: Install Vault via Helm
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # STEP 0: FIND MASTER SECRET IN vault_eso.secrets
    # =========================================================================

    - name: "[vault] Find master secret in vault_eso.secrets"
      set_fact:
        vault_master_secret: "{{ vault_eso.secrets | selectattr('is_master', 'defined') | selectattr('is_master', 'equalto', true) | first }}"

    - name: "[vault] Fail if no master secret found"
      fail:
        msg: "No master secret found in vault_eso.secrets (is_master: true required)"
      when: vault_master_secret is not defined

    # =========================================================================
    # STEP 1: INSTALL PRE (NetworkPolicies)
    # =========================================================================

    - name: "[vault-pre] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/vault/pre"
        state: directory
        mode: "0755"

    - name: "[vault-pre] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        chart_name: "pre"
        chart_local_src: "{{ playbook_dir }}/charts/vault/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/vault/pre"

    - name: "[vault-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/vault/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ vault_namespace }}
          traefik:
            namespace: {{ traefik_namespace }}
          externalSecrets:
            namespace: {{ external_secrets_namespace }}

    - name: "[vault-pre] Install via Helm"
      command: >
        helm upgrade --install vault-pre {{ remote_charts_dir }}/vault/pre
        --namespace {{ vault_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/vault/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ vault_config_helm_timeout }}

    # =========================================================================
    # STEP 2: INSTALL VAULT (Local Helm Chart)
    # =========================================================================

    - name: "[vault] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        chart_name: "install"
        chart_local_src: "{{ playbook_dir }}/charts/vault/install/"
        chart_remote_dest: "{{ remote_charts_dir }}/vault/install"

    - name: "[vault] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/vault/install/values-override.yaml"
        mode: "0644"
        content: |
          global:
            enabled: true

          server:
            enabled: true
            image:
              repository: hashicorp/vault
              tag: {{ vault_image_tag }}

            standalone:
              enabled: true
              config: |
                ui = true
                listener "tcp" {
                  tls_disable = 1
                  address = "[::]:8200"
                  cluster_address = "[::]:8201"
                }
                storage "raft" {
                  path = "/vault/data"
                }

            dataStorage:
              enabled: true
              size: {{ vault_storage_size }}
              storageClass: {{ vault_storage_class }}

            resources: {}
            nodeSelector: {}
            affinity: ""

          ui:
            enabled: true
            serviceType: ClusterIP

          injector:
            enabled: false

    - name: "[vault] Install via Helm"
      command: >
        helm upgrade --install vault {{ remote_charts_dir }}/vault/install
        --namespace {{ vault_namespace }}
        --values {{ remote_charts_dir }}/vault/install/values.yaml
        --values {{ remote_charts_dir }}/vault/install/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ vault_helm_timeout }}

    # =========================================================================
    # STEP 4: WAIT FOR VAULT POD
    # =========================================================================

    - name: "[vault] Wait for pod to be Running"
      command: >
        kubectl wait --for=jsonpath='{.status.phase}'=Running
        pod/vault-0 -n {{ vault_namespace }}
        --timeout={{ vault_rollout_timeout }}

    # =========================================================================
    # STEP 5: CHECK IF VAULT IS INITIALIZED
    # =========================================================================

    - name: "[vault] Get Vault status"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault status -format=json 2>&1 || true
      register: vault_status_raw
      changed_when: false

    - name: "[vault] Parse initialization status"
      set_fact:
        vault_is_initialized: "{{ (vault_status_raw.stdout | from_json).initialized | default(false) | bool }}"
      failed_when: false
      ignore_errors: true

    - name: "[vault] Set default if parse failed"
      set_fact:
        vault_is_initialized: false
      when: vault_is_initialized is not defined

    - name: "[vault] Show initialization status"
      debug:
        msg: "Vault initialized: {{ vault_is_initialized }}"

    # =========================================================================
    # STEP 5.1: CHECK SEAL STATUS (if already initialized)
    # =========================================================================

    - name: "[vault] Check seal status"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault status -format=json | jq -r '.sealed'
      register: vault_sealed_check
      when: vault_is_initialized | bool
      changed_when: false

    - name: "[vault] Show seal status (already initialized)"
      debug:
        msg: "Vault sealed: {{ vault_sealed_check.stdout | default('unknown') }}"
      when: vault_is_initialized | bool

    # =========================================================================
    # STEP 5.2: GET CREDENTIALS FROM K8S SECRET (if sealed)
    # =========================================================================

    - name: "[vault] Get credentials from K8s Secret"
      shell: |
        kubectl get secret {{ vault_master_secret.target_secret }} -n {{ vault_namespace }} -o jsonpath='{.data}'
      register: k8s_secret_data
      when: vault_sealed_check.stdout | default('false') == 'true'
      failed_when: false

    - name: "[vault] Fail if no credentials available for unseal"
      fail:
        msg: "Vault is initialized and sealed, but no credentials found in K8s Secret '{{ vault_master_secret.target_secret }}'. Cannot unseal."
      when:
        - vault_sealed_check.stdout | default('false') == 'true'
        - k8s_secret_data.stdout | default('') == '' or k8s_secret_data.rc != 0

    - name: "[vault] Parse credentials from K8s Secret"
      set_fact:
        vault_unseal_keys:
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_1 | b64decode }}"
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_2 | b64decode }}"
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_3 | b64decode }}"
        vault_root_token: "{{ (k8s_secret_data.stdout | from_json).root_token | b64decode }}"
      when:
        - vault_sealed_check.stdout | default('false') == 'true'
        - k8s_secret_data.rc == 0

    - name: "[vault] Unseal Vault with recovered keys"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault operator unseal {{ key }}
      loop: "{{ vault_unseal_keys[:vault_key_threshold | int] }}"
      loop_control:
        index_var: idx
        loop_var: key
        label: "Key {{ idx + 1 }}"
      when:
        - vault_sealed_check.stdout | default('false') == 'true'
        - vault_unseal_keys is defined

    # =========================================================================
    # STEP 5.3: GET ALL CREDENTIALS (if unsealed and already initialized)
    # =========================================================================

    # 1. First try K8s Secret (ESO synced) - get ALL data
    - name: "[vault] Get credentials from K8s Secret"
      shell: |
        kubectl get secret {{ vault_master_secret.target_secret }} -n {{ vault_namespace }} -o jsonpath='{.data}'
      register: k8s_secret_data
      when:
        - vault_is_initialized | bool
        - vault_sealed_check.stdout | default('true') == 'false'
      failed_when: false

    # Set ALL credentials from K8s Secret if found
    - name: "[vault] Set credentials from K8s Secret"
      set_fact:
        vault_root_token: "{{ (k8s_secret_data.stdout | from_json).root_token | b64decode }}"
        vault_unseal_keys:
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_1 | b64decode }}"
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_2 | b64decode }}"
          - "{{ (k8s_secret_data.stdout | from_json).unseal_key_3 | b64decode }}"
      when:
        - k8s_secret_data is defined
        - k8s_secret_data.rc | default(1) == 0
        - k8s_secret_data.stdout | default('') != ''
        - (k8s_secret_data.stdout | from_json).root_token is defined
        - (k8s_secret_data.stdout | from_json).unseal_key_1 is defined

    # Login with K8s Secret token
    - name: "[vault] Login with K8s Secret token"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault login {{ vault_root_token }}
      when:
        - vault_is_initialized | bool
        - vault_sealed_check.stdout | default('true') == 'false'
        - vault_root_token is defined

    # 2. If K8s Secret failed, try Vault session
    - name: "[vault] Check if authenticated (fallback)"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault token lookup
      register: vault_auth_check
      when:
        - vault_is_initialized | bool
        - vault_sealed_check.stdout | default('true') == 'false'
        - vault_root_token is not defined
      failed_when: false
      changed_when: false

    # If authenticated, try to read ALL credentials from Vault
    - name: "[vault] Read credentials from Vault (fallback)"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault kv get -format=json {{ vault_kv_mount_path }}/{{ vault_master_secret.vault_path }}
      register: vault_creds_read
      when:
        - vault_is_initialized | bool
        - vault_sealed_check.stdout | default('true') == 'false'
        - vault_root_token is not defined
        - vault_auth_check.rc | default(1) == 0
      failed_when: false
      changed_when: false

    # Set ALL credentials from Vault if found
    - name: "[vault] Set credentials from Vault"
      set_fact:
        vault_root_token: "{{ (vault_creds_read.stdout | from_json).data.data.root_token }}"
        vault_unseal_keys:
          - "{{ (vault_creds_read.stdout | from_json).data.data.unseal_key_1 }}"
          - "{{ (vault_creds_read.stdout | from_json).data.data.unseal_key_2 }}"
          - "{{ (vault_creds_read.stdout | from_json).data.data.unseal_key_3 }}"
      when:
        - vault_creds_read is defined
        - vault_creds_read.rc | default(1) == 0
        - vault_creds_read.stdout | default('') != ''

    # FAIL if no credentials found anywhere
    - name: "[vault] Fail if no credentials available"
      fail:
        msg: |
          Vault is initialized and unsealed, but no credentials found.
          Checked:
            1. K8s Secret '{{ vault_master_secret.target_secret }}': {{ 'found' if k8s_secret_data.rc | default(1) == 0 and k8s_secret_data.stdout | default('') != '' else 'not found' }}
            2. Vault session: {{ 'authenticated' if vault_auth_check.rc | default(1) == 0 else 'not authenticated' }}
            3. Vault storage: {{ 'found' if vault_creds_read.rc | default(1) == 0 else 'not found or not checked' }}

          BOTH root_token AND unseal_keys are REQUIRED.
          Without unseal_keys, Vault will be permanently locked after restart!
      when:
        - vault_is_initialized | bool
        - vault_sealed_check.stdout | default('true') == 'false'
        - vault_root_token is not defined

    # =========================================================================
    # STEP 6: INITIALIZE VAULT (if not initialized)
    # =========================================================================

    - name: "[vault] Initialize Vault"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault operator init \
          -key-shares={{ vault_key_shares }} \
          -key-threshold={{ vault_key_threshold }} \
          -format=json
      register: vault_init_result
      when: not (vault_is_initialized | bool)

    - name: "[vault] Parse init result"
      set_fact:
        vault_unseal_keys: "{{ (vault_init_result.stdout | from_json).unseal_keys_b64 }}"
        vault_root_token: "{{ (vault_init_result.stdout | from_json).root_token }}"
      when: vault_init_result is not skipped and vault_init_result.stdout is defined

    - name: "[vault] Show initialization header"
      debug:
        msg:
          - "=============================================="
          - "VAULT INITIALIZATION RESULT"
          - "=============================================="
      when: vault_unseal_keys is defined

    - name: "[vault] Show unseal keys"
      debug:
        msg: "Unseal Key {{ idx + 1 }}: {{ key }}"
      loop: "{{ vault_unseal_keys }}"
      loop_control:
        index_var: idx
        loop_var: key
      when: vault_unseal_keys is defined

    - name: "[vault] Show root token and footer"
      debug:
        msg:
          - "Root Token: {{ vault_root_token }}"
          - "=============================================="
          - "IMPORTANT: Save these credentials securely!"
          - "=============================================="
      when: vault_root_token is defined

    # =========================================================================
    # STEP 7: UNSEAL VAULT (if just initialized)
    # =========================================================================

    - name: "[vault] Unseal Vault ({{ vault_key_threshold }} keys required)"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault operator unseal {{ key }}
      loop: "{{ vault_unseal_keys[:vault_key_threshold | int] }}"
      loop_control:
        index_var: idx
        loop_var: key
        label: "Key {{ idx + 1 }}"
      when: vault_init_result is not skipped

    - name: "[vault] Verify Vault is unsealed"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault status -format=json | jq -r '.sealed'
      register: vault_sealed_status
      changed_when: false

    - name: "[vault] Show seal status"
      debug:
        msg: "Vault sealed: {{ vault_sealed_status.stdout }}"

    # =========================================================================
    # STEP 8: CONFIGURE KUBERNETES AUTH (if just initialized)
    # =========================================================================

    - name: "[vault] Login with root token"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault login {{ vault_root_token }}
      when: vault_root_token is defined

    - name: "[vault] Enable Kubernetes auth method"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault auth enable kubernetes
      register: k8s_auth_result
      failed_when: false
      when: vault_init_result is not skipped

    - name: "[vault] Configure Kubernetes auth"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault write auth/kubernetes/config
        kubernetes_host="{{ vault_kubernetes_host }}"
      when: vault_init_result is not skipped

    # =========================================================================
    # STEP 9: ENABLE KV SECRETS ENGINE (if just initialized)
    # =========================================================================

    - name: "[vault] Enable KV secrets engine"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault secrets enable -path={{ vault_kv_mount_path }} kv-v2
      register: kv_enable_result
      failed_when: false
      when: vault_init_result is not skipped

    # =========================================================================
    # STEP 10: SAVE VAULT CREDENTIALS TO VAULT (if just initialized)
    # =========================================================================

    - name: "[vault] Save credentials to Vault"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault kv put {{ vault_kv_mount_path }}/{{ vault_master_secret.vault_path }} \
          {% for idx in range(vault_unseal_keys | length) %}
          unseal_key_{{ idx + 1 }}="{{ vault_unseal_keys[idx] }}" \
          {% endfor %}
          root_token="{{ vault_root_token }}"
      when: vault_init_result is not skipped

    # =========================================================================
    # STEP 11: SYNC VAULT POLICIES AND ROLES (only when unsealed)
    # =========================================================================

    - name: "[vault-sync] Sync policies and roles from hosts.yaml"
      include_tasks: tasks/tasks-vault-sync.yaml
      when: vault_sealed_status.stdout | default('true') == 'false'

    # =========================================================================
    # STEP 12: INSTALL POST (Ingress + ESO)
    # =========================================================================

    - name: "[vault-post] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/vault/post"
        state: directory
        mode: "0755"

    - name: "[vault-post] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        chart_name: "post"
        chart_local_src: "{{ playbook_dir }}/charts/vault/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/vault/post"

    - name: "[vault-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/vault/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ vault_namespace }}
          clusterDomain: {{ dns_domain }}
          vault:
            kvMountPath: {{ vault_kv_mount_path }}
          ingress:
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            domain: {{ vault_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            secretName: {{ vault_https_secret_name }}
            vpnOnlyEnabled: {{ vault_vpn_only_enabled }}
          traefik:
            namespace: {{ traefik_namespace }}
          eso:
            saName: {{ vault_eso.sa_name }}
            roleName: {{ vault_eso.role_name }}
            secretStoreName: {{ vault_eso.secret_store_name }}
            secrets: {{ vault_eso.secrets | to_json }}
          autoUnseal:
            schedule: "{{ vault_auto_unseal_schedule }}"
            keyThreshold: {{ vault_key_threshold }}
            secretName: {{ vault_master_secret.target_secret }}

    - name: "[vault-post] Install via Helm"
      command: >
        helm upgrade --install vault-post {{ remote_charts_dir }}/vault/post
        --namespace {{ vault_namespace }}
        --values {{ remote_charts_dir }}/vault/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ vault_config_helm_timeout }}

    # =========================================================================
    # STEP 13: VERIFY AND OUTPUT CREDENTIALS
    # =========================================================================

    - name: "[verify] Check Helm releases"
      command: helm list -n {{ vault_namespace }}
      register: helm_verify
      changed_when: false

    - name: "[verify] Show Helm releases"
      debug:
        var: helm_verify.stdout_lines

    - name: "[credentials] Show credentials header"
      debug:
        msg:
          - "=============================================="
          - "VAULT CREDENTIALS"
          - "=============================================="

    - name: "[credentials] Show unseal keys"
      debug:
        msg: "Unseal Key {{ idx + 1 }}: {{ key }}"
      loop: "{{ vault_unseal_keys | default([]) }}"
      loop_control:
        index_var: idx
        loop_var: key
      when: vault_unseal_keys is defined

    - name: "[credentials] Show unseal keys (already initialized)"
      debug:
        msg: "Unseal Keys: (already initialized - check Vault or K8s Secret)"
      when: vault_unseal_keys is not defined

    - name: "[credentials] Show remaining info"
      debug:
        msg:
          - "Root Token: {{ vault_root_token | default('(already initialized)') }}"
          - ""
          - "Credentials stored in Vault:"
          - "  Path: {{ vault_kv_mount_path }}/{{ vault_master_secret.vault_path }}"
          - ""
          - "Credentials synced to K8s Secret (via ESO):"
          - "  Secret: {{ vault_master_secret.target_secret }}"
          - "  Namespace: {{ vault_namespace }}"
          - ""
          - "Vault UI: https://{{ vault_domain }}"
          - "VPN-only: {{ vault_vpn_only_enabled }}"
          - "=============================================="

    - name: "[verify] Confirm installation"
      debug:
        msg: "Vault installation: OK"
