# =============================================================================
# LONGHORN NETWORK POLICIES (SIMPLIFIED)
# =============================================================================
# Based on official Longhorn Helm chart policies + custom rules for Traefik/ACME
# =============================================================================

---
# Default deny all traffic in longhorn-system namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# DNS for all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# =============================================================================
# GENERAL EGRESS FOR ALL LONGHORN COMPONENTS
# =============================================================================

---
# Allow egress for all Longhorn components
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-egress
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: longhorn
  policyTypes:
    - Egress
  egress:
    # Internal namespace communication
    - to:
        - podSelector: {}
    # API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # Kubelet (hostNetwork)
    - ports:
        - protocol: TCP
          port: 10250
    # S3 backup (HTTPS)
    - ports:
        - protocol: TCP
          port: 443

# =============================================================================
# OFFICIAL LONGHORN INGRESS POLICIES (from Helm chart)
# =============================================================================

---
# Backing Image Data Source
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backing-image-data-source
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/component: backing-image-data-source
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-data-source

---
# Backing Image Manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backing-image-manager
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/component: backing-image-manager
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-data-source

---
# Instance Manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: instance-manager
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/component: instance-manager
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-manager
        - podSelector:
            matchLabels:
              longhorn.io/component: backing-image-data-source

---
# Longhorn Manager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: longhorn-manager
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-manager
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-manager
        - podSelector:
            matchLabels:
              app: longhorn-ui
        - podSelector:
            matchLabels:
              app: longhorn-csi-plugin
        - podSelector:
            matchLabels:
              longhorn.io/managed-by: longhorn-manager
            matchExpressions:
              - key: recurring-job.longhorn.io
                operator: Exists
        - podSelector:
            matchExpressions:
              - key: longhorn.io/job-task
                operator: Exists
        - podSelector:
            matchLabels:
              app: longhorn-driver-deployer

---
# Longhorn Recovery Backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: longhorn-recovery-backend
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/recovery-backend: longhorn-recovery-backend
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 9503

---
# Longhorn Admission Webhook
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: longhorn-admission-webhook
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/admission-webhook: longhorn-admission-webhook
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 9502

# =============================================================================
# CUSTOM: LONGHORN UI (Traefik access)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-ui
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-ui
  policyTypes:
    - Ingress
  ingress:
    # From Traefik only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.traefik.namespace }}
          podSelector:
            matchLabels:
              app-key: traefik
              app-env: prod
      ports:
        - protocol: TCP
          port: 8000

# =============================================================================
# CUSTOM: ACME SOLVER (cert-manager HTTP-01 challenge)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-acme-solver
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app-key: acme-solver-traefik-master
      app-env: prod
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.traefik.namespace }}
          podSelector:
            matchLabels:
              app-key: traefik
              app-env: prod
      ports:
        - protocol: TCP
          port: 8089

# =============================================================================
# CUSTOM: TRAEFIK EGRESS TO LONGHORN (in traefik namespace)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ns-longhorn-system-allow-traefik
  namespace: {{ .Values.traefik.namespace }}
spec:
  podSelector:
    matchLabels:
      app-key: traefik
      app-env: prod
  policyTypes:
    - Egress
  egress:
    # To longhorn-ui
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.namespace }}
          podSelector:
            matchLabels:
              app: longhorn-ui
      ports:
        - protocol: TCP
          port: 8000
    # ACME solver in longhorn-system
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.namespace }}
          podSelector:
            matchLabels:
              app-key: acme-solver-traefik-master
              app-env: prod
      ports:
        - protocol: TCP
          port: 8089
