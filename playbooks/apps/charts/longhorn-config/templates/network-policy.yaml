# =============================================================================
# LONGHORN HARDENED NETWORK POLICIES
# =============================================================================
# Complete NetworkPolicy set for longhorn-system namespace
# Replaces the broad "allow-longhorn-internal" policy with strict per-component rules
# =============================================================================

---
# Default deny all traffic in longhorn-system namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# DNS for all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-egress
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

# =============================================================================
# LONGHORN MANAGER (DaemonSet)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-manager
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-manager
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # From longhorn-ui → manager API
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-ui
      ports:
        - protocol: TCP
          port: 9500
    # From CSI controllers → manager API
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - csi-attacher
                  - csi-provisioner
                  - csi-resizer
                  - csi-snapshotter
                  - longhorn-csi-plugin
      ports:
        - protocol: TCP
          port: 9500
    # From recurring jobs → manager API
    - from:
        - podSelector:
            matchExpressions:
              - key: recurring-job.longhorn.io
                operator: Exists
      ports:
        - protocol: TCP
          port: 9500
    # From instance-manager → gRPC callbacks
    - from:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To S3 for backups
    - ports:
        - protocol: TCP
          port: 443
    # To instance-manager → gRPC control
    - to:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager

---
# Admission webhook ingress from API server (hostNetwork - no selector)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-webhook
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-manager
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 9502
        - protocol: TCP
          port: 9503

# =============================================================================
# LONGHORN UI
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-ui
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-ui
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # From Traefik only
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.traefik.namespace }}
          podSelector:
            matchLabels:
              app-key: traefik
              app-env: prod
      ports:
        - protocol: TCP
          port: 8000
  egress:
    # To longhorn-manager API only
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# LONGHORN DRIVER DEPLOYER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-driver-deployer
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-driver-deployer
  policyTypes:
    - Egress
  egress:
    # To API server only (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443

# =============================================================================
# INSTANCE MANAGER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-instance-manager
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      longhorn.io/component: instance-manager
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # From longhorn-manager → gRPC control
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-manager
    # From other instance-managers → replica sync
    - from:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
    # From longhorn-csi-plugin → data path
    - from:
        - podSelector:
            matchLabels:
              app: longhorn-csi-plugin
    # From recurring jobs → snapshot/backup operations
    - from:
        - podSelector:
            matchExpressions:
              - key: recurring-job.longhorn.io
                operator: Exists
  egress:
    # To longhorn-manager → callbacks
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
    # To other instance-managers → replica sync
    - to:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager

# =============================================================================
# CSI ATTACHER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-csi-attacher
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: csi-attacher
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager API
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# CSI PROVISIONER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-csi-provisioner
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: csi-provisioner
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager API
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# CSI RESIZER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-csi-resizer
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: csi-resizer
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager API
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# CSI SNAPSHOTTER
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-csi-snapshotter
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: csi-snapshotter
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager API
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# CSI PLUGIN (DaemonSet)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-csi-plugin
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app: longhorn-csi-plugin
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To kubelet for volume mount (hostNetwork)
    - ports:
        - protocol: TCP
          port: 10250
    # To instance-manager → data path
    - to:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
    # To longhorn-manager → volume operations
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# RECURRING JOBS (backup, snapshot, trim, etc.)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-recurring-jobs
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchExpressions:
      - key: recurring-job.longhorn.io
        operator: Exists
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500
    # To instance-manager for snapshot/backup
    - to:
        - podSelector:
            matchLabels:
              longhorn.io/component: instance-manager
    # To S3 for backup
    - ports:
        - protocol: TCP
          port: 443

# =============================================================================
# HELM UPGRADE HOOKS (pre-upgrade, post-upgrade jobs)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-longhorn-upgrade-jobs
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: longhorn
  policyTypes:
    - Egress
  egress:
    # To API server (hostNetwork)
    - ports:
        - protocol: TCP
          port: 6443
    # To longhorn-manager API
    - to:
        - podSelector:
            matchLabels:
              app: longhorn-manager
      ports:
        - protocol: TCP
          port: 9500

# =============================================================================
# ACME SOLVER (cert-manager HTTP-01 challenge)
# =============================================================================

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-acme-solver
  namespace: {{ .Values.namespace }}
spec:
  podSelector:
    matchLabels:
      app-key: acme-solver-traefik-master
      app-env: prod
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.traefik.namespace }}
          podSelector:
            matchLabels:
              app-key: traefik
              app-env: prod
      ports:
        - protocol: TCP
          port: 8089

# -----------------------------------------------------------------------------
# LONGHORN UI
# -----------------------------------------------------------------------------

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ns-longhorn-system-allow-traefik
  namespace: {{ .Values.traefik.namespace }}
spec:
  podSelector:
    matchLabels:
      app-key: traefik
      app-env: prod
  policyTypes:
    - Egress
  egress:
    # To longhorn-ui
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.namespace }}
          podSelector:
            matchLabels:
              app: longhorn-ui
      ports:
        - protocol: TCP
          port: 8000
    # ACME solver in longhorn-system
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.namespace }}
          podSelector:
            matchLabels:
              app-key: acme-solver-traefik-master
              app-env: prod
      ports:
        - protocol: TCP
          port: 8089
