# =============================================================================
# CRONJOB FOR VAULT AUTO-UNSEAL
# Periodically checks if Vault is sealed and unseals it using keys from host file
# Runs ONLY on control-plane nodes where credentials file is stored
# =============================================================================

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-auto-unseal
  namespace: {{ .Values.namespace }}
spec:
  schedule: {{ .Values.autoUnseal.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app.kubernetes.io/name: vault-auto-unseal
            app.kubernetes.io/instance: vault-post
            app.kubernetes.io/component: auto-unseal
        spec:
          serviceAccountName: vault-auto-unseal
          restartPolicy: Never
          # Run ONLY on control-plane nodes
          nodeSelector:
            node-role.kubernetes.io/control-plane: ""
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
          containers:
            - name: unseal
              image: {{ .Values.autoUnseal.image }}
              command:
                - /bin/sh
                - -c
                - |
                  #!/bin/sh
                  set -e

                  VAULT_POD="vault-0"
                  NAMESPACE="{{ .Values.namespace }}"
                  THRESHOLD="{{ .Values.autoUnseal.keyThreshold }}"
                  CREDS_FILE="/vault-creds/{{ .Values.autoUnseal.credsHostPath | base }}"

                  echo "Checking Vault seal status..."

                  # Check if Vault pod is running
                  if ! kubectl get pod $VAULT_POD -n $NAMESPACE >/dev/null 2>&1; then
                    echo "Vault pod $VAULT_POD not found, skipping"
                    exit 0
                  fi

                  # Get seal status
                  SEALED=$(kubectl exec $VAULT_POD -n $NAMESPACE -- vault status -format=json 2>/dev/null | jq -r '.sealed' || echo "unknown")

                  if [ "$SEALED" = "true" ]; then
                    echo "Vault is SEALED, starting unseal process..."
                    
                    # Check if credentials file exists
                    if [ ! -f "$CREDS_FILE" ]; then
                      echo "ERROR: Credentials file $CREDS_FILE not found!"
                      exit 1
                    fi

                    # Read unseal keys from JSON file and unseal
                    for i in $(seq 0 $((THRESHOLD - 1))); do
                      KEY=$(jq -r ".unseal_keys[$i]" "$CREDS_FILE")
                      if [ -n "$KEY" ] && [ "$KEY" != "null" ]; then
                        echo "Applying unseal key $((i + 1))..."
                        kubectl exec $VAULT_POD -n $NAMESPACE -- vault operator unseal "$KEY"
                      else
                        echo "Warning: Unseal key $((i + 1)) not found in credentials file"
                      fi
                    done
                    
                    # Verify unseal
                    SEALED_AFTER=$(kubectl exec $VAULT_POD -n $NAMESPACE -- vault status -format=json 2>/dev/null | jq -r '.sealed' || echo "unknown")
                    if [ "$SEALED_AFTER" = "false" ]; then
                      echo "Vault successfully UNSEALED"
                    else
                      echo "Warning: Vault may still be sealed (status: $SEALED_AFTER)"
                    fi
                  elif [ "$SEALED" = "false" ]; then
                    echo "Vault is already UNSEALED, nothing to do"
                  else
                    echo "Could not determine Vault seal status: $SEALED"
                  fi
              volumeMounts:
                - name: vault-creds
                  mountPath: /vault-creds
                  readOnly: true
          volumes:
            - name: vault-creds
              hostPath:
                path: {{ .Values.autoUnseal.credsHostPath | dir }}
                type: Directory
