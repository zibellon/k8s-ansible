# =============================================================================
# Install HAProxy via Helm
# Steps:
#   1. haproxy/pre: NetworkPolicies for haproxy namespace
#   2. Official haproxytech/kubernetes-ingress chart
#   3. haproxy/post: Global + Defaults configuration
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/haproxy-install.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Installing HAProxy on master manager: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Install HAProxy via Helm
# =============================================================================
- name: Install HAProxy via Helm
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # STEP 1: HAPROXY/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[haproxy-pre] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[haproxy-pre] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/haproxy/pre"
        state: absent

    - name: "[haproxy-pre] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/haproxy/pre/"
        dest: "{{ remote_charts_dir }}/haproxy/pre/"
        mode: "0644"

    - name: "[haproxy-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ haproxy_namespace }}

    - name: "[haproxy-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install haproxy-pre {{ remote_charts_dir }}/haproxy/pre
        --namespace {{ haproxy_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/haproxy/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_helm_timeout }}

    # =========================================================================
    # STEP 2: OFFICIAL HAPROXYTECH/KUBERNETES-INGRESS
    # =========================================================================

    - name: "[haproxy-install] Add haproxy Helm repository"
      command: helm repo add haproxytech https://haproxytech.github.io/helm-charts --force-update

    - name: "[haproxy-install] Update Helm repositories"
      command: helm repo update

    - name: "[haproxy-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/values-override.yaml"
        mode: "0644"
        content: |
          fullnameOverride: {{ haproxy_daemonset_name }}
          controller:
            kind: DaemonSet
            ingressClassResource:
              name: {{ haproxy_ingress_class }}
            ingressClass: {{ haproxy_ingress_class }}
            podLabels:
              app-key: haproxy
              app-env: prod
            defaultTLSSecret:
              enabled: false
            logging:
              level: info
              traffic:
                address: stdout
                format: raw
                facility: daemon
            service:
              enabled: true
              type: ClusterIP
              enablePorts:
                http: false
                https: false
                quic: false
          serviceAccount:
            create: true

    - name: "[haproxy-install] Install or upgrade HAProxy via Helm"
      command: >
        helm upgrade --install haproxy-ingress haproxytech/kubernetes-ingress
        --namespace {{ haproxy_namespace }}
        --version {{ haproxy_chart_version }}
        --values {{ remote_charts_dir }}/haproxy/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_helm_timeout }}

    - name: "[haproxy-install] Wait for HAProxy CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/backends.ingress.v1.haproxy.org
        crd/defaults.ingress.v1.haproxy.org
        crd/globals.ingress.v1.haproxy.org
        crd/tcps.ingress.v1.haproxy.org
        --timeout={{ haproxy_crds_timeout }}
      changed_when: false

    - name: "[haproxy-install] Wait for DaemonSet to be ready"
      command: kubectl rollout status daemonset/{{ haproxy_daemonset_name }} -n {{ haproxy_namespace }} --timeout={{ haproxy_rollout_timeout }}

    # =========================================================================
    # STEP 3: HAPROXY/POST (Global + Defaults config)
    # =========================================================================

    - name: "[haproxy-post] Remove old chart from remote server"
      file:
        path: "{{ remote_charts_dir }}/haproxy/post"
        state: absent

    - name: "[haproxy-post] Copy chart to server"
      copy:
        src: "{{ playbook_dir }}/charts/haproxy/post/"
        dest: "{{ remote_charts_dir }}/haproxy/post/"
        mode: "0644"

    - name: "[haproxy-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ haproxy_namespace }}
          ingressClass: {{ haproxy_ingress_class }}

    - name: "[haproxy-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install haproxy-post {{ remote_charts_dir }}/haproxy/post
        --namespace {{ haproxy_namespace }}
        --values {{ remote_charts_dir }}/haproxy/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_config_helm_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: Get HAProxy Helm releases
      command: helm list -n {{ haproxy_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Installation complete
      debug:
        msg: "haproxy-pre + haproxy-ingress + haproxy-post: OK"
