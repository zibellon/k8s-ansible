# =============================================================================
# Install Longhorn via Helm
# Steps:
#   1. longhorn/pre: NetworkPolicies for longhorn namespace
#   2. Official longhorn/longhorn chart
#   3. longhorn/post: StorageClasses, Ingress, S3 Backup Secret
# =============================================================================

---
- name: Install Longhorn via Helm
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # STEP 1: LONGHORN/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[longhorn-pre] Ensure remote charts directory exists"
      file:
        path: "{{ remote_charts_dir }}"
        state: directory
        mode: "0755"

    - name: "[longhorn-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        chart_name: "pre"
        chart_local_src: "{{ playbook_dir }}/charts/longhorn/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/longhorn/pre"

    - name: "[longhorn-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/longhorn/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ longhorn_namespace }}
          traefik:
            namespace: {{ traefik_namespace }}

    - name: "[longhorn-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install longhorn-pre {{ remote_charts_dir }}/longhorn/pre
        --namespace {{ longhorn_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/longhorn/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ longhorn_helm_timeout }}

    # =========================================================================
    # STEP 2: OFFICIAL LONGHORN/LONGHORN
    # =========================================================================

    - name: "[longhorn-install] Add Longhorn Helm repository"
      command: helm repo add longhorn https://charts.longhorn.io --force-update

    - name: "[longhorn-install] Update Helm repositories"
      command: helm repo update

    - name: "[longhorn-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/longhorn/values-override.yaml"
        mode: "0644"
        content: |
          # Custom default settings
          defaultSettings:
            defaultDataLocality: "best-effort"
            defaultReplicaCount: 2
            defaultLonghornStaticStorageClass: "longhorn-static"
            disableRevisionCounter: '{"v1":"true"}'
            allowCollectingLonghornUsageMetrics: false
            systemManagedPodsImagePullPolicy: "IfNotPresent"
            snapshotDataIntegrity: "enabled"
            backupExecutionTimeout: 15
            backupCompressionMethod: "gzip"
            storageMinimalAvailablePercentage: 5
            storageReservedPercentageForDefaultDisk: 5
            priorityClass: "longhorn-critical"
            disableSchedulingOnCordonedNode: true
            replicaAutoBalance: "best-effort"
            removeSnapshotsDuringFilesystemTrim: true
            nodeDownPodDeletionPolicy: "do-nothing"
            nodeDrainPolicy: "block-for-eviction"
          # StorageClass settings
          persistence:
            defaultClassReplicaCount: 2
          longhornUI:
            replicas: 1
            affinity: {}

    - name: "[longhorn-install] Install or upgrade Longhorn via Helm"
      command: >
        helm upgrade --install longhorn longhorn/longhorn
        --namespace {{ longhorn_namespace }}
        --version {{ longhorn_chart_version }}
        --values {{ remote_charts_dir }}/longhorn/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ longhorn_helm_timeout }}

    - name: "[longhorn-install] Wait for Longhorn CRDs to be established"
      command: >
        kubectl wait --for=condition=Established
        crd/backingimagedatasources.longhorn.io
        crd/backingimagemanagers.longhorn.io
        crd/backingimages.longhorn.io
        crd/backupbackingimages.longhorn.io
        crd/backups.longhorn.io
        crd/backuptargets.longhorn.io
        crd/backupvolumes.longhorn.io
        crd/engineimages.longhorn.io
        crd/engines.longhorn.io
        crd/instancemanagers.longhorn.io
        crd/nodes.longhorn.io
        crd/orphans.longhorn.io
        crd/recurringjobs.longhorn.io
        crd/replicas.longhorn.io
        crd/settings.longhorn.io
        crd/sharemanagers.longhorn.io
        crd/snapshots.longhorn.io
        crd/supportbundles.longhorn.io
        crd/systembackups.longhorn.io
        crd/systemrestores.longhorn.io
        crd/volumeattachments.longhorn.io
        crd/volumes.longhorn.io
        --timeout={{ crds_wait.timeout }}
      register: longhorn_crds_wait
      until: longhorn_crds_wait.rc == 0
      retries: "{{ crds_wait.retries }}"
      delay: "{{ crds_wait.delay }}"
      changed_when: false

    - name: "[longhorn-install] Wait for Longhorn manager DaemonSet to be ready"
      command: kubectl rollout status daemonset/longhorn-manager -n {{ longhorn_namespace }} --timeout={{ longhorn_manager_rollout_timeout }}

    - name: "[longhorn-install] Wait for Longhorn UI deployment to be ready"
      command: kubectl rollout status deployment/longhorn-ui -n {{ longhorn_namespace }} --timeout={{ longhorn_ui_rollout_timeout }}

    # =========================================================================
    # STEP 3: LONGHORN/POST (StorageClasses + Ingress + S3)
    # =========================================================================

    - name: "[longhorn-post] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        chart_name: "post"
        chart_local_src: "{{ playbook_dir }}/charts/longhorn/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/longhorn/post"

    - name: "[longhorn-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/longhorn/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ longhorn_namespace }}
          clusterDomain: {{ dns_domain }}
          ingress:
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            domain: {{ longhorn_ui_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            secretName: {{ longhorn_ui_https_secret_name }}
            vpnOnlyEnabled: {{ longhorn_ui_vpn_only_enabled }}
          traefik:
            namespace: {{ traefik_namespace }}
          vault:
            namespace: {{ vault_namespace }}
          eso:
            saName: {{ longhorn_eso.sa_name }}
            roleName: {{ longhorn_eso.role_name }}
            secretStoreName: {{ longhorn_eso.secret_store_name }}
            kvEnginePath: {{ longhorn_eso.kv_engine_path }}
            secrets: {{ longhorn_eso.secrets | to_json }}
          azList: {{ longhorn_az_list | to_json }}

    - name: "[longhorn-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install longhorn-post {{ remote_charts_dir }}/longhorn/post
        --namespace {{ longhorn_namespace }}
        --values {{ remote_charts_dir }}/longhorn/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ longhorn_config_helm_timeout }}

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: Get Longhorn Helm releases
      command: helm list -n {{ longhorn_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Show Longhorn access info
      debug:
        msg:
          - "Longhorn UI: https://{{ longhorn_ui_domain }}"
          - "Longhorn UI VPN-only: {{ longhorn_ui_vpn_only_enabled }}"

    - name: Installation complete
      debug:
        msg: "longhorn-pre + longhorn + longhorn-post: OK"
