# =============================================================================
# Bootstrap Infisical instance
# Creates admin user, organization, and returns machine identity token
# Run ONCE after infisical-install.yaml completes successfully
# =============================================================================

---
# =============================================================================
# Play 0: Pre-check - validate target is the master manager
# =============================================================================
- name: Pre-check - validate target
  hosts: all
  gather_facts: false

  tasks:
    - name: Fail if no limit specified
      fail:
        msg: "Usage: ansible-playbook -i hosts.yaml playbooks/apps/infisical-bootstrap.yaml --limit <master_manager>"
      when: ansible_limit is not defined
      run_once: true

    - name: Fail if not a manager node
      fail:
        msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
      when: inventory_hostname not in groups['managers']

    - name: Fail if not the master manager
      fail:
        msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
      when: not (is_master | default(false))

    - name: Confirm target
      debug:
        msg: "Bootstrapping Infisical on master manager: {{ inventory_hostname }}"

# =============================================================================
# Play 1: Bootstrap Infisical
# =============================================================================
- name: Bootstrap Infisical
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # STEP 1: GENERATE BOOTSTRAP PASSWORD
    # =========================================================================

    - name: "[bootstrap] Generate bootstrap password"
      command: openssl rand -base64 24
      register: bootstrap_password
      changed_when: false

    # =========================================================================
    # STEP 2: VERIFY INFISICAL IS RUNNING
    # =========================================================================

    - name: "[bootstrap] Verify Infisical deployment is ready"
      command: kubectl rollout status deployment/infisical -n {{ infisical_namespace }} --timeout=60s

    # =========================================================================
    # STEP 3: BOOTSTRAP VIA CLI INSIDE CONTAINER
    # =========================================================================

    - name: "[bootstrap] Execute bootstrap via CLI"
      shell: |
        kubectl exec -n {{ infisical_namespace }} deployment/infisical -- \
          infisical bootstrap \
          --domain="http://localhost:8080" \
          --email="{{ infisical_bootstrap_email }}" \
          --password="{{ bootstrap_password.stdout }}" \
          --organization="{{ infisical_bootstrap_organization }}"
      register: bootstrap_result
      failed_when: false

    # =========================================================================
    # STEP 4: OUTPUT RESULTS
    # =========================================================================

    - name: "[bootstrap] Show bootstrap result"
      debug:
        msg:
          - "=============================================="
          - "INFISICAL BOOTSTRAP RESULT"
          - "=============================================="
          - ""
          - "Bootstrap Email: {{ infisical_bootstrap_email }}"
          - "Bootstrap Password: {{ bootstrap_password.stdout }}"
          - "Organization: {{ infisical_bootstrap_organization }}"
          - ""
          - "Exit Code: {{ bootstrap_result.rc }}"
          - ""
          - "API Response:"
          - "{{ bootstrap_result.stdout | default('No stdout') }}"
          - ""
          - "Stderr (if any):"
          - "{{ bootstrap_result.stderr | default('No stderr') }}"
          - "=============================================="

    - name: "[bootstrap] Check if bootstrap was successful"
      debug:
        msg: "Bootstrap completed successfully!"
      when: bootstrap_result.rc == 0

    - name: "[bootstrap] Check if already bootstrapped"
      debug:
        msg: "Instance may already be bootstrapped (check response above)"
      when: bootstrap_result.rc != 0
