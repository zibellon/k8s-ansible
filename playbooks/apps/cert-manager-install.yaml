# =============================================================================
# Install cert-manager + cert-manager-config
# - cert-manager: official Helm chart from jetstack
# - cert-manager-config: local chart (NetworkPolicy + ClusterIssuer)
# =============================================================================

---
- name: Install cert-manager
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # PRE-CHECK
    # =========================================================================
    - name: Check if cert-manager is already installed
      command: helm list -n {{ cert_manager_namespace }} -q
      register: certmanager_pre_check
      changed_when: false
      failed_when: false

    - name: Set certmanager_installed fact
      set_fact:
        certmanager_installed: "{{ 'cert-manager' in certmanager_pre_check.stdout }}"

    - name: Show cert-manager status
      debug:
        msg: "cert-manager installed: {{ certmanager_installed }}"

    # =========================================================================
    # ADD HELM REPO
    # =========================================================================
    - name: Add Jetstack Helm repository
      command: helm repo add jetstack https://charts.jetstack.io --force-update
      failed_when: false

    - name: Update Helm repositories
      command: helm repo update
      changed_when: false

    # =========================================================================
    # CREATE VALUES FILE
    # =========================================================================
    - name: Ensure cert-manager charts directory exists
      file:
        path: "{{ remote_charts_dir }}/cert-manager"
        state: directory
        mode: "0755"

    - name: Create cert-manager values file
      copy:
        dest: "{{ remote_charts_dir }}/cert-manager/values-override.yaml"
        mode: "0644"
        content: |
          crds:
            enabled: true

    # =========================================================================
    # INSTALL OR UPGRADE CERT-MANAGER
    # =========================================================================
    - name: Install cert-manager via Helm (first time)
      command: >
        helm install cert-manager jetstack/cert-manager
        --namespace {{ cert_manager_namespace }}
        --create-namespace
        --version v{{ cert_manager_version }}
        --values {{ remote_charts_dir }}/cert-manager/values-override.yaml
      when: not certmanager_installed

    - name: Upgrade cert-manager via Helm (update)
      command: >
        helm upgrade cert-manager jetstack/cert-manager
        --namespace {{ cert_manager_namespace }}
        --version v{{ cert_manager_version }}
        --values {{ remote_charts_dir }}/cert-manager/values-override.yaml
      when: certmanager_installed

    # =========================================================================
    # WAIT FOR CERT-MANAGER TO BE READY
    # =========================================================================
    - name: Wait for cert-manager pods to be ready (timeout 3 min)
      command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n {{ cert_manager_namespace }} --timeout=180s
      register: certmanager_wait
      retries: 3
      delay: 10
      until: certmanager_wait.rc == 0

    # =========================================================================
    # INSTALL CERT-MANAGER-CONFIG (NetworkPolicy + ClusterIssuer)
    # =========================================================================
    - name: Check if cert-manager-config is already installed
      command: helm list -n {{ cert_manager_namespace }} -q
      register: certmanager_config_check
      changed_when: false
      failed_when: false

    - name: Set certmanager_config_installed fact
      set_fact:
        certmanager_config_installed: "{{ 'cert-manager-config' in certmanager_config_check.stdout }}"

    - name: Ensure cert-manager-config charts directory exists
      file:
        path: "{{ remote_charts_dir }}/cert-manager-config"
        state: directory
        mode: "0755"

    - name: Remove old cert-manager-config chart from remote server
      file:
        path: "{{ remote_charts_dir }}/cert-manager-config"
        state: absent

    - name: Copy cert-manager-config chart to server
      copy:
        src: "{{ playbook_dir }}/charts/cert-manager-config/"
        dest: "{{ remote_charts_dir }}/cert-manager-config/"
        mode: "0644"

    - name: Create cert-manager-config values file
      copy:
        dest: "{{ remote_charts_dir }}/cert-manager-config/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cert_manager_namespace }}
          clusterIssuer:
            name: {{ cert_manager_cluster_issuer }}
            email: {{ cert_manager_acme_email }}
            ingressClass: {{ traefik_ingress_class }}
            traefikEntrypoint: {{ traefik_web_entrypoint }}

    - name: Install cert-manager-config via Helm (first time)
      command: >
        helm install cert-manager-config {{ remote_charts_dir }}/cert-manager-config
        --namespace {{ cert_manager_namespace }}
        --values {{ remote_charts_dir }}/cert-manager-config/values-override.yaml
      when: not certmanager_config_installed

    - name: Upgrade cert-manager-config via Helm (update)
      command: >
        helm upgrade cert-manager-config {{ remote_charts_dir }}/cert-manager-config
        --namespace {{ cert_manager_namespace }}
        --values {{ remote_charts_dir }}/cert-manager-config/values-override.yaml
      when: certmanager_config_installed

    # =========================================================================
    # VERIFICATION
    # =========================================================================
    - name: Get cert-manager Helm releases
      command: helm list -n {{ cert_manager_namespace }}
      register: helm_list
      changed_when: false

    - name: Print Helm releases
      debug:
        msg: "{{ helm_list.stdout_lines }}"

    - name: Get cert-manager pods status
      command: kubectl get pods -n {{ cert_manager_namespace }} -o wide
      register: certmanager_pods
      changed_when: false

    - name: Print cert-manager pods status
      debug:
        msg: "{{ certmanager_pods.stdout_lines }}"

    - name: Confirm installation
      debug:
        msg: "cert-manager + cert-manager-config: OK"
