# =============================================================================
# GITLAB V2 INSTALLATION (Production Helm Chart)
# =============================================================================
# Prerequisites:
#   - Vault must be installed and unsealed
#   - Vault policies and roles must be synced (vault-policy-sync.yaml)
#   - External Secrets Operator must be installed
#
# This playbook:
#   1. Creates initial secrets in Vault (PostgreSQL, Redis, MinIO root)
#   2. Installs ESO resources (ServiceAccount, SecretStore, ExternalSecrets)
#   3. Waits for ESO to sync credentials
#   4. Installs PostgreSQL
#   5. Installs Redis
#   6. Installs MinIO
#   7. Creates MinIO buckets and access keys
#   8. Stores MinIO access keys in Vault
#   9. Installs GitLab (official Helm chart)
#   10. Stores GitLab root password in Vault
#   11. Installs GitLab Runner (without registration)
#
# =============================================================================

---
- name: Install GitLab v2 (Production Helm)
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # =========================================================================
    # INIT: Find secret names and vault paths by type from gitlab_v2_eso.secrets
    # =========================================================================
    - name: "[init] Find secret names and vault paths by type"
      set_fact:
        # Secret names
        secret_postgresql: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'postgresql') | first).target_secret_name }}"
        secret_redis: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'redis') | first).target_secret_name }}"
        secret_minio_root: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_root') | first).target_secret_name }}"
        secret_minio_registry: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_registry') | first).target_secret_name }}"
        secret_gitlab_registry_minio_connection: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'gitlab_registry_minio_connection') | first).target_secret_name }}"
        secret_gitlab_minio_connection: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'gitlab_minio_connection') | first).target_secret_name }}"
        secret_minio_runner_cache: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_runner_cache') | first).target_secret_name }}"
        secret_gitlab_root: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'gitlab_root') | first).target_secret_name }}"
        # Vault paths
        vault_path_postgresql: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'postgresql') | first).vault_path }}"
        vault_path_redis: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'redis') | first).vault_path }}"
        vault_path_minio_root: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_root') | first).vault_path }}"
        vault_path_minio_registry: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_registry') | first).vault_path }}"
        vault_path_minio_runner_cache: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'minio_runner_cache') | first).vault_path }}"
        vault_path_gitlab_root: "{{ (gitlab_v2_eso.secrets | selectattr('type', 'equalto', 'gitlab_root') | first).vault_path }}"

    # =========================================================================
    # STEP 1: GENERATE AND STORE INITIAL SECRETS IN VAULT
    # =========================================================================

    # ----- PostgreSQL credentials -----
    - name: "[vault-secrets] Check if PostgreSQL secret exists"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_postgresql }} 2>/dev/null
      register: postgresql_secret_check
      failed_when: false
      changed_when: false

    - name: "[vault-secrets] Generate PostgreSQL password"
      set_fact:
        generated_postgresql_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: postgresql_secret_check.rc != 0

    - name: "[vault-secrets] Store PostgreSQL credentials in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_postgresql }}
        username=gitlab
        password={{ generated_postgresql_password }}
      when: postgresql_secret_check.rc != 0

    # ----- Redis credentials -----
    - name: "[vault-secrets] Check if Redis secret exists"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_redis }} 2>/dev/null
      register: redis_secret_check
      failed_when: false
      changed_when: false

    - name: "[vault-secrets] Generate Redis password"
      set_fact:
        generated_redis_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: redis_secret_check.rc != 0

    - name: "[vault-secrets] Store Redis credentials in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_redis }}
        password={{ generated_redis_password }}
        redis_args="--save 1 1 --notify-keyspace-events KEA --requirepass {{ generated_redis_password }}"
      when: redis_secret_check.rc != 0

    # ----- MinIO root credentials -----
    - name: "[vault-secrets] Check if MinIO root secret exists"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_root }} 2>/dev/null
      register: minio_root_secret_check
      failed_when: false
      changed_when: false

    - name: "[vault-secrets] Generate MinIO root password"
      set_fact:
        generated_minio_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: minio_root_secret_check.rc != 0

    - name: "[vault-secrets] Store MinIO root credentials in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_root }}
        username={{ gitlab_v2_minio_root_user }}
        password={{ generated_minio_password }}
      when: minio_root_secret_check.rc != 0

    # =========================================================================
    # STEP 3: INSTALL PRE (ESO Resources, NetworkPolicies)
    # =========================================================================

    - name: "[pre] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/gitlab-v2/pre"
        state: directory
        mode: "0755"

    - name: "[pre] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "gitlab-v2-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/gitlab-v2/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/gitlab-v2/pre"

    - name: "[pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ gitlab_v2_namespace }}
          clusterDomain: {{ dns_domain }}
          vault:
            namespace: {{ vault_namespace }}
          externalSecrets:
            namespace: {{ external_secrets_namespace }}
          traefik:
            namespace: {{ traefik_namespace }}
            instanceName: traefik-{{ traefik_namespace }}
          haproxy:
            namespace: {{ haproxy_namespace }}
            ingressClass: {{ haproxy_ingress_class }}
          gitlab:
            releaseName: gitlab
          gitlabV2Eso:
            saName: {{ gitlab_v2_eso.sa_name }}
            roleName: {{ gitlab_v2_eso.role_name }}
            secretStoreName: {{ gitlab_v2_eso.secret_store_name }}
            kvEnginePath: {{ gitlab_v2_eso.kv_engine_path }}
            secrets: {{ gitlab_v2_eso.secrets | to_json }}
          minio:
            s3Endpoint: {{ gitlab_v2_minio_s3_endpoint }}
            s3Region: {{ gitlab_v2_minio_s3_region }}
            s3PathStyle: {{ gitlab_v2_minio_s3_path_style }}

    - name: "[pre] Install via Helm"
      command: >
        helm upgrade --install gitlab-v2-pre {{ remote_charts_dir }}/gitlab-v2/pre
        --namespace {{ gitlab_v2_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/gitlab-v2/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_pre_helm_timeout }}

    # =========================================================================
    # STEP 4: WAIT FOR INITIAL SECRETS TO SYNC
    # =========================================================================

    - name: "[wait-eso] Wait for PostgreSQL secret"
      command: kubectl get secret {{ secret_postgresql }} -n {{ gitlab_v2_namespace }}
      register: postgresql_secret_wait
      until: postgresql_secret_wait.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    - name: "[wait-eso] Wait for Redis secret"
      command: kubectl get secret {{ secret_redis }} -n {{ gitlab_v2_namespace }}
      register: redis_secret_wait
      until: redis_secret_wait.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    - name: "[wait-eso] Wait for MinIO root secret"
      command: kubectl get secret {{ secret_minio_root }} -n {{ gitlab_v2_namespace }}
      register: minio_root_secret_wait
      until: minio_root_secret_wait.rc == 0
      retries: 30
      delay: 5
      changed_when: false

    # =========================================================================
    # STEP 5: INSTALL POSTGRESQL
    # =========================================================================

    - name: "[postgresql] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/gitlab-v2/postgresql"
        state: directory
        mode: "0755"

    - name: "[postgresql] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "gitlab-v2-postgresql"
        chart_name: "postgresql"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/gitlab-v2/postgresql/"
        chart_remote_dest: "{{ remote_charts_dir }}/gitlab-v2/postgresql"

    - name: "[postgresql] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/postgresql/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ gitlab_v2_namespace }}
          image: {{ gitlab_v2_postgresql_image }}
          storageClass: {{ gitlab_v2_postgresql_storage_class }}
          storageSize: {{ gitlab_v2_postgresql_storage_size }}
          credentialsSecretName: {{ secret_postgresql }}

    - name: "[postgresql] Install via Helm"
      command: >
        helm upgrade --install gitlab-v2-postgresql {{ remote_charts_dir }}/gitlab-v2/postgresql
        --namespace {{ gitlab_v2_namespace }}
        --values {{ remote_charts_dir }}/gitlab-v2/postgresql/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_storage_helm_timeout }}

    - name: "[postgresql] Wait for deployment to be ready"
      command: kubectl rollout status deployment/gitlab-postgresql -n {{ gitlab_v2_namespace }} --timeout={{ gitlab_v2_storage_rollout_timeout }}

    # =========================================================================
    # STEP 6: INSTALL REDIS
    # =========================================================================

    - name: "[redis] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/gitlab-v2/redis"
        state: directory
        mode: "0755"

    - name: "[redis] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "gitlab-v2-redis"
        chart_name: "redis"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/gitlab-v2/redis/"
        chart_remote_dest: "{{ remote_charts_dir }}/gitlab-v2/redis"

    - name: "[redis] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/redis/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ gitlab_v2_namespace }}
          image: {{ gitlab_v2_redis_image }}
          credentialsSecretName: {{ secret_redis }}
          storageClass: {{ gitlab_v2_redis_storage_class }}
          storageSize: {{ gitlab_v2_redis_storage_size }}

    - name: "[redis] Install via Helm"
      command: >
        helm upgrade --install gitlab-v2-redis {{ remote_charts_dir }}/gitlab-v2/redis
        --namespace {{ gitlab_v2_namespace }}
        --values {{ remote_charts_dir }}/gitlab-v2/redis/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_storage_helm_timeout }}

    - name: "[redis] Wait for deployment to be ready"
      command: kubectl rollout status deployment/gitlab-redis -n {{ gitlab_v2_namespace }} --timeout={{ gitlab_v2_storage_rollout_timeout }}

    # =========================================================================
    # STEP 7: INSTALL MINIO
    # =========================================================================

    - name: "[minio] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/gitlab-v2/minio"
        state: directory
        mode: "0755"

    - name: "[minio] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "gitlab-v2-minio"
        chart_name: "minio"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/gitlab-v2/minio/"
        chart_remote_dest: "{{ remote_charts_dir }}/gitlab-v2/minio"

    - name: "[minio] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/minio/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ gitlab_v2_namespace }}
          image: {{ gitlab_v2_minio_image }}
          storageClass: {{ gitlab_v2_minio_storage_class }}
          storageSize: {{ gitlab_v2_minio_storage_size }}
          rootSecretName: {{ secret_minio_root }}

    - name: "[minio] Install via Helm"
      command: >
        helm upgrade --install gitlab-v2-minio {{ remote_charts_dir }}/gitlab-v2/minio
        --namespace {{ gitlab_v2_namespace }}
        --values {{ remote_charts_dir }}/gitlab-v2/minio/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_storage_helm_timeout }}

    - name: "[minio] Wait for deployment to be ready"
      command: kubectl rollout status deployment/gitlab-minio -n {{ gitlab_v2_namespace }} --timeout={{ gitlab_v2_storage_rollout_timeout }}

    # =========================================================================
    # STEP 8: MINIO SETUP (Buckets and Access Keys)
    # =========================================================================

    - name: "[minio-setup] Get MinIO pod name"
      command: >
        kubectl get pods -n {{ gitlab_v2_namespace }}
        -l app.kubernetes.io/name=gitlab-minio
        -o jsonpath='{.items[0].metadata.name}'
      register: minio_pod_name

    - name: "[minio-setup] Get MinIO root credentials from secret"
      shell: |
        kubectl get secret {{ secret_minio_root }} -n {{ gitlab_v2_namespace }} \
          -o jsonpath='{.data.username}' | base64 -d
      register: minio_root_user_from_secret
      changed_when: false

    - name: "[minio-setup] Get MinIO root password from secret"
      shell: |
        kubectl get secret {{ secret_minio_root }} -n {{ gitlab_v2_namespace }} \
          -o jsonpath='{.data.password}' | base64 -d
      register: minio_root_password_from_secret
      changed_when: false

    - name: "[minio-setup] Configure mc alias"
      command: >
        kubectl exec -n {{ gitlab_v2_namespace }} {{ minio_pod_name.stdout }} --
        mc alias set myminio http://localhost:9000
        '{{ minio_root_user_from_secret.stdout }}'
        '{{ minio_root_password_from_secret.stdout }}'

    # Create buckets
    - name: "[minio-setup] Create buckets"
      command: >
        kubectl exec -n {{ gitlab_v2_namespace }} {{ minio_pod_name.stdout }} --
        mc mb myminio/{{ item }} --ignore-existing
      loop:
        - registry
        - gitlab-artifacts
        - gitlab-uploads
        - gitlab-packages
        - gitlab-backups
        - runner-cache

    # Create access keys for registry
    - name: "[minio-setup] Check if registry access_key exists in Vault"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_registry }} 2>/dev/null \
          | jq -r '.data.data.access_key // empty'
      register: registry_access_key_check
      failed_when: false
      changed_when: false

    - name: "[minio-setup] Create access key for registry"
      command: >
        kubectl exec -n {{ gitlab_v2_namespace }} {{ minio_pod_name.stdout }} --
        mc admin accesskey create myminio {{ minio_root_user_from_secret.stdout }}
        --name 'registry-key' --json
      register: registry_accesskey_result
      when: registry_access_key_check.stdout == ""

    - name: "[minio-setup] Store registry access key in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_registry }}
        access_key={{ (registry_accesskey_result.stdout | from_json).accessKey }}
        secret_key={{ (registry_accesskey_result.stdout | from_json).secretKey }}
        bucket_name=registry
      when: registry_access_key_check.stdout == ""

    # Create access keys for runner-cache
    - name: "[minio-setup] Check if runner-cache access_key exists in Vault"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_runner_cache }} 2>/dev/null \
          | jq -r '.data.data.access_key // empty'
      register: runner_cache_access_key_check
      failed_when: false
      changed_when: false

    - name: "[minio-setup] Create access key for runner-cache"
      command: >
        kubectl exec -n {{ gitlab_v2_namespace }} {{ minio_pod_name.stdout }} --
        mc admin accesskey create myminio {{ minio_root_user_from_secret.stdout }}
        --name 'runner-cache-key' --json
      register: runner_cache_accesskey_result
      when: runner_cache_access_key_check.stdout == ""

    - name: "[minio-setup] Parse and store runner-cache access key in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_runner_cache }}
        access_key={{ (runner_cache_accesskey_result.stdout | from_json).accessKey }}
        secret_key={{ (runner_cache_accesskey_result.stdout | from_json).secretKey }}
        bucket_name=runner-cache
      when: runner_cache_access_key_check.stdout == ""

    # =========================================================================
    # STEP 9: WAIT FOR MINIO ACCESS KEYS TO SYNC
    # =========================================================================

    - name: "[wait-eso] Wait for registry secret with access_key"
      shell: |
        kubectl get secret {{ secret_minio_registry }} -n {{ gitlab_v2_namespace }} \
          -o jsonpath='{.data.access_key}' | base64 -d
      register: registry_access_key_sync_check
      until: registry_access_key_sync_check.stdout != ""
      retries: 30
      delay: 5
      changed_when: false

    # =========================================================================
    # STEP 10: INSTALL GITLAB (Official Helm Chart)
    # =========================================================================

    - name: "[gitlab] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/gitlab-values-override.yaml"
        mode: "0644"
        content: |
          global:
            edition: ce
            hosts:
              domain: {{ gitlab_v2_base_domain }}
              https: true
              gitlab:
                name: {{ gitlab_v2_domain }}
                https: true
              registry:
                name: {{ gitlab_v2_registry_domain }}
                https: true
              pages:
                name: {{ gitlab_v2_pages_domain }}
                https: true
            ingress:
              enabled: false
              configureCertmanager: false
            shell:
              port: {{ gitlab_v2_ssh_port_external }}
            psql:
              host: svc-gitlab-postgresql
              port: 5432
              database: gitlabhq_production
              username: gitlab
              password:
                useSecret: true
                secret: {{ secret_postgresql }}
                key: password
            redis:
              host: svc-gitlab-redis
              port: 6379
              auth:
                enabled: true
                secret: {{ secret_redis }}
                key: password
            minio:
              enabled: false
            registry:
              bucket: registry
            kas:
              enabled: false
            pages:
              enabled: true
            appConfig:
              lfs:
                enabled: false
              object_store:
                enabled: true
                proxy_download: true
                connection:
                  secret: {{ secret_gitlab_minio_connection }}
                  key: connection
              artifacts:
                enabled: true
                bucket: gitlab-artifacts
              uploads:
                enabled: true
                bucket: gitlab-uploads
              packages:
                enabled: true
                bucket: gitlab-packages
              backups:
                bucket: gitlab-backups
            smtp:
              enabled: false
          nginx-ingress:
            enabled: false
          certmanager:
            install: false
          prometheus:
            install: false
          postgresql:
            install: false
          redis:
            install: false
          registry:
            enabled: true
            hpa:
              minReplicas: 1
              maxReplicas: 2
            storage:
              secret: {{ secret_gitlab_registry_minio_connection }}
              key: config
              redirect:
                disable: true
          gitlab:
            webservice:
              minReplicas: 1
              maxReplicas: 2
              workerProcesses: 2
              workerTimeout: 180
              resources:
                requests:
                  memory: {{ gitlab_v2_webservice_memory_request }}
                  cpu: {{ gitlab_v2_webservice_cpu_request }}
                limits:
                  memory: {{ gitlab_v2_webservice_memory_limit }}
            sidekiq:
              minReplicas: 1
              maxReplicas: 2
              concurrency: 10
              resources:
                requests:
                  memory: {{ gitlab_v2_sidekiq_memory_request }}
                  cpu: {{ gitlab_v2_sidekiq_cpu_request }}
                limits:
                  memory: {{ gitlab_v2_sidekiq_memory_limit }}
            gitlab-shell:
              minReplicas: 1
              maxReplicas: 2
            gitaly:
              persistence:
                size: {{ gitlab_v2_gitaly_storage_size }}
                storageClass: {{ gitlab_v2_gitaly_storage_class }}
            toolbox:
              enabled: true
            migrations:
              enabled: true
          gitlab-runner:
            install: false

    - name: "[gitlab] Add GitLab Helm repository"
      command: helm repo add gitlab https://charts.gitlab.io --force-update

    - name: "[gitlab] Update Helm repositories"
      command: helm repo update

    - name: "[gitlab] Install via Helm"
      command: >
        helm upgrade --install gitlab gitlab/gitlab
        --namespace {{ gitlab_v2_namespace }}
        --values {{ remote_charts_dir }}/gitlab-v2/gitlab-values-override.yaml
        --version {{ gitlab_v2_chart_version }}
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_helm_timeout }}

    - name: "[gitlab] Wait for webservice deployment to be ready"
      command: >
        kubectl rollout status deployment -l app=webservice
        -n {{ gitlab_v2_namespace }}
        --timeout={{ gitlab_v2_rollout_timeout }}

    # =========================================================================
    # STEP 11: SAVE GITLAB ROOT PASSWORD TO VAULT
    # =========================================================================

    - name: "[gitlab-root] Check if root password exists in Vault"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- \
          vault kv get -format=json \
          {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_gitlab_root }} 2>/dev/null
      register: gitlab_root_vault_check
      failed_when: false
      changed_when: false

    - name: "[gitlab-root] Get root password from Kubernetes secret"
      shell: |
        kubectl get secret gitlab-gitlab-initial-root-password \
          -n {{ gitlab_v2_namespace }} \
          -o jsonpath='{.data.password}' | base64 -d
      register: gitlab_root_password_result
      when: gitlab_root_vault_check.rc != 0

    - name: "[gitlab-root] Store root password in Vault"
      command: >
        kubectl exec -n {{ vault_namespace }} vault-0 --
        vault kv put {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_gitlab_root }}
        username=root
        password={{ gitlab_root_password_result.stdout }}
      when:
        - gitlab_root_vault_check.rc != 0
        - gitlab_root_password_result.stdout is defined
        - gitlab_root_password_result.stdout | length > 0

    # =========================================================================
    # STEP 12: INSTALL POST CHART (Ingress, HAProxy SSH)
    # =========================================================================

    - name: "[post] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/gitlab-v2/post"
        state: directory
        mode: "0755"

    - name: "[post] Copy chart to remote"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "gitlab-v2-post"
        chart_name: "post"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/gitlab-v2/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/gitlab-v2/post"

    - name: "[post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/gitlab-v2/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ gitlab_v2_namespace }}
          sshPortExternal: {{ gitlab_v2_ssh_port_external }}
          gitlab:
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            domain: {{ gitlab_v2_domain }}
            registryDomain: {{ gitlab_v2_registry_domain }}
            pagesDomain: {{ gitlab_v2_pages_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            secretName: {{ gitlab_v2_https_secret_name }}
            vpnOnlyEnabled: {{ gitlab_v2_vpn_only_enabled }}
          traefik:
            namespace: {{ traefik_namespace }}
          minio:
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            consoleDomain: {{ gitlab_v2_minio_console_domain }}
            apiDomain: {{ gitlab_v2_minio_api_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            secretName: {{ gitlab_v2_minio_secret_name }}
            vpnOnlyEnabled: {{ gitlab_v2_vpn_only_enabled }}
          haproxy:
            namespace: {{ haproxy_namespace }}
            ingressClass: {{ haproxy_ingress_class }}

    - name: "[post] Install via Helm"
      command: >
        helm upgrade --install gitlab-v2-post {{ remote_charts_dir }}/gitlab-v2/post
        --namespace {{ gitlab_v2_namespace }}
        --values {{ remote_charts_dir }}/gitlab-v2/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ gitlab_v2_helm_timeout }}

    # =========================================================================
    # STEP 13: VERIFICATION
    # =========================================================================

    - name: "[verify] Check Helm releases"
      command: helm list -n {{ gitlab_v2_namespace }}
      register: helm_verify
      changed_when: false

    - name: "[verify] Show Helm releases"
      debug:
        var: helm_verify.stdout_lines

    - name: "[verify] Show access info"
      debug:
        msg:
          - "=============================================="
          - "GITLAB V2 INSTALLATION COMPLETE"
          - "=============================================="
          - "GitLab Web UI: https://{{ gitlab_v2_domain }}"
          - "GitLab Registry: https://{{ gitlab_v2_registry_domain }}"
          - "GitLab Pages: https://{{ gitlab_v2_pages_domain }}"
          - "GitLab SSH: {{ gitlab_v2_domain }}:{{ gitlab_v2_ssh_port_external }}"
          - ""
          - "Credentials stored in Vault:"
          - "  GitLab root: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_gitlab_root }}"
          - "  PostgreSQL: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_postgresql }}"
          - "  Redis: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_redis }}"
          - "  MinIO root: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_root }}"
          - "  MinIO registry: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_registry }}"
          - "  MinIO runner-cache: {{ gitlab_v2_eso.kv_engine_path }}{{ vault_path_minio_runner_cache }}"
          - ""
          - "GitLab Runner: Installed but NOT registered."
          - "  Register manually via UI or CLI."
          - "=============================================="
