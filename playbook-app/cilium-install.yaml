# =============================================================================
# Install Cilium CNI via Helm
# Steps:
#   1. cilium-pre: NetworkPolicies for kube-system and cilium namespaces
#   2. Official Cilium Helm chart (replaces kube-proxy, enables Hubble, host firewall)
#   3. cilium-post: CiliumClusterwideNetworkPolicy for host protection
#
# For Hubble UI Ingress use separate playbook: cilium-hubble-install.yaml
# =============================================================================

---
- name: Install Cilium CNI
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[cilium-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "cilium-install-pre-check"

    # =========================================================================
    # STEP 1: CILIUM-PRE (NetworkPolicies)
    # =========================================================================

    - name: "[cilium-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "cilium-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/cilium/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/cilium/pre"

    - name: "[cilium-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cilium/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cilium_namespace }}
          traefik:
            namespace: {{ traefik_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install cilium-pre {{ remote_charts_dir }}/cilium/pre
        --namespace {{ cilium_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/cilium/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_config_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: OFFICIAL CILIUM HELM
    # =========================================================================

    - name: "[cilium-install] Add Helm repository"
      include_tasks: tasks/tasks-add-helm-repo.yaml
      vars:
        label_name: "cilium-install"
        helm_repo_name: "cilium"
        helm_repo_url: "https://helm.cilium.io/"

    - name: "[cilium-install] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/cilium"
        state: directory
        mode: "0755"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cilium/values-override.yaml"
        mode: "0644"
        content: |
          ipam:
            operator:
              clusterPoolIPv4PodCIDRList:
                - {{ pod_subnet }}
              clusterPoolIPv4MaskSize: {{ cilium_mask_size }}
          operator:
            replicas: {{ cilium_operator_replicas }}
          kubeProxyReplacement: true
          kubeProxyReplacementHealthzBindAddr: "0.0.0.0:10256"
          k8sServiceHost: {{ haproxy_apiserver_lb_host }}
          k8sServicePort: {{ haproxy_apiserver_lb_port }}
          nodePort:
            range: "{{ node_port_start }},{{ node_port_end }}"
          hubble:
            relay:
              enabled: true
            ui:
              enabled: true
            peerService:
              clusterDomain: {{ dns_domain }}
          hostFirewall:
            enabled: true
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-install] Install or upgrade via Helm"
      command: >
        helm upgrade --install cilium cilium/cilium
        --version {{ cilium_version }}
        --namespace {{ cilium_namespace }}
        --values {{ remote_charts_dir }}/cilium/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # WAIT FOR CILIUM CRDs
    # =========================================================================

    - name: "[cilium-install] Wait for CRDs"
      include_tasks: tasks/tasks-wait-crds.yaml
      vars:
        label_name: "cilium-install"
        crds_list:
          - crd/ciliumcidrgroups.cilium.io
          - crd/ciliumclusterwidenetworkpolicies.cilium.io
          - crd/ciliumendpoints.cilium.io
          - crd/ciliumidentities.cilium.io
          - crd/ciliuml2announcementpolicies.cilium.io
          - crd/ciliumloadbalancerippools.cilium.io
          - crd/ciliumnetworkpolicies.cilium.io
          - crd/ciliumnodeconfigs.cilium.io
          - crd/ciliumnodes.cilium.io
          - crd/ciliumpodippools.cilium.io

    # =========================================================================
    # WAIT FOR CILIUM PODS
    # =========================================================================

    - name: "[cilium-install] Wait for DaemonSet rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "cilium-install"
        rollout_namespace: "{{ cilium_namespace }}"
        rollout_timeout: "{{ cilium_daemonset_rollout_timeout }}"
        rollout_resources:
          - daemonset/cilium
          - daemonset/cilium-envoy

    - name: "[cilium-install] Wait for Deployment rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "cilium-install"
        rollout_namespace: "{{ cilium_namespace }}"
        rollout_timeout: "{{ cilium_deployment_rollout_timeout }}"
        rollout_resources:
          - deployment/cilium-operator

    # =========================================================================
    # STEP 3: CILIUM-POST (CiliumClusterwideNetworkPolicy)
    # =========================================================================

    - name: "[cilium-post] Install cilium-post"
      include_tasks: tasks/tasks-cilium-post-install.yaml

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[cilium-verify] Verify Helm releases"
      include_tasks: tasks/tasks-verify-helm.yaml
      vars:
        helm_namespace: "{{ cilium_namespace }}"
        label_name: "cilium-verify"

    - name: "[cilium-verify] Get Cilium pods status"
      command: kubectl get pods -n {{ cilium_namespace }} -o wide
      register: cilium_pods
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-verify] Print Cilium pods status"
      debug:
        msg: "{{ cilium_pods.stdout_lines }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-verify] Installation complete"
      debug:
        msg: "cilium-pre + cilium + cilium-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
