# =============================================================================
# Vault Sync Policies and Roles
# =============================================================================
# Applies pre-merged policy and role lists to Vault (API operations only).
#
# Used by:
#   - vault-install.yaml     (called AFTER tasks-eso-merge.yaml)
#   - vault-policy-sync.yaml (called AFTER tasks-eso-merge.yaml)
#
# Requires variables (produced by tasks-eso-merge.yaml):
#   - vault_policies_final (array)
#   - vault_roles_final    (array)
#   - vault_namespace
#   - remote_charts_dir
#   - _derived_policies    (for summary)
#   - _derived_roles       (for summary)
#   - vault_policies, vault_roles
#   - vault_policies_extra, vault_roles_extra
# =============================================================================

# -------------------------------------------------------------------------
# Show sync summary
# -------------------------------------------------------------------------

- name: "[vault-policy-sync] Show sync summary"
  debug:
    msg:
      - "Derived from integrations: {{ _derived_policies | length }} policies, {{ _derived_roles | length }} roles"
      - "Manual overrides (vault_policies/vault_roles): {{ vault_policies | length }} policies, {{ vault_roles | length }} roles"
      - "Extra (hosts-extra.yaml): {{ (vault_policies_extra | default([])) | length }} policies, {{ (vault_roles_extra | default([])) | length }} roles"
      - "Final totals: {{ vault_policies_final | length }} policies, {{ vault_roles_final | length }} roles"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# Reconcile policies: delete removed ones
# -------------------------------------------------------------------------

- name: "[vault-policy-sync] Get existing policies from Vault"
  shell: >
    kubectl exec -n {{ vault_namespace }} vault-0 --
    vault policy list -format=json 2>/dev/null || echo '[]'
  register: vault_existing_policies_raw
  changed_when: false
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Set policies to delete (drift cleanup)"
  set_fact:
    vault_policies_to_delete: >-
      {{
        (vault_existing_policies_raw.stdout | from_json)
        | difference(vault_policies_final | map(attribute='name') | list)
        | difference(['default', 'root'])
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Show policies to delete"
  debug:
    msg: "Policies to delete (removed from hosts.yaml): {{ vault_policies_to_delete }}"
  when: vault_policies_to_delete | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Delete removed policies"
  command: >
    kubectl exec -n {{ vault_namespace }} vault-0 --
    vault policy delete {{ item }}
  loop: "{{ vault_policies_to_delete }}"
  when: vault_policies_to_delete | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# Sync policies from vault_policies_final
# -------------------------------------------------------------------------

- name: "[vault-policy-sync] Show policies to sync"
  debug:
    msg: "Syncing {{ vault_policies_final | length }} policies"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Ensure policies directory exists"
  file:
    path: "{{ remote_charts_dir }}/vault/config/policies"
    state: directory
    mode: "0755"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Create policy files on server"
  copy:
    dest: "{{ remote_charts_dir }}/vault/config/policies/{{ item.name }}.hcl"
    mode: "0644"
    content: |
      {% for p in item.paths %}
      path "{{ p.path }}" {
        capabilities = {{ p.capabilities | to_json }}
      }
      {% endfor %}
  loop: "{{ vault_policies_final }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Copy policy files to container"
  command: >
    kubectl cp {{ remote_charts_dir }}/vault/config/policies/{{ item.name }}.hcl
    {{ vault_namespace }}/vault-0:/tmp/{{ item.name }}.hcl
  loop: "{{ vault_policies_final }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Apply policies in Vault"
  command: >
    kubectl exec -n {{ vault_namespace }} vault-0 --
    vault policy write {{ item.name }} /tmp/{{ item.name }}.hcl
  loop: "{{ vault_policies_final }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# Reconcile roles: delete removed ones
# -------------------------------------------------------------------------

- name: "[vault-policy-sync] Get existing roles from Vault"
  shell: |
    result=$(kubectl exec -n {{ vault_namespace }} vault-0 -- \
      vault list -format=json auth/kubernetes/role 2>/dev/null) || true
    echo "${result:-[]}"
  register: vault_existing_roles_raw
  changed_when: false
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Set roles to delete (drift cleanup)"
  set_fact:
    vault_roles_to_delete: >-
      {{
        (vault_existing_roles_raw.stdout | from_json)
        | difference(vault_roles_final | map(attribute='name') | list)
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Show roles to delete"
  debug:
    msg: "Roles to delete (removed from hosts.yaml): {{ vault_roles_to_delete }}"
  when: vault_roles_to_delete | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Delete removed roles"
  command: >
    kubectl exec -n {{ vault_namespace }} vault-0 --
    vault delete auth/kubernetes/role/{{ item }}
  loop: "{{ vault_roles_to_delete }}"
  when: vault_roles_to_delete | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# Sync roles from vault_roles_final
# -------------------------------------------------------------------------

- name: "[vault-policy-sync] Show roles to sync"
  debug:
    msg: "Syncing {{ vault_roles_final | length }} roles"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[vault-policy-sync] Create/update roles"
  command: >
    kubectl exec -n {{ vault_namespace }} vault-0 -- vault write auth/kubernetes/role/{{ item.name }}
    bound_service_account_names={{ item.sa_name }}
    bound_service_account_namespaces={{ item.namespace }}
    policies={{ item.policies | join(',') }}
    ttl=1h
  loop: "{{ vault_roles_final }}"
  loop_control:
    label: "{{ item.name }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true
