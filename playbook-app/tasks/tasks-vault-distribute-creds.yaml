# =============================================================================
# Distribute Vault credentials to ALL control-plane nodes
# =============================================================================
# This task distributes vault credentials (root_token + unseal_keys) to all
# manager nodes. Runs naturally on all hosts in the play (hosts: managers).
#
# Required vars:
#   - vault_root_token_tmp: Vault root token
#   - vault_unseal_keys_tmp: List of unseal keys
#   - vault_creds_host_path_tmp: Path to save credentials file (e.g. /etc/kubernetes/vault-unseal.json)
# =============================================================================

---
- name: "[vault-creds] Build credentials JSON"
  set_fact:
    vault_creds_json:
      root_token: "{{ vault_root_token_tmp }}"
      unseal_keys: "{{ vault_unseal_keys_tmp }}"
      key_threshold: "{{ vault_key_threshold }}"

- name: "[vault-creds] Ensure credentials directory exists on all managers"
  file:
    path: "{{ vault_creds_host_path_tmp | dirname }}"
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: "[vault-creds] Distribute credentials to all managers"
  copy:
    content: "{{ vault_creds_json | to_nice_json }}"
    dest: "{{ vault_creds_host_path_tmp }}"
    mode: "0600"
    owner: root
    group: root

- name: "[vault-creds] Verify credentials file on all managers"
  stat:
    path: "{{ vault_creds_host_path_tmp }}"
  register: creds_file_check

- name: "[vault-creds] Show distribution result"
  debug:
    msg: "Credentials distributed to {{ groups['managers'] | length }} manager(s): {{ groups['managers'] | join(', ') }}"
  run_once: true
