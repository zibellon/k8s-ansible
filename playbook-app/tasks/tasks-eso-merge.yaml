# =============================================================================
# ESO Integrations Merge
# =============================================================================
# Merges per-component base integrations (from hosts.yaml) with extra secrets
# (from hosts-extra.yaml), then derives Vault policies and roles.
#
# Called explicitly by:
#   - vault-install.yaml       (before tasks-vault-policy-sync.yaml)
#   - vault-policy-sync.yaml   (before tasks-vault-policy-sync.yaml)
#   - longhorn-install.yaml    (to get eso_vault_integration_longhorn_merged)
#   - gitlab-install.yaml      (to get eso_vault_integration_gitlab_merged)
#   - argocd-git-ops-install.yaml (to get _merged objects)
#
# Requires variables (from hosts.yaml):
#   - eso_vault_integration_vault
#   - eso_vault_integration_longhorn
#   - eso_vault_integration_gitlab
#   - eso_vault_integration_argocd
#   - eso_vault_integration_vault_extra    (default: {secrets: []})
#   - eso_vault_integration_longhorn_extra (default: {secrets: []})
#   - eso_vault_integration_gitlab_extra   (default: {secrets: []})
#   - eso_vault_integration_argocd_extra   (default: {secrets: []})
#   - vault_policies (array)
#   - vault_roles    (array)
#   - vault_policies_extra (array, optional)
#   - vault_roles_extra    (array, optional)
#
# Produces:
#   - eso_vault_integration_vault_merged
#   - eso_vault_integration_longhorn_merged
#   - eso_vault_integration_gitlab_merged
#   - eso_vault_integration_argocd_merged
#   - _derived_policies
#   - _derived_roles
#   - vault_policies_final
#   - vault_roles_final
#
# Conflict rules (per component):
#   - external_secret_name must be unique within namespace (base vs extra)
#   - target_secret_name must be unique within namespace (base vs extra)
# Policy/role conflict rules:
#   - policy.name and role.name must be unique across all sources
# =============================================================================

# -------------------------------------------------------------------------
# STAGE 1: Per-component conflict check + merge
# -------------------------------------------------------------------------

# --- VAULT ---

- name: "[eso-merge-vault] Validate type=default for eso_vault_integration_vault_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_vault_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      All secrets in hosts-extra.yaml must have type: "default".
  when: (item.type | default('')) != 'default'
  loop: "{{ eso_vault_integration_vault_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-vault] Detect secret conflicts in eso_vault_integration_vault_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_vault.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_vault.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_vault.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_vault_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_vault_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-vault] Merge eso_vault_integration_vault + extra"
  set_fact:
    eso_vault_integration_vault_merged: >-
      {{ eso_vault_integration_vault | combine({
           'secrets': eso_vault_integration_vault.secrets + (eso_vault_integration_vault_extra.secrets | default([]))
         })
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# --- TRAEFIK ---

- name: "[eso-merge] Validate type=default for eso_vault_integration_traefik_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_traefik_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      All secrets in hosts-extra.yaml must have type: "default".
  when: (item.type | default('')) != 'default'
  loop: "{{ eso_vault_integration_traefik_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Detect secret conflicts in eso_vault_integration_traefik_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_traefik.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_traefik.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_traefik.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_traefik_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_traefik_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Merge eso_vault_integration_traefik + extra"
  set_fact:
    eso_vault_integration_traefik_merged: >-
      {{ eso_vault_integration_traefik | combine({
           'secrets': eso_vault_integration_traefik.secrets
                      + (eso_vault_integration_traefik_extra.secrets | default([]))
         }) }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# --- HAPROXY ---

- name: "[eso-merge] Validate type=default for eso_vault_integration_haproxy_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_haproxy_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      All secrets in hosts-extra.yaml must have type: "default".
  when: (item.type | default('')) != 'default'
  loop: "{{ eso_vault_integration_haproxy_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Detect secret conflicts in eso_vault_integration_haproxy_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_haproxy.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_haproxy.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_haproxy.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_haproxy_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_haproxy_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Merge eso_vault_integration_haproxy + extra"
  set_fact:
    eso_vault_integration_haproxy_merged: >-
      {{ eso_vault_integration_haproxy | combine({
           'secrets': eso_vault_integration_haproxy.secrets
                      + (eso_vault_integration_haproxy_extra.secrets | default([]))
         }) }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# --- LONGHORN ---

- name: "[eso-merge-longhorn] Validate type=default for eso_vault_integration_longhorn_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_longhorn_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      All secrets in hosts-extra.yaml must have type: "default".
  when: (item.type | default('')) != 'default'
  loop: "{{ eso_vault_integration_longhorn_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-longhorn] Detect secret conflicts in eso_vault_integration_longhorn_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_longhorn.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_longhorn.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_longhorn.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_longhorn_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_longhorn_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-longhorn] Merge eso_vault_integration_longhorn + extra"
  set_fact:
    eso_vault_integration_longhorn_merged: >-
      {{ eso_vault_integration_longhorn | combine({
           'secrets': eso_vault_integration_longhorn.secrets + (eso_vault_integration_longhorn_extra.secrets | default([]))
         })
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# --- GITLAB ---

- name: "[eso-merge-gitlab] Validate type=default for eso_vault_integration_gitlab_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_gitlab_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      All secrets in hosts-extra.yaml must have type: "default".
  when: (item.type | default('')) != 'default'
  loop: "{{ eso_vault_integration_gitlab_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-gitlab] Detect secret conflicts in eso_vault_integration_gitlab_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_gitlab.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_gitlab.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_gitlab.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_gitlab_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_gitlab_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-gitlab] Merge eso_vault_integration_gitlab + extra"
  set_fact:
    eso_vault_integration_gitlab_merged: >-
      {{ eso_vault_integration_gitlab | combine({
           'secrets': eso_vault_integration_gitlab.secrets + (eso_vault_integration_gitlab_extra.secrets | default([]))
         })
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# --- ARGOCD ---

- name: "[eso-merge-argocd] Validate type for eso_vault_integration_argocd_extra secrets"
  fail:
    msg: >-
      Secret '{{ item.external_secret_name }}' in eso_vault_integration_argocd_extra
      has invalid type '{{ item.type | default("MISSING") }}'.
      Allowed types in hosts-extra.yaml for argocd: "default", "repo_creds".
  when: (item.type | default('')) not in ['default', 'repo_creds']
  loop: "{{ eso_vault_integration_argocd_extra.secrets | default([]) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-argocd] Detect secret conflicts in eso_vault_integration_argocd_extra"
  fail:
    msg: >-
      Secret '{{ item }}' уже определён в hosts.yaml (eso_vault_integration_argocd.secrets).
      Поменяйте название в hosts-extra.yaml.
  vars:
    _base_names: >-
      {{ eso_vault_integration_argocd.secrets | map(attribute='external_secret_name') | list
         + eso_vault_integration_argocd.secrets | map(attribute='target_secret_name') | list }}
  when: item in _base_names
  loop: >-
    {{ (eso_vault_integration_argocd_extra.secrets | default([]))
       | map(attribute='external_secret_name') | list
       + (eso_vault_integration_argocd_extra.secrets | default([]))
       | map(attribute='target_secret_name') | list }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge-argocd] Merge eso_vault_integration_argocd + extra"
  set_fact:
    eso_vault_integration_argocd_merged: >-
      {{
        eso_vault_integration_argocd | combine({ 'secrets': eso_vault_integration_argocd.secrets + (eso_vault_integration_argocd_extra.secrets | default([])) })
      }}
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# STAGE 2: Build combined integrations list
# -------------------------------------------------------------------------

- name: "[eso-merge] Build combined integrations list"
  set_fact:
    _all_eso_integrations:
      - "{{ eso_vault_integration_vault_merged }}"
      - "{{ eso_vault_integration_traefik_merged }}"
      - "{{ eso_vault_integration_haproxy_merged }}"
      - "{{ eso_vault_integration_longhorn_merged }}"
      - "{{ eso_vault_integration_gitlab_merged }}"
      - "{{ eso_vault_integration_argocd_merged }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# STAGE 3: Derive policies from merged integrations
# -------------------------------------------------------------------------

- name: "[eso-merge] Initialize derived lists"
  set_fact:
    _derived_policies: []
    _derived_roles: []
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Derive policies from integration secrets"
  set_fact:
    _derived_policies: >-
      {{ _derived_policies + [{
        'name': item.0.namespace ~ '_' ~ item.1.external_secret_name,
        'paths': [
          {
            'path': item.0.kv_engine_path ~ '/data' ~ item.1.vault_path,
            'capabilities': ['read', 'list']
          },
          {
            'path': item.0.kv_engine_path ~ '/metadata' ~ item.1.vault_path,
            'capabilities': ['read', 'list']
          }
        ]
      }] }}
  loop: "{{ _all_eso_integrations | subelements('secrets') }}"
  loop_control:
    label: "{{ item.0.namespace }}_{{ item.1.external_secret_name }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# STAGE 4: Derive roles from merged integrations
# -------------------------------------------------------------------------

- name: "[eso-merge] Derive roles from integrations"
  set_fact:
    _derived_roles: >-
      {{ _derived_roles + [{
        'name': item.role_name,
        'namespace': item.namespace,
        'sa_name': item.sa_name,
        'policies': item.secrets | map(attribute='external_secret_name') | map('regex_replace', '^', item.namespace ~ '_') | list
      }] }}
  loop: "{{ _all_eso_integrations }}"
  loop_control:
    label: "{{ item.namespace }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# STAGE 5: Conflict check vault_policies / vault_roles vs extras
# -------------------------------------------------------------------------

- name: "[eso-merge] Collect base policy and role names"
  set_fact:
    _base_policy_names: "{{ (_derived_policies + vault_policies) | map(attribute='name') | list }}"
    _base_role_names: "{{ (_derived_roles + vault_roles) | map(attribute='name') | list }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Detect policy name conflicts with hosts-extra"
  set_fact:
    _policy_conflicts: "{{ (vault_policies_extra | default([])) | map(attribute='name') | list | intersect(_base_policy_names) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Detect role name conflicts with hosts-extra"
  set_fact:
    _role_conflicts: "{{ (vault_roles_extra | default([])) | map(attribute='name') | list | intersect(_base_role_names) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Fail on policy name conflicts"
  fail:
    msg: >-
      Conflict in vault_policies_extra (hosts-extra.yaml): names {{ _policy_conflicts }}
      already exist in derived policies or vault_policies.
      Rename them in hosts-extra.yaml.
  when: _policy_conflicts | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Fail on role name conflicts"
  fail:
    msg: >-
      Conflict in vault_roles_extra (hosts-extra.yaml): names {{ _role_conflicts }}
      already exist in derived roles or vault_roles.
      Rename them in hosts-extra.yaml.
  when: _role_conflicts | length > 0
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

# -------------------------------------------------------------------------
# STAGE 6: Produce vault_policies_final and vault_roles_final
# -------------------------------------------------------------------------

- name: "[eso-merge] Merge all policy and role sources into final lists"
  set_fact:
    vault_policies_final: "{{ _derived_policies + vault_policies + (vault_policies_extra | default([])) }}"
    vault_roles_final: "{{ _derived_roles + vault_roles + (vault_roles_extra | default([])) }}"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true

- name: "[eso-merge] Show merge summary"
  debug:
    msg:
      - "Merged integrations: vault={{ eso_vault_integration_vault_merged.secrets | length }} secrets, longhorn={{ eso_vault_integration_longhorn_merged.secrets | length }} secrets, gitlab={{ eso_vault_integration_gitlab_merged.secrets | length }} secrets, argocd={{ eso_vault_integration_argocd_merged.secrets | length }} secrets"
      - "Derived: {{ _derived_policies | length }} policies, {{ _derived_roles | length }} roles"
      - "Manual (vault_policies/vault_roles): {{ vault_policies | length }} policies, {{ vault_roles | length }} roles"
      - "Extra (hosts-extra.yaml): {{ (vault_policies_extra | default([])) | length }} policies, {{ (vault_roles_extra | default([])) | length }} roles"
      - "Final totals: {{ vault_policies_final | length }} policies, {{ vault_roles_final | length }} roles"
  delegate_to: "{{ master_manager_fact }}"
  run_once: true
