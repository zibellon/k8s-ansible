# =============================================================================
# Pre-check: validate target is the master manager (exactly one host)
# =============================================================================
# Shared tasks for validating playbook target
#
# Used by all *-install.yaml and *-sync.yaml playbooks
#
# Requires:
#   - Run with --limit <master_manager> (exactly one host)
#   - Target must be in 'managers' group
#   - Target must have is_master: true
# =============================================================================

- name: Fail if no limit specified
  fail:
    msg: "ERROR: --limit required. Use: ansible-playbook -i hosts.yaml <playbook> --limit <master_manager>"
  when: ansible_limit is not defined
  run_once: true

- name: Fail if more than one host targeted
  fail:
    msg: "ERROR: --limit must target exactly ONE host. Current targets: {{ ansible_play_hosts | join(', ') }}"
  when: ansible_play_hosts | length > 1
  run_once: true

- name: Fail if not a manager node
  fail:
    msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
  when: inventory_hostname not in groups['managers']

- name: Fail if not the master manager
  fail:
    msg: "ERROR: {{ inventory_hostname }} does not have is_master: true"
  when: not (is_master | default(false))

- name: Confirm target
  debug:
    msg: "Target: {{ inventory_hostname }} (master manager)"
