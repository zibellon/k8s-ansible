# =============================================================================
# Fast chart copy via archive
# Copies chart directory to remote server using tar archive for better performance
#
# Params:
#   - label_name: Label for task names (used in logs)
#   - chart_name: Name of the chart (used for archive filename and logs)
#   - chart_local_src: Local path to chart directory (with trailing /)
#   - chart_remote_dest: Remote destination path
# =============================================================================

- name: "[{{ label_name }}] Ensure remote charts directory exists"
  file:
    path: "{{ chart_remote_dest | dirname }}"
    state: directory
    mode: "0755"

- name: "[{{ label_name }}] Archive chart locally"
  archive:
    path: "{{ chart_local_src }}"
    dest: "{{ chart_local_src | dirname }}/{{ chart_name }}.tar.gz"
    format: gz
  delegate_to: localhost
  become: false

- name: "[{{ label_name }}] Remove old chart from remote"
  file:
    path: "{{ chart_remote_dest }}"
    state: absent

- name: "[{{ label_name }}] Create remote directory"
  file:
    path: "{{ chart_remote_dest }}"
    state: directory
    mode: "0755"

- name: "[{{ label_name }}] Copy archive to remote"
  copy:
    src: "{{ chart_local_src | dirname }}/{{ chart_name }}.tar.gz"
    dest: "{{ chart_remote_dest }}.tar.gz"

- name: "[{{ label_name }}] Unarchive on remote"
  unarchive:
    src: "{{ chart_remote_dest }}.tar.gz"
    dest: "{{ chart_remote_dest }}"
    remote_src: true

- name: "[{{ label_name }}] Cleanup remote archive"
  file:
    path: "{{ chart_remote_dest }}.tar.gz"
    state: absent

- name: "[{{ label_name }}] Cleanup local archive"
  file:
    path: "{{ chart_local_src | dirname }}/{{ chart_name }}.tar.gz"
    state: absent
  delegate_to: localhost
  become: false
