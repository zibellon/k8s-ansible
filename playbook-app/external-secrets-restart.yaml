# =============================================================================
# EXTERNAL SECRETS RESTART
# Restarts External Secrets Operator Deployments to apply configuration changes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-app/external-secrets-restart.yaml
# =============================================================================

- name: Restart External Secrets Operator
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[external-secrets-restart-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "external-secrets-restart-pre-check"

    # -------------------------------------------------------------------------
    # PRE-CHECK: Verify External Secrets is installed
    # -------------------------------------------------------------------------

    - name: "[external-secrets-restart] Check if External Secrets namespace exists"
      command: kubectl get namespace {{ external_secrets_namespace }}
      register: namespace_check
      changed_when: false
      failed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[external-secrets-restart] Fail if External Secrets namespace not found"
      fail:
        msg: "External Secrets namespace '{{ external_secrets_namespace }}' not found. Install External Secrets first."
      when: namespace_check.rc != 0
      run_once: true

    - name: "[external-secrets-restart] Show current External Secrets pods"
      command: kubectl get pods -n {{ external_secrets_namespace }} -o wide
      register: pods_before
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[external-secrets-restart] Display pods before restart"
      debug:
        var: pods_before.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # -------------------------------------------------------------------------
    # RESTART DEPLOYMENTS
    # -------------------------------------------------------------------------

    - name: "[external-secrets-restart] Restart External Secrets Deployments"
      command: kubectl rollout restart deployment/{{ item }} -n {{ external_secrets_namespace }}
      loop:
        - external-secrets
        - external-secrets-webhook
        - external-secrets-cert-controller
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # -------------------------------------------------------------------------
    # WAIT FOR ROLLOUTS TO COMPLETE
    # -------------------------------------------------------------------------

    - name: "[external-secrets-restart] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "external-secrets-restart"
        rollout_namespace: "{{ external_secrets_namespace }}"
        rollout_timeout: "{{ external_secrets_rollout_timeout }}"
        rollout_resources:
          - deployment/external-secrets
          - deployment/external-secrets-webhook
          - deployment/external-secrets-cert-controller

    # -------------------------------------------------------------------------
    # VERIFY RESTART
    # -------------------------------------------------------------------------

    - name: "[external-secrets-verify] Show External Secrets pods after restart"
      command: kubectl get pods -n {{ external_secrets_namespace }} -o wide
      register: pods_after
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[external-secrets-verify] Display pods after restart"
      debug:
        var: pods_after.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[external-secrets-verify] Restart completed"
      debug:
        msg: "External Secrets Operator restart complete"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
