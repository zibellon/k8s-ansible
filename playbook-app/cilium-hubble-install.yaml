# =============================================================================
# Install Cilium Hubble UI Ingress
# Steps:
#   1. cilium-hubble/pre: NetworkPolicies for Hubble UI Ingress
#   2. cilium-hubble/install: Certificate + Ingress for Hubble UI
#   3. cilium-hubble/post: No resources (README only)
# =============================================================================

---
- name: Install Cilium Hubble UI Ingress
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[cilium-hubble-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "cilium-hubble-install-pre-check"

    # =========================================================================
    # STEP 1: CILIUM-HUBBLE/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[cilium-hubble-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "cilium-hubble-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/cilium-hubble/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/cilium-hubble/pre"

    - name: "[cilium-hubble-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cilium-hubble/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cilium_namespace }}
          traefik:
            namespace: {{ traefik_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-hubble-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install cilium-hubble-pre {{ remote_charts_dir }}/cilium-hubble/pre
        --namespace {{ cilium_namespace }}
        --values {{ remote_charts_dir }}/cilium-hubble/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ cilium_hubble_helm_timeout | default('2m') }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: CILIUM-HUBBLE/INSTALL (Certificate + Ingress)
    # =========================================================================

    - name: "[cilium-hubble-install] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "cilium-hubble-install"
        chart_name: "install"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/cilium-hubble/install/"
        chart_remote_dest: "{{ remote_charts_dir }}/cilium-hubble/install"

    - name: "[cilium-hubble-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cilium-hubble/install/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cilium_namespace }}

          hubbleUi:
            domain: {{ cilium_hubble_ui_domain }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            ingressClass: {{ traefik_ingress_class }}
            entrypoint: {{ traefik_websecure_entrypoint }}
            secretName: {{ cilium_hubble_ui_https_secret_name }}
            vpnOnlyEnabled: {{ cilium_hubble_ui_vpn_only_enabled }}

          traefik:
            namespace: {{ traefik_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-hubble-install] Install or upgrade via Helm"
      command: >
        helm upgrade --install cilium-hubble {{ remote_charts_dir }}/cilium-hubble/install
        --namespace {{ cilium_namespace }}
        --values {{ remote_charts_dir }}/cilium-hubble/install/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cilium_hubble_helm_timeout | default('2m') }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 3: CILIUM-HUBBLE/POST (No resources)
    # =========================================================================

    - name: "[cilium-hubble-post] Skip - no post-install resources"
      debug:
        msg: "cilium-hubble/post: No resources to install"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[cilium-hubble-verify] Get Cilium Hubble Helm releases"
      command: helm list -n {{ cilium_namespace }} -f cilium-hubble
      register: helm_list
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-hubble-verify] Print Helm releases"
      debug:
        msg: "{{ helm_list.stdout_lines }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-hubble-verify] Installation complete"
      debug:
        msg: "cilium-hubble: OK (Hubble UI available at https://{{ cilium_hubble_ui_domain }})"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
