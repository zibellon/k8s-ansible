# =============================================================================
# Install Medik8s (Node Health Check + Self Node Remediation)
# Steps:
#   1. medik8s/pre: NetworkPolicies via Helm
#   2. medik8s/install: OLM Subscriptions (created by Ansible)
#   3. medik8s/post: Config manifests (created by Ansible)
# Requires: OLM v0 installed (olm-v0-install.yaml)
# =============================================================================

---
- name: Install medik8s
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[medik8s-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "medik8s-install-pre-check"

    # =========================================================================
    # STEP 1: MEDIK8S/PRE (NetworkPolicies via Helm)
    # =========================================================================

    - name: "[medik8s-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "medik8s-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/medik8s/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/medik8s/pre"

    - name: "[medik8s-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ olm_operators_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install medik8s-pre {{ remote_charts_dir }}/medik8s/pre
        --namespace {{ olm_operators_namespace }}
        --values {{ remote_charts_dir }}/medik8s/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --timeout {{ medik8s_config_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: MEDIK8S/INSTALL (OLM Subscriptions)
    # =========================================================================

    - name: "[medik8s-install] Ensure medik8s manifests directory exists"
      file:
        path: "{{ remote_charts_dir }}/medik8s/install"
        state: directory
        mode: "0755"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Create Node Health Check Subscription manifest"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/install/subscription-nhc.yaml"
        mode: "0644"
        content: |
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: node-healthcheck-operator
            namespace: {{ olm_operators_namespace }}
          spec:
            channel: stable
            name: node-healthcheck-operator
            source: operatorhubio-catalog
            sourceNamespace: {{ olm_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Create Self Node Remediation Subscription manifest"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/install/subscription-snr.yaml"
        mode: "0644"
        content: |
          apiVersion: operators.coreos.com/v1alpha1
          kind: Subscription
          metadata:
            name: self-node-remediation
            namespace: {{ olm_operators_namespace }}
          spec:
            channel: stable
            name: self-node-remediation
            source: operatorhubio-catalog
            sourceNamespace: {{ olm_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Apply Node Health Check Subscription"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/install/subscription-nhc.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Apply Self Node Remediation Subscription"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/install/subscription-snr.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Wait for Self Node Remediation CSV to be ready"
      command: >
        kubectl get csv -n {{ olm_operators_namespace }}
        -l operators.coreos.com/self-node-remediation.{{ olm_operators_namespace }}=
        -o jsonpath='{.items[0].status.phase}'
      register: snr_csv_status
      until: snr_csv_status.stdout == "Succeeded"
      retries: 60
      delay: 5
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Wait for Node Health Check CSV to be ready"
      command: >
        kubectl get csv -n {{ olm_operators_namespace }}
        -l operators.coreos.com/node-healthcheck-operator.{{ olm_operators_namespace }}=
        -o jsonpath='{.items[0].status.phase}'
      register: nhc_csv_status
      until: nhc_csv_status.stdout == "Succeeded"
      retries: 60
      delay: 5
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-install] Show CSV status"
      debug:
        msg: "SNR CSV: {{ snr_csv_status.stdout }}, NHC CSV: {{ nhc_csv_status.stdout }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 3: MEDIK8S/POST (Config manifests)
    # =========================================================================

    - name: "[medik8s-post] Ensure medik8s post directory exists"
      file:
        path: "{{ remote_charts_dir }}/medik8s/post"
        state: directory
        mode: "0755"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Create SelfNodeRemediationConfig manifest"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/post/self-node-remediation-config.yaml"
        mode: "0644"
        content: |
          apiVersion: self-node-remediation.medik8s.io/v1alpha1
          kind: SelfNodeRemediationConfig
          metadata:
            name: self-node-remediation-config
            namespace: {{ olm_operators_namespace }}
          spec:
            watchdogFilePath: "{{ medik8s_watchdog_file_path }}"
            apiCheckInterval: "{{ medik8s_api_check_interval }}"
            apiServerTimeout: "{{ medik8s_api_server_timeout }}"
            maxApiErrorThreshold: {{ medik8s_max_api_error_threshold }}
            peerDialTimeout: "{{ medik8s_peer_dial_timeout }}"
            peerRequestTimeout: "{{ medik8s_peer_request_timeout }}"
            peerUpdateInterval: "{{ medik8s_peer_update_interval }}"
            safeTimeToAssumeNodeRebootedSeconds: {{ medik8s_safe_time_to_assume_rebooted }}
            isSoftwareRebootEnabled: true
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Create SelfNodeRemediationTemplate manifest"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/post/self-node-remediation-template.yaml"
        mode: "0644"
        content: |
          apiVersion: self-node-remediation.medik8s.io/v1alpha1
          kind: SelfNodeRemediationTemplate
          metadata:
            name: self-node-remediation-template
            namespace: {{ olm_operators_namespace }}
          spec:
            template:
              spec:
                remediationStrategy: {{ medik8s_remediation_strategy }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Create NodeHealthCheck manifest for workers"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/post/nhc-workers.yaml"
        mode: "0644"
        content: |
          apiVersion: remediation.medik8s.io/v1alpha1
          kind: NodeHealthCheck
          metadata:
            name: nhc-workers
          spec:
            # Select worker nodes only (exclude control-plane/master)
            selector:
              matchExpressions:
                - key: node-role.kubernetes.io/worker
                  operator: Exists
            minHealthy: "{{ medik8s_nhc_workers_min_healthy }}"
            unhealthyConditions:
              - type: Ready
                status: "False"
                duration: {{ medik8s_nhc_unhealthy_duration }}
              - type: Ready
                status: Unknown
                duration: {{ medik8s_nhc_unhealthy_duration }}
            remediationTemplate:
              apiVersion: self-node-remediation.medik8s.io/v1alpha1
              kind: SelfNodeRemediationTemplate
              name: self-node-remediation-template
              namespace: {{ olm_operators_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Create NodeHealthCheck manifest for control-plane"
      copy:
        dest: "{{ remote_charts_dir }}/medik8s/post/nhc-control-plane.yaml"
        mode: "0644"
        content: |
          apiVersion: remediation.medik8s.io/v1alpha1
          kind: NodeHealthCheck
          metadata:
            name: nhc-control-plane
          spec:
            # Select control-plane nodes only
            selector:
              matchExpressions:
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
            minHealthy: "{{ medik8s_nhc_control_plane_min_healthy }}"
            unhealthyConditions:
              - type: Ready
                status: "False"
                duration: {{ medik8s_nhc_unhealthy_duration }}
              - type: Ready
                status: Unknown
                duration: {{ medik8s_nhc_unhealthy_duration }}
            remediationTemplate:
              apiVersion: self-node-remediation.medik8s.io/v1alpha1
              kind: SelfNodeRemediationTemplate
              name: self-node-remediation-template
              namespace: {{ olm_operators_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Apply SelfNodeRemediationConfig"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/post/self-node-remediation-config.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Apply SelfNodeRemediationTemplate"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/post/self-node-remediation-template.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Apply NodeHealthCheck for workers"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/post/nhc-workers.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-post] Apply NodeHealthCheck for control-plane"
      command: kubectl apply -f {{ remote_charts_dir }}/medik8s/post/nhc-control-plane.yaml
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[medik8s-verify] List installed CSVs"
      command: kubectl get csv -n {{ olm_operators_namespace }}
      register: csv_list
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Show installed CSVs"
      debug:
        var: csv_list.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Check SelfNodeRemediationConfig"
      command: kubectl get selfnoderemediationconfig -n {{ olm_operators_namespace }}
      register: snr_config_list
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Show SelfNodeRemediationConfig"
      debug:
        var: snr_config_list.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Check NodeHealthCheck CR"
      command: kubectl get nodehealthcheck -A
      register: nhc_list
      changed_when: false
      failed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Show NodeHealthCheck CRs"
      debug:
        var: nhc_list.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[medik8s-verify] Installation complete"
      debug:
        msg: "medik8s-pre + medik8s-install + medik8s-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
