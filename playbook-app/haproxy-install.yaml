# =============================================================================
# Install HAProxy via Helm
# Steps:
#   1. haproxy/pre: NetworkPolicies for haproxy namespace
#   2. Official haproxytech/kubernetes-ingress chart
#   3. haproxy/post: Global + Defaults configuration
# =============================================================================

---
- name: Install HAProxy via Helm
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[haproxy-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "haproxy-install-pre-check"

    # =========================================================================
    # STEP 1: HAPROXY/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[haproxy-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "haproxy-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/haproxy/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/haproxy/pre"

    - name: "[haproxy-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ haproxy_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[haproxy-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install haproxy-pre {{ remote_charts_dir }}/haproxy/pre
        --namespace {{ haproxy_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/haproxy/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: OFFICIAL HAPROXYTECH/KUBERNETES-INGRESS
    # =========================================================================

    - name: "[haproxy-install] Add Helm repository"
      include_tasks: tasks/tasks-add-helm-repo.yaml
      vars:
        label_name: "haproxy-install"
        helm_repo_name: "haproxytech"
        helm_repo_url: "https://haproxytech.github.io/helm-charts"

    - name: "[haproxy-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/values-override.yaml"
        mode: "0644"
        content: |
          fullnameOverride: {{ haproxy_daemonset_name }}
          controller:
            kind: DaemonSet
            ingressClassResource:
              name: {{ haproxy_ingress_class }}
            ingressClass: {{ haproxy_ingress_class }}
            defaultTLSSecret:
              enabled: false
            logging:
              level: info
              traffic:
                address: stdout
                format: raw
                facility: daemon
            service:
              enabled: true
              type: ClusterIP
              enablePorts:
                http: false
                https: false
                quic: false
          serviceAccount:
            create: true
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[haproxy-install] Install or upgrade HAProxy via Helm"
      command: >
        helm upgrade --install haproxy-ingress haproxytech/kubernetes-ingress
        --namespace {{ haproxy_namespace }}
        --version {{ haproxy_chart_version }}
        --values {{ remote_charts_dir }}/haproxy/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[haproxy-install] Wait for CRDs"
      include_tasks: tasks/tasks-wait-crds.yaml
      vars:
        label_name: "haproxy-install"
        crds_list:
          - crd/backends.ingress.v1.haproxy.org
          - crd/defaults.ingress.v1.haproxy.org
          - crd/globals.ingress.v1.haproxy.org
          - crd/tcps.ingress.v1.haproxy.org

    - name: "[haproxy-install] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "haproxy-install"
        rollout_namespace: "{{ haproxy_namespace }}"
        rollout_timeout: "{{ haproxy_rollout_timeout }}"
        rollout_resources:
          - daemonset/{{ haproxy_daemonset_name }}

    # =========================================================================
    # STEP 3: HAPROXY/POST (Global + Defaults config)
    # =========================================================================

    - name: "[haproxy-post] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "haproxy-post"
        chart_name: "post"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/haproxy/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/haproxy/post"

    - name: "[haproxy-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/haproxy/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ haproxy_namespace }}
          ingressClass: {{ haproxy_ingress_class }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[haproxy-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install haproxy-post {{ remote_charts_dir }}/haproxy/post
        --namespace {{ haproxy_namespace }}
        --values {{ remote_charts_dir }}/haproxy/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ haproxy_config_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[haproxy-verify] Verify Helm releases"
      include_tasks: tasks/tasks-verify-helm.yaml
      vars:
        helm_namespace: "{{ haproxy_namespace }}"
        label_name: "haproxy-verify"

    - name: "[haproxy-verify] Installation complete"
      debug:
        msg: "haproxy-pre + haproxy-ingress + haproxy-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
