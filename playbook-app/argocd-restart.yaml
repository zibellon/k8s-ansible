# =============================================================================
# ARGOCD RESTART
# Restarts all ArgoCD components to apply ConfigMap changes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-app/argocd-restart.yaml
#
# ArgoCD does not automatically reload ConfigMaps.
# This playbook performs graceful rolling restart of all components.
# =============================================================================

- name: Restart ArgoCD components
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[argocd-restart-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "argocd-restart-pre-check"

    # -------------------------------------------------------------------------
    # PRE-CHECK: Verify ArgoCD is installed
    # -------------------------------------------------------------------------

    - name: "[argocd-restart] Check if ArgoCD namespace exists"
      command: kubectl get namespace {{ argocd_namespace }}
      register: namespace_check
      changed_when: false
      failed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[argocd-restart] Fail if ArgoCD is not installed"
      fail:
        msg: "ArgoCD namespace '{{ argocd_namespace }}' not found. Install ArgoCD first."
      when: namespace_check.rc != 0
      run_once: true

    - name: "[argocd-restart] Show current ArgoCD pods"
      command: kubectl get pods -n {{ argocd_namespace }}
      register: pods_before
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[argocd-restart] Display pods before restart"
      debug:
        var: pods_before.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # -------------------------------------------------------------------------
    # RESTART STATEFULSET
    # -------------------------------------------------------------------------

    - name: "[argocd-restart] Restart ArgoCD StatefulSet (application-controller)"
      command: kubectl rollout restart statefulset/argocd-application-controller -n {{ argocd_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # -------------------------------------------------------------------------
    # RESTART DEPLOYMENTS
    # -------------------------------------------------------------------------

    - name: "[argocd-restart] Restart ArgoCD Deployments"
      command: kubectl rollout restart deployment/{{ item }} -n {{ argocd_namespace }}
      loop:
        - argocd-applicationset-controller
        - argocd-dex-server
        - argocd-notifications-controller
        - argocd-redis
        - argocd-repo-server
        - argocd-server
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # -------------------------------------------------------------------------
    # WAIT FOR ROLLOUTS TO COMPLETE
    # -------------------------------------------------------------------------

    - name: "[argocd-restart] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "argocd-restart"
        rollout_namespace: "{{ argocd_namespace }}"
        rollout_timeout: "{{ argocd_components_rollout_timeout }}"
        rollout_resources:
          - statefulset/argocd-application-controller
          - deployment/argocd-applicationset-controller
          - deployment/argocd-dex-server
          - deployment/argocd-notifications-controller
          - deployment/argocd-redis
          - deployment/argocd-repo-server
          - deployment/argocd-server

    # -------------------------------------------------------------------------
    # VERIFY RESTART
    # -------------------------------------------------------------------------

    - name: "[argocd-verify] Show ArgoCD pods after restart"
      command: kubectl get pods -n {{ argocd_namespace }}
      register: pods_after
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[argocd-verify] Display pods after restart"
      debug:
        var: pods_after.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[argocd-verify] Restart completed"
      debug:
        msg:
          - "=== ArgoCD Restart Complete ==="
          - "All components have been restarted and are ready."
          - "ConfigMap changes are now applied."
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
