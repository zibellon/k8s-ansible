# =============================================================================
# Vault Projects Sync
# =============================================================================
# Synchronizes policies and roles from hosts.yaml (+ hosts-extra.yaml) to Vault
#
# Policy/role sources (merged in order, conflict on duplicate names):
#   1. eso_vault_integration_XXXXX — auto-derived from secrets[] (per-secret policy)
#   2. vault_policies / vault_roles — manual overrides in hosts.yaml
#   3. vault_policies_extra / vault_roles_extra — from hosts-extra.yaml (gitignored)
#
# Usage:
#   ansible-playbook -i hosts.yaml -i hosts-extra.yaml playbook-app/vault-policy-sync.yaml
#
# Without hosts-extra.yaml (_extra variables default to empty in hosts.yaml):
#   ansible-playbook -i hosts.yaml playbook-app/vault-policy-sync.yaml
# =============================================================================

---
- name: Sync Vault policies and roles
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[vault-policy-sync-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "vault-policy-sync-pre-check"

    # =========================================================================
    # STEP 1: CHECK VAULT IS READY
    # =========================================================================

    - name: "[vault-check] Verify Vault is unsealed"
      shell: |
        kubectl exec -n {{ vault_namespace }} vault-0 -- vault status -format=json | jq -r '.sealed'
      register: vault_sealed_check
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[vault-check] Fail if Vault is sealed"
      fail:
        msg: "Vault is sealed. Please unseal Vault first."
      when: vault_sealed_check.stdout == "true"
      run_once: true

    - name: "[vault-check] Vault is ready"
      debug:
        msg: "Vault is unsealed and ready"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: MERGE ESO INTEGRATIONS + SYNC POLICIES AND ROLES
    # =========================================================================

    - name: "[vault-policy-sync] Merge ESO integrations and derive policies/roles"
      include_tasks: tasks/tasks-eso-merge.yaml

    - name: "[vault-policy-sync] Sync policies and roles to Vault"
      include_tasks: tasks/tasks-vault-policy-sync.yaml

    # =========================================================================
    # STEP 3: VERIFICATION
    # =========================================================================

    - name: "[verify] List all policies in Vault"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault policy list
      register: vault_policies_list
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[verify] Show policies"
      debug:
        var: vault_policies_list.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[verify] List all roles in Vault"
      command: kubectl exec -n {{ vault_namespace }} vault-0 -- vault list auth/kubernetes/role
      register: vault_roles_list
      changed_when: false
      failed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[verify] Show roles"
      debug:
        var: vault_roles_list.stdout_lines
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # SUMMARY
    # =========================================================================

    - name: "[summary] Policy sync completed"
      debug:
        msg:
          - "=============================================="
          - "VAULT POLICY SYNC COMPLETE"
          - "=============================================="
          - "Sources:"
          - "  Derived from integrations: {{ _derived_policies | length }} policies, {{ _derived_roles | length }} roles"
          - "  vault_policies/roles (hosts.yaml): {{ vault_policies | length }} policies, {{ vault_roles | length }} roles"
          - "  vault_policies_extra/roles_extra (hosts-extra.yaml): {{ (vault_policies_extra | default([])) | length }} policies, {{ (vault_roles_extra | default([])) | length }} roles"
          - "Total synced: {{ vault_policies_final | length }} policies, {{ vault_roles_final | length }} roles"
          - "=============================================="
          - ""
          - "Policies:"
          - "{% for p in vault_policies_final %}  - {{ p.name }}\n{% endfor %}"
          - ""
          - "Roles:"
          - "{% for r in vault_roles_final %}  - {{ r.name }} -> {{ r.sa_name }} ({{ r.namespace }})\n{% endfor %}"
          - "=============================================="
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
