# =============================================================================
# CILIUM RESTART
# Restarts all Cilium components to apply ConfigMap/configuration changes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-app/cilium-restart.yaml
#
# Cilium does not automatically reload ConfigMaps.
# This playbook performs graceful rolling restart of all components:
#   - DaemonSets: cilium, cilium-envoy
#   - Deployments: cilium-operator, hubble-relay, hubble-ui
# =============================================================================

- name: Restart Cilium components
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # -------------------------------------------------------------------------
    # PRE-CHECK: Verify Cilium is installed
    # -------------------------------------------------------------------------

    - name: "[cilium-restart] Check if Cilium namespace exists"
      command: kubectl get namespace {{ cilium_namespace }}
      register: namespace_check
      changed_when: false
      failed_when: false

    - name: "[cilium-restart] Fail if Cilium namespace not found"
      fail:
        msg: "Cilium namespace '{{ cilium_namespace }}' not found. Install Cilium first."
      when: namespace_check.rc != 0

    - name: "[cilium-restart] Show current Cilium pods"
      command: kubectl get pods -n {{ cilium_namespace }} -l app.kubernetes.io/part-of=cilium -o wide
      register: pods_before
      changed_when: false

    - name: "[cilium-restart] Display pods before restart"
      debug:
        var: pods_before.stdout_lines

    # -------------------------------------------------------------------------
    # RESTART DAEMONSETS
    # -------------------------------------------------------------------------

    - name: "[cilium-restart] Restart Cilium DaemonSets"
      command: kubectl rollout restart daemonset/{{ item }} -n {{ cilium_namespace }}
      loop:
        - cilium
        - cilium-envoy

    # -------------------------------------------------------------------------
    # RESTART DEPLOYMENTS
    # -------------------------------------------------------------------------

    - name: "[cilium-restart] Restart Cilium Deployments"
      command: kubectl rollout restart deployment/{{ item }} -n {{ cilium_namespace }}
      loop:
        - cilium-operator
        - hubble-relay
        - hubble-ui

    # -------------------------------------------------------------------------
    # WAIT FOR ROLLOUTS TO COMPLETE
    # -------------------------------------------------------------------------

    - name: "[cilium-restart] Wait for DaemonSet rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "cilium-restart"
        rollout_namespace: "{{ cilium_namespace }}"
        rollout_timeout: "{{ cilium_daemonset_rollout_timeout }}"
        rollout_resources:
          - daemonset/cilium
          - daemonset/cilium-envoy

    - name: "[cilium-restart] Wait for Deployment rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "cilium-restart"
        rollout_namespace: "{{ cilium_namespace }}"
        rollout_timeout: "{{ cilium_deployment_rollout_timeout }}"
        rollout_resources:
          - deployment/cilium-operator
          - deployment/hubble-relay
          - deployment/hubble-ui

    # -------------------------------------------------------------------------
    # VERIFY RESTART
    # -------------------------------------------------------------------------

    - name: "[cilium-verify] Show Cilium pods after restart"
      command: kubectl get pods -n {{ cilium_namespace }} -l app.kubernetes.io/part-of=cilium -o wide
      register: pods_after
      changed_when: false

    - name: "[cilium-verify] Display pods after restart"
      debug:
        var: pods_after.stdout_lines

    - name: "[cilium-verify] Restart completed"
      debug:
        msg:
          - "=== Cilium Restart Complete ==="
          - "All components have been restarted and are ready."
          - "ConfigMap changes are now applied."

