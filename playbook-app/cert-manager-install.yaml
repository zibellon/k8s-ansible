# =============================================================================
# Install cert-manager via Helm
# Steps:
#   1. cert-manager/pre: NetworkPolicies for cert-manager namespace
#   2. Official cert-manager Helm chart (jetstack/cert-manager)
#   3. cert-manager/post: ClusterIssuer for Let's Encrypt
# =============================================================================

---
- name: Install cert-manager
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[cert-manager-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "cert-manager-install-pre-check"

    # =========================================================================
    # STEP 1: CERT-MANAGER/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[cert-manager-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "cert-manager-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/cert-manager/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/cert-manager/pre"

    - name: "[cert-manager-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cert-manager/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ cert_manager_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install cert-manager-pre {{ remote_charts_dir }}/cert-manager/pre
        --namespace {{ cert_manager_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/cert-manager/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cert_manager_config_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: OFFICIAL CERT-MANAGER HELM
    # =========================================================================

    - name: "[cert-manager-install] Add Helm repository"
      include_tasks: tasks/tasks-add-helm-repo.yaml
      vars:
        label_name: "cert-manager-install"
        helm_repo_name: "jetstack"
        helm_repo_url: "https://charts.jetstack.io"

    - name: "[cert-manager-install] Ensure charts directory exists"
      file:
        path: "{{ remote_charts_dir }}/cert-manager/install"
        state: directory
        mode: "0755"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-install] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cert-manager/install/values-override.yaml"
        mode: "0644"
        content: |
          crds:
            enabled: true
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-install] Install or upgrade via Helm"
      command: >
        helm upgrade --install cert-manager jetstack/cert-manager
        --namespace {{ cert_manager_namespace }}
        --version v{{ cert_manager_version }}
        --values {{ remote_charts_dir }}/cert-manager/install/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cert_manager_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # WAIT FOR CERT-MANAGER CRDs
    # =========================================================================

    - name: "[cert-manager-install] Wait for CRDs"
      include_tasks: tasks/tasks-wait-crds.yaml
      vars:
        label_name: "cert-manager-install"
        crds_list:
          - crd/certificaterequests.cert-manager.io
          - crd/certificates.cert-manager.io
          - crd/challenges.acme.cert-manager.io
          - crd/clusterissuers.cert-manager.io
          - crd/issuers.cert-manager.io
          - crd/orders.acme.cert-manager.io

    # =========================================================================
    # WAIT FOR CERT-MANAGER PODS
    # =========================================================================

    - name: "[cert-manager-install] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "cert-manager-install"
        rollout_namespace: "{{ cert_manager_namespace }}"
        rollout_timeout: "{{ cert_manager_rollout_timeout }}"
        rollout_resources:
          - deployment/cert-manager
          - deployment/cert-manager-cainjector
          - deployment/cert-manager-webhook

    # =========================================================================
    # STEP 3: CERT-MANAGER/POST (ClusterIssuer)
    # =========================================================================

    - name: "[cert-manager-post] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "cert-manager-post"
        chart_name: "post"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/cert-manager/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/cert-manager/post"

    - name: "[cert-manager-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/cert-manager/post/values-override.yaml"
        mode: "0644"
        content: |
          clusterIssuer:
            name: {{ cert_manager_cluster_issuer }}
            email: {{ cert_manager_acme_email }}
            ingressClass: {{ traefik_ingress_class }}
            traefikEntrypoint: {{ traefik_web_entrypoint }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install cert-manager-post {{ remote_charts_dir }}/cert-manager/post
        --namespace {{ cert_manager_namespace }}
        --values {{ remote_charts_dir }}/cert-manager/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ cert_manager_config_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[cert-manager-verify] Verify Helm releases"
      include_tasks: tasks/tasks-verify-helm.yaml
      vars:
        helm_namespace: "{{ cert_manager_namespace }}"
        label_name: "cert-manager-verify"

    - name: "[cert-manager-verify] Get cert-manager pods status"
      command: kubectl get pods -n {{ cert_manager_namespace }} -o wide
      register: certmanager_pods
      changed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-verify] Print cert-manager pods status"
      debug:
        msg: "{{ certmanager_pods.stdout_lines }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cert-manager-verify] Installation complete"
      debug:
        msg: "cert-manager-pre + cert-manager + cert-manager-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
