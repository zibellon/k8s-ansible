# =============================================================================
# TRAEFIK RESTART
# Restarts Traefik DaemonSet to apply configuration changes
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-app/traefik-restart.yaml
# =============================================================================

- name: Restart Traefik
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml

    # -------------------------------------------------------------------------
    # PRE-CHECK: Verify Traefik is installed
    # -------------------------------------------------------------------------

    - name: "[traefik-restart] Check if Traefik namespace exists"
      command: kubectl get namespace {{ traefik_namespace }}
      register: namespace_check
      changed_when: false
      failed_when: false

    - name: "[traefik-restart] Fail if Traefik namespace not found"
      fail:
        msg: "Traefik namespace '{{ traefik_namespace }}' not found. Install Traefik first."
      when: namespace_check.rc != 0

    - name: "[traefik-restart] Show current Traefik pods"
      command: kubectl get pods -n {{ traefik_namespace }} -o wide
      register: pods_before
      changed_when: false

    - name: "[traefik-restart] Display pods before restart"
      debug:
        var: pods_before.stdout_lines

    # -------------------------------------------------------------------------
    # RESTART DAEMONSET
    # -------------------------------------------------------------------------

    - name: "[traefik-restart] Restart Traefik DaemonSet"
      command: kubectl rollout restart daemonset/{{ traefik_daemonset_name }} -n {{ traefik_namespace }}

    # -------------------------------------------------------------------------
    # WAIT FOR ROLLOUT TO COMPLETE
    # -------------------------------------------------------------------------

    - name: "[traefik-restart] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "traefik"
        rollout_namespace: "{{ traefik_namespace }}"
        rollout_timeout: "{{ traefik_rollout_timeout }}"
        rollout_resources:
          - daemonset/{{ traefik_daemonset_name }}

    # -------------------------------------------------------------------------
    # VERIFY RESTART
    # -------------------------------------------------------------------------

    - name: "[traefik-verify] Show Traefik pods after restart"
      command: kubectl get pods -n {{ traefik_namespace }} -o wide
      register: pods_after
      changed_when: false

    - name: "[traefik-verify] Display pods after restart"
      debug:
        var: pods_after.stdout_lines

    - name: "[traefik-verify] Restart completed"
      debug:
        msg: "Traefik DaemonSet restart complete"
