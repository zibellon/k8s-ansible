# =============================================================================
# Install/Update Cilium POST configuration (CiliumClusterwideNetworkPolicy)
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-app/cilium-post-install.yaml
#
# This playbook only installs the post chart (charts/cilium/post):
#   - CiliumClusterwideNetworkPolicy for host protection
#
# Use this when you need to update network policies without
# reinstalling Cilium itself (e.g. after adding/removing nodes).
#
# For full Cilium installation use: cilium-install.yaml
# =============================================================================

---
- name: Install/Update Cilium POST configuration
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[cilium-post-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "cilium-post-install-pre-check"

    # =========================================================================
    # CILIUM-POST (CiliumClusterwideNetworkPolicy)
    # =========================================================================

    - name: "[cilium-post-install] Install cilium-post"
      include_tasks: tasks/tasks-cilium-post-install.yaml

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[cilium-post-verify] Verify Helm releases"
      include_tasks: tasks/tasks-verify-helm.yaml
      vars:
        helm_namespace: "{{ cilium_namespace }}"
        label_name: "cilium-post-verify"

    - name: "[cilium-post-verify] Get CiliumClusterwideNetworkPolicy status"
      command: kubectl get ciliumclusterwidenetworkpolicies -n {{ cilium_namespace }}
      register: ccnp_status
      changed_when: false
      failed_when: false
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-post-verify] Print CiliumClusterwideNetworkPolicy status"
      debug:
        msg: "{{ ccnp_status.stdout_lines }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[cilium-post-verify] Installation complete"
      debug:
        msg: "cilium-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
