# =============================================================================
# EXTERNAL SECRETS FOR ARGOCD (from Vault)
# =============================================================================

{{- range $secret := .Values.eso.secrets }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $secret.external_secret_name }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: {{ $secret.refresh_interval }}
  secretStoreRef:
    kind: SecretStore
    name: {{ $.Values.eso.secretStoreName }}
{{- if eq $secret.type "git_ops_repo_creds" }}
  # SPECIAL: git_ops_repo_creds — SSH key with ArgoCD repo-creds label + GitLab internal URL from Vault
  target:
    name: {{ $secret.target_secret_name }}
    template:
      engineVersion: v2
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repo-creds
      data:
        type: git
        url: "{{ "{{" }} .repo_url {{ "}}" }}"
        sshPrivateKey: "{{ "{{" }} .ssh_private_key {{ "}}" }}"
  data:
    - secretKey: ssh_private_key
      remoteRef:
        key: "{{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}"
        property: ssh_private_key
    - secretKey: repo_url
      remoteRef:
        key: "{{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}"
        property: repo_url
{{- else if eq $secret.type "repo_creds" }}
  # SPECIAL: repo_creds — SSH key with ArgoCD repo-creds label (no specific URL)
  target:
    name: {{ $secret.target_secret_name }}
    template:
      engineVersion: v2
      metadata:
        labels:
          argocd.argoproj.io/secret-type: repo-creds
      data:
        type: git
        url: "{{ "{{" }} .repo_url {{ "}}" }}"
        sshPrivateKey: "{{ "{{" }} .ssh_private_key {{ "}}" }}"
  data:
    - secretKey: ssh_private_key
      remoteRef:
        key: "{{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}"
        property: ssh_private_key
    - secretKey: repo_url
      remoteRef:
        key: "{{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}"
        property: repo_url
{{- else if eq $secret.type "argocd_root" }}
  target:
    name: {{ $secret.target_secret_name }}
  dataFrom:
    - extract:
        key: {{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}
{{- else }}
  target:
    name: {{ $secret.target_secret_name }}
  dataFrom:
    - extract:
        key: {{ $.Values.eso.kvEnginePath }}/data{{ $secret.vault_path }}
{{- end }}
{{- end }}
