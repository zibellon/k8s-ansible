# =============================================================================
# EXTERNAL SECRETS FOR GITLAB (from Vault)
# =============================================================================

{{- range $secret := .Values.gitlabEso.secrets }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $secret.external_secret_name }}
  namespace: {{ $.Values.namespace }}
spec:
  refreshInterval: {{ $secret.refresh_interval }}
  secretStoreRef:
    kind: SecretStore
    name: {{ $.Values.gitlabEso.secretStoreName }}
{{- if eq $secret.type "gitlab_registry_minio_connection" }}
  # ==========================================================================
  # SPECIAL HANDLING: gitlab_registry_minio_connection uses ESO template to generate
  # registry storage config in GitLab-specific format.
  # ==========================================================================
  target:
    name: {{ $secret.target_secret_name }}
    template:
      engineVersion: v2
      data:
        config: |
          s3:
            bucket: registry
            accesskey: {{ "{{" }} .access_key {{ "}}" }}
            secretkey: {{ "{{" }} .secret_key {{ "}}" }}
            regionendpoint: {{ $.Values.minio.s3Endpoint }}
            region: {{ $.Values.minio.s3Region }}
            v4auth: true
  data:
    - secretKey: access_key
      remoteRef:
        key: {{ $.Values.gitlabEso.kvEnginePath }}/data{{ $secret.vault_path }}
        property: access_key
    - secretKey: secret_key
      remoteRef:
        key: {{ $.Values.gitlabEso.kvEnginePath }}/data{{ $secret.vault_path }}
        property: secret_key
{{- else if eq $secret.type "gitlab_minio_connection" }}
  # ==========================================================================
  # SPECIAL HANDLING: gitlab_minio_connection uses ESO template to generate
  # s3_connection YAML from access_key/secret_key stored in Vault.
  # Static S3 params (endpoint, region) come from values.yaml.
  # ==========================================================================
  target:
    name: {{ $secret.target_secret_name }}
    template:
      engineVersion: v2
      data:
        connection: |
          provider: AWS
          region: {{ $.Values.minio.s3Region }}
          endpoint: {{ $.Values.minio.s3Endpoint }}
          path_style: {{ $.Values.minio.s3PathStyle }}
          aws_access_key_id: {{ "{{" }} .access_key {{ "}}" }}
          aws_secret_access_key: {{ "{{" }} .secret_key {{ "}}" }}
  data:
    - secretKey: access_key
      remoteRef:
        key: {{ $.Values.gitlabEso.kvEnginePath }}/data{{ $secret.vault_path }}
        property: access_key
    - secretKey: secret_key
      remoteRef:
        key: {{ $.Values.gitlabEso.kvEnginePath }}/data{{ $secret.vault_path }}
        property: secret_key
{{- else }}
  target:
    name: {{ $secret.target_secret_name }}
  dataFrom:
    - extract:
        key: {{ $.Values.gitlabEso.kvEnginePath }}/data{{ $secret.vault_path }}
{{- end }}
{{- end }}
