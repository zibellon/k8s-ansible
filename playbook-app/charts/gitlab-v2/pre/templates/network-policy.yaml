# =============================================================================
# NETWORK POLICIES FOR GITLAB V2
# =============================================================================

# Allow traffic from Traefik to GitLab services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-allow-traefik-to-gitlab-v2
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.traefik.namespace }}

---
# Allow traffic from HAProxy (SSH)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-allow-haproxy-to-gitlab-v2
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.haproxy.namespace }}

---
# Allow traffic from External Secrets Operator
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-allow-eso-to-gitlab-v2
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.externalSecrets.namespace }}

---
# Allow internal traffic within namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: np-allow-internal-gitlab-v2
  namespace: {{ .Values.namespace }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector: {}
