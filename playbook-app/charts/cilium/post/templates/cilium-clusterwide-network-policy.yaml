# =============================================================================
# CILIUM HOST FIREWALL - Base policy for all nodes
# Requires Cilium CRDs to be installed first
# =============================================================================

apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: host-firewall-base
spec:
  nodeSelector:
    matchLabels: {}

  enableDefaultDeny:
    ingress: true
    egress: true

  ingress:
    # =========================================================================
    # Cluster internal traffic
    # =========================================================================
    - fromEntities:
        - cluster # All pods and nodes in the cluster
        - host # Localhost (same node)
        - health # Cilium health endpoints
        - remote-node # Other nodes in the cluster (explicit)

    # =========================================================================
    # SSH from external
    # =========================================================================
    - fromEntities:
        - world
      toPorts:
        - ports:
            - port: "22"
              protocol: TCP

    # =========================================================================
    # ICMP for debugging
    # =========================================================================
    - fromEntities:
        - world
      icmps:
        - fields:
            - type: 8

    # =========================================================================
    # Allow incoming traffic from known cluster node IPs (for node join)
    # =========================================================================
    - fromCIDR: {{ .Values.nodeIps | toJson }}

  egress:
    # =========================================================================
    # Cluster internal traffic (free)
    # =========================================================================
    - toEntities:
        - cluster # All pods and nodes in the cluster
        - host # Localhost (same node)
        - health # Cilium health endpoints
        - remote-node # Other nodes in the cluster (explicit)

    # =========================================================================
    # External traffic (HTTP, HTTPS, SSH, DNS, Mail)
    # =========================================================================
    - toEntities:
        - world
      toPorts:
        - ports:
            # Web
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            # SSH
            - port: "22"
              protocol: TCP
            # DNS
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
            # NTP (time sync)
            - port: "123"
              protocol: UDP

    - toEntities:
        - world
      toPorts:
        - ports:
            # SMTP
            - port: "25"
              protocol: TCP
            - port: "465"
              protocol: TCP
            - port: "587"
              protocol: TCP
            # IMAP
            - port: "143"
              protocol: TCP
            - port: "993"
              protocol: TCP
            # POP3
            - port: "110"
              protocol: TCP
            - port: "995"
              protocol: TCP

    # =========================================================================
    # ICMP for debugging
    # =========================================================================
    - toEntities:
        - world
      icmps:
        - fields:
            - type: 8
