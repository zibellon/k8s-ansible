# =============================================================================
# Install Traefik via official Helm chart (traefik/traefik)
# Steps:
#   1. traefik/pre: NetworkPolicies for traefik namespace
#   2. Official traefik/traefik chart (DaemonSet, Services, RBAC, CRDs)
#   3. traefik/post: Middlewares + Dashboard Ingress
# =============================================================================

---
- name: Install Traefik via official Helm chart
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    - name: "[traefik-install-pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check.yaml
      vars:
        label_name: "traefik-install-pre-check"

    # =========================================================================
    # INIT: Merge ESO integrations and resolve Traefik config
    # =========================================================================

    - name: "[traefik-install-init] Merge ESO integrations"
      include_tasks: tasks/tasks-eso-merge.yaml

    - name: "[traefik-install-init] Set traefik_eso from merged integration"
      set_fact:
        traefik_eso: "{{ eso_vault_integration_traefik_merged }}"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 1: TRAEFIK/PRE (NetworkPolicies)
    # =========================================================================

    - name: "[traefik-pre] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "traefik-pre"
        chart_name: "pre"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/traefik/pre/"
        chart_remote_dest: "{{ remote_charts_dir }}/traefik/pre"

    - name: "[traefik-pre] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/pre/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[traefik-pre] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-pre {{ remote_charts_dir }}/traefik/pre
        --namespace {{ traefik_namespace }}
        --create-namespace
        --values {{ remote_charts_dir }}/traefik/pre/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # STEP 2: OFFICIAL TRAEFIK CHART
    # =========================================================================

    - name: "[traefik-install] Add Helm repository"
      include_tasks: tasks/tasks-add-helm-repo.yaml
      vars:
        label_name: "traefik-install"
        helm_repo_name: "traefik"
        helm_repo_url: "https://traefik.github.io/charts"

    - name: "[traefik-install] Create values directory"
      file:
        path: "{{ remote_charts_dir }}/traefik/install"
        state: directory
        mode: "0755"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[traefik-install] Create values-override.yaml"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/install/values-override.yaml"
        mode: "0644"
        content: |
          # Traefik Helm Chart Values
          # Generated from hosts.yaml variables

          image:
            tag: "{{ traefik_version }}"

          fullnameOverride: "{{ traefik_daemonset_name }}"

          serviceAccountAnnotations:
            app.kubernetes.io/component: ingress-controller

          deployment:
            kind: DaemonSet
            annotations:
              app.kubernetes.io/component: ingress-controller

          ingressClass:
            enabled: true
            name: "{{ traefik_ingress_class }}"
            isDefaultClass: false

          service:
            type: NodePort
            annotations:
              app.kubernetes.io/component: ingress-controller
            spec:
              externalTrafficPolicy: Local

          ports:
            traefik:
              port: 8080
              expose:
                default: false
            web:
              asDefault: true
              port: 80
              nodePort: 80
              expose:
                default: true
              exposedPort: 80
              forwardedHeaders:
                insecure: true
              proxyProtocol:
                insecure: true
              transport:
                respondingTimeouts:
                  idleTimeout: 600
                  writeTimeout: 600
                  readTimeout: 600
            websecure:
              asDefault: true
              port: 443
              nodePort: 443
              expose:
                default: true
              exposedPort: 443
              http:
                tls:
                  enabled: true
              forwardedHeaders:
                insecure: true
              proxyProtocol:
                insecure: true
              transport:
                respondingTimeouts:
                  idleTimeout: 600
                  writeTimeout: 600
                  readTimeout: 600
            metrics:
              expose:
                default: false

          providers:
            kubernetesCRD:
              enabled: true
              ingressClass: "{{ traefik_ingress_class }}"
              allowCrossNamespace: true
            kubernetesIngress:
              enabled: true
              ingressClass: "{{ traefik_ingress_class }}"
              publishedService:
                enabled: false

          logs:
            general:
              level: DEBUG
              format: json
            access:
              enabled: true
              format: json

          api:
            dashboard: true

          metrics:
            prometheus:
              entryPoint: metrics

          additionalArguments:
            - "--api.insecure=true"

          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532

          podSecurityContext:
            runAsNonRoot: true
            runAsUser: 65532
            runAsGroup: 65532

          # Separate Service for dashboard (ClusterIP)
          extraObjects:
            - apiVersion: v1
              kind: Service
              metadata:
                name: {{ traefik_dashboard_service_name }}
                labels:
                  app.kubernetes.io/name: traefik
                  app.kubernetes.io/instance: traefik-{{ traefik_namespace }}
              spec:
                type: ClusterIP
                selector:
                  app.kubernetes.io/name: traefik
                  app.kubernetes.io/instance: traefik-{{ traefik_namespace }}
                ports:
                  - name: dashboard
                    protocol: TCP
                    port: 8080
                    targetPort: 8080
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[traefik-install] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik traefik/traefik
        --namespace {{ traefik_namespace }}
        --version {{ traefik_chart_version }}
        --values {{ remote_charts_dir }}/traefik/install/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # WAIT FOR TRAEFIK CRDs
    # =========================================================================

    - name: "[traefik-install] Wait for CRDs"
      include_tasks: tasks/tasks-wait-crds.yaml
      vars:
        label_name: "traefik-install"
        crds_list:
          - crd/ingressroutes.traefik.io
          - crd/ingressroutetcps.traefik.io
          - crd/ingressrouteudps.traefik.io
          - crd/middlewares.traefik.io
          - crd/middlewaretcps.traefik.io
          - crd/serverstransports.traefik.io
          - crd/serverstransporttcps.traefik.io
          - crd/tlsoptions.traefik.io
          - crd/tlsstores.traefik.io
          - crd/traefikservices.traefik.io

    # =========================================================================
    # WAIT FOR TRAEFIK TO BE READY
    # =========================================================================

    - name: "[traefik-install] Wait for rollouts"
      include_tasks: tasks/tasks-wait-rollout.yaml
      vars:
        label_name: "traefik-install"
        rollout_namespace: "{{ traefik_namespace }}"
        rollout_timeout: "{{ traefik_rollout_timeout }}"
        rollout_resources:
          - daemonset/{{ traefik_daemonset_name }}

    # =========================================================================
    # STEP 3: TRAEFIK/POST (Middlewares + Dashboard Ingress)
    # =========================================================================

    - name: "[traefik-post] Copy chart to server"
      include_tasks: tasks/tasks-copy-chart.yaml
      vars:
        label_name: "traefik-post"
        chart_name: "post"
        chart_local_src: "{{ inventory_dir }}/playbook-app/charts/traefik/post/"
        chart_remote_dest: "{{ remote_charts_dir }}/traefik/post"

    - name: "[traefik-post] Create values file"
      copy:
        dest: "{{ remote_charts_dir }}/traefik/post/values-override.yaml"
        mode: "0644"
        content: |
          namespace: {{ traefik_namespace }}
          clusterDomain: {{ dns_domain }}
          ingressClass: {{ traefik_ingress_class }}
          entryPoints:
            web: {{ traefik_web_entrypoint }}
            websecure: {{ traefik_websecure_entrypoint }}
          vpnIps: {{ vpn_ips | to_json }}
          dashboard:
            serviceName: {{ traefik_dashboard_service_name }}
            domain: {{ traefik_dashboard_domain }}
            secretName: {{ traefik_dashboard_https_secret_name }}
            clusterIssuer: {{ cert_manager_cluster_issuer }}
            vpnOnlyEnabled: {{ traefik_dashboard_vpn_only_enabled }}
          vault:
            namespace: {{ vault_namespace }}
          eso:
            saName: {{ traefik_eso.sa_name }}
            roleName: {{ traefik_eso.role_name }}
            secretStoreName: {{ traefik_eso.secret_store_name }}
            kvEnginePath: {{ traefik_eso.kv_engine_path }}
            secrets: {{ traefik_eso.secrets | to_json }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    - name: "[traefik-post] Install or upgrade via Helm"
      command: >
        helm upgrade --install traefik-post {{ remote_charts_dir }}/traefik/post
        --namespace {{ traefik_namespace }}
        --values {{ remote_charts_dir }}/traefik/post/values-override.yaml
        --cleanup-on-fail
        --atomic
        --wait
        --wait-for-jobs
        --timeout {{ traefik_helm_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================

    - name: "[traefik-verify] Verify Helm releases"
      include_tasks: tasks/tasks-verify-helm.yaml
      vars:
        helm_namespace: "{{ traefik_namespace }}"
        label_name: "traefik-verify"

    - name: "[traefik-verify] Installation complete"
      debug:
        msg: "traefik-pre + traefik + traefik-post: OK"
      delegate_to: "{{ master_manager_fact }}"
      run_once: true
