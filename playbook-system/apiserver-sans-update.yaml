# =============================================================================
# Update API Server certSANs
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/apiserver-sans-update.yaml
# =============================================================================
# Run this playbook after adding a new control-plane node to hosts.yaml
# to update certSANs in API server certificates on all existing (joined) managers.
#
# This playbook:
#   1. Checks which managers are joined to cluster
#   2. Generates new kubeadm-config.yaml with updated certSANs on joined managers
#   3. Uploads config to cluster ConfigMap (kubeadm-config in kube-system)
#   4. Removes old apiserver certificates
#   5. Generates new apiserver certificates with updated SANs
#   6. Restarts apiservers sequentially (for HA)
#
# Nodes not yet joined to cluster are automatically skipped.
# =============================================================================

---
- name: Update API Server certSANs
  hosts: managers
  become: true
  gather_facts: false

  tasks:
    # =========================================================================
    # CHECK WHICH MANAGERS ARE JOINED
    # =========================================================================
    - name: Check which nodes are joined to cluster
      include_tasks: tasks/tasks-check-node-joined.yaml

    # =========================================================================
    # UPDATE CERTSANS ON JOINED MANAGERS ONLY
    # =========================================================================
    - name: Update certSANs on joined managers
      when: is_node_joined
      block:
        # =====================================================================
        # STEP 1: Generate kubeadm-config on joined managers (parallel)
        # =====================================================================
        - name: Generate kubeadm config
          include_tasks: tasks/tasks-generate-kubeadm-config.yaml

        # =====================================================================
        # STEP 2: Upload config to cluster ConfigMap (master only)
        # =====================================================================
        - name: Upload kubeadm config to cluster ConfigMap
          command: >-
            kubeadm init phase upload-config kubeadm
            --config {{ kubeadm_config_path }}
          delegate_to: "{{ master_manager_fact }}"
          run_once: true

        - name: Print upload config status
          debug:
            msg: "kubeadm config uploaded to cluster ConfigMap (kube-system/kubeadm-config)"
          run_once: true

        # =====================================================================
        # STEP 3: Remove old apiserver certificates (joined managers, parallel)
        # =====================================================================
        - name: Remove old apiserver certificate
          file:
            path: /etc/kubernetes/pki/apiserver.crt
            state: absent

        - name: Remove old apiserver key
          file:
            path: /etc/kubernetes/pki/apiserver.key
            state: absent

        - name: Print certificate removal status
          debug:
            msg: "Old apiserver.crt and apiserver.key removed on {{ inventory_hostname }}"

        # =====================================================================
        # STEP 4: Generate new apiserver certificates (joined managers, parallel)
        # =====================================================================
        - name: Generate new apiserver certificate
          command: >-
            kubeadm init phase certs apiserver
            --config {{ kubeadm_config_path }}
          register: cert_gen_result

        - name: Print certificate generation status
          debug:
            msg: "New apiserver certificate generated on {{ inventory_hostname }}"

        # =====================================================================
        # VERIFICATION
        # =====================================================================
        - name: Get current certSANs from apiserver certificate
          shell: >-
            openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout |
            grep -A1 "Subject Alternative Name" |
            tail -1 |
            tr ',' '\n' |
            sed 's/^ *//'
          register: current_sans_result
          changed_when: false

        - name: Print verification
          debug:
            msg:
              - "=== API Server certSANs updated on {{ inventory_hostname }} ==="
              - "Current SANs:"
              - "{{ current_sans_result.stdout_lines }}"

        # =====================================================================
        # STEP 5: Restart apiservers sequentially (for HA)
        # =====================================================================
        - name: Restart apiserver sequentially
          throttle: 1
          block:
            - name: Restart apiserver
              include_tasks: tasks/task-restart-apiserver.yaml
              vars:
                target_host: "{{ inventory_hostname }}"

    # =========================================================================
    # SKIP MESSAGE FOR NOT JOINED MANAGERS
    # =========================================================================
    - name: Print skip message for not joined managers
      debug:
        msg: "SKIP: {{ inventory_hostname }} ({{ api_server_advertise_address }}) - not joined to cluster yet"
      when: not is_node_joined
