---
# =============================================================================
# Remove worker node from Kubernetes cluster
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/node-remove.yaml --limit k8s-worker-2
# =============================================================================
# Only works with nodes from 'workers' group
# =============================================================================

- name: Remove worker node from cluster
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-limit.yaml

    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-worker.yaml

    # =========================================================================
    # GATHER CLUSTER FACTS
    # =========================================================================
    - name: Gather cluster facts
      include_tasks: tasks/tasks-gather-cluster-facts.yaml

    # =========================================================================
    # PRE-CHECK: Prevent removing master manager
    # =========================================================================
    - name: Fail if trying to remove master manager node
      fail:
        msg: "ERROR: Cannot remove master manager node ({{ master_manager_fact }}). This node manages the cluster."
      when: new_hostname == master_manager_fact
      run_once: true

    # =========================================================================
    # DELETE NODE
    # =========================================================================
    - name: Delete node from cluster
      command: kubectl delete node {{ new_hostname }}
      delegate_to: "{{ master_manager_fact }}"
      register: delete_result
      when: is_node_joined
      run_once: true

    - name: Print delete result
      debug:
        msg: "{{ delete_result.stdout }}"
      when: is_node_joined and delete_result.stdout is defined
      run_once: true

    # =========================================================================
    # VERIFICATION
    # =========================================================================
    - name: Get final cluster nodes
      command: kubectl get nodes -o wide
      delegate_to: "{{ master_manager_fact }}"
      register: final_nodes
      changed_when: false
      run_once: true

    - name: Print cluster status
      debug:
        msg:
          - "=== Node {{ new_hostname }} Removed ==="
          - "{{ final_nodes.stdout_lines }}"
      run_once: true
