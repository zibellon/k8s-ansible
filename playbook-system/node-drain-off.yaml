---
# =============================================================================
# Return node to cluster after maintenance
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/node-drain-off.yaml --limit k8s-worker-3
#
# This playbook:
#   1. Waits for node to be Ready
#   2. Uncordons the node (enables scheduling)
# =============================================================================

- name: Return node to cluster
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-limit.yaml

    # =========================================================================
    # GATHER CLUSTER FACTS
    # =========================================================================
    - name: Gather cluster facts
      include_tasks: tasks/tasks-gather-cluster-facts.yaml

    # =========================================================================
    # PRE-CHECK: Verify node is joined
    # =========================================================================
    - name: Fail if node not in cluster
      fail:
        msg: "Node {{ new_hostname }} not found in cluster"
      when: not is_node_joined

    # =========================================================================
    # UNCORDON: Enable scheduling on node
    # =========================================================================
    - name: Uncordon node
      command: kubectl uncordon {{ new_hostname }}
      delegate_to: "{{ master_manager_fact }}"
      register: uncordon_result
      changed_when: "'uncordoned' in uncordon_result.stdout"

    - name: Show uncordon result
      debug:
        msg: "{{ uncordon_result.stdout }}"
