---
# =============================================================================
# Return node to cluster after maintenance
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/node-drain-off.yaml --limit k8s-worker-3
#
# This playbook:
#   1. Waits for node to be Ready
#   2. Uncordons the node (enables scheduling)
# =============================================================================

- name: Return node to cluster
  hosts: all
  become: true
  gather_facts: false

  vars:
    wait_timeout: 300  # 5 minutes
    wait_interval: 10  # check every 10 seconds

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check-limit.yaml

    # =========================================================================
    # FIND MASTER MANAGER
    # =========================================================================
    - name: Find master manager
      include_tasks: tasks/tasks-find-master-manager.yaml

    # =========================================================================
    # WAIT FOR NODE READY
    # =========================================================================
    - name: Wait for node to be Ready
      command: kubectl get node {{ new_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      delegate_to: "{{ master_manager_fact }}"
      register: node_ready_check
      until: node_ready_check.stdout == 'True'
      retries: "{{ (wait_timeout / wait_interval) | int }}"
      delay: "{{ wait_interval }}"
      changed_when: false

    - name: Show node Ready status
      debug:
        msg: "Node {{ new_hostname }} is Ready"

    # =========================================================================
    # UNCORDON: Enable scheduling on node
    # =========================================================================
    - name: Uncordon node
      command: kubectl uncordon {{ new_hostname }}
      delegate_to: "{{ master_manager_fact }}"
      register: uncordon_result
      changed_when: "'uncordoned' in uncordon_result.stdout"

    - name: Show uncordon result
      debug:
        msg: "{{ uncordon_result.stdout }}"
