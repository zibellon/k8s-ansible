# =============================================================================
# HAProxy API Server Load Balancer (static pod)
# Deploys HAProxy as static pod on nodes for kube-apiserver HA
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/haproxy-apiserver-lb.yaml --limit k8s-worker-1
#
# This playbook:
#   1. Creates /etc/kubernetes/haproxy-apiserver-lb.cfg with all manager IPs
#   2. Creates /etc/kubernetes/manifests/haproxy-apiserver-lb.yaml (static pod)
#   3. For nodes NOT YET joined: creates standalone kubelet drop-in + minimal config
#      Kubelet runs in standalone mode (no kubeconfig required) and starts static pods
#   4. After kubeadm init/join, the standalone drop-in is removed
# =============================================================================

---
- name: Deploy HAProxy API Server LB
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-pre-check-limit.yaml

    # =========================================================================
    # DETERMINE NODE STATE
    # =========================================================================
    - name: Check if kubelet config exists
      stat:
        path: /var/lib/kubelet/config.yaml
      register: kubelet_config_stat

    - name: Check if standalone drop-in exists
      stat:
        path: /etc/systemd/system/kubelet.service.d/20-standalone.conf
      register: standalone_dropin_stat

    - name: Set node facts
      set_fact:
        is_joined: "{{ kubelet_config_stat.stat.exists and not standalone_dropin_stat.stat.exists }}"

    - name: Print node state
      debug:
        msg: "Node {{ inventory_hostname }}: joined={{ is_joined }}"

    # =========================================================================
    # HAPROXY CONFIG + STATIC POD MANIFEST
    # =========================================================================
    - name: Generate HAProxy config and static pod manifest
      include_tasks: tasks/tasks-haproxy-config-create.yaml

    # =========================================================================
    # BOOTSTRAP KUBELET STANDALONE MODE (for nodes before kubeadm init/join)
    # Kubelet systemd drop-in normally requires --kubeconfig which doesn't exist yet.
    # We create a standalone drop-in that runs kubelet with only --config flag.
    # This allows kubelet to run static pods without API server connection.
    # =========================================================================
    - name: Create kubelet directory
      file:
        path: /var/lib/kubelet
        state: directory
        mode: "0755"
      when: not is_joined

    - name: Create minimal kubelet config for standalone mode
      copy:
        dest: /var/lib/kubelet/config.yaml
        mode: "0644"
        content: |
          apiVersion: kubelet.config.k8s.io/v1beta1
          kind: KubeletConfiguration
          # Standalone mode config - no API server connection
          cgroupDriver: systemd
          staticPodPath: /etc/kubernetes/manifests
          containerRuntimeEndpoint: unix:///var/run/containerd/containerd.sock
          # Disable auth - kubelet works standalone
          authentication:
            anonymous:
              enabled: true
            webhook:
              enabled: false
          authorization:
            mode: AlwaysAllow
          # Health check binding
          healthzBindAddress: 127.0.0.1
          healthzPort: 10248
      when: not is_joined
      register: kubelet_standalone_config

    # Create systemd drop-in that overrides ExecStart
    # This removes --kubeconfig and --bootstrap-kubeconfig flags
    - name: Create kubelet drop-in directory
      file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory
        mode: "0755"
      when: not is_joined

    - name: Create kubelet standalone drop-in
      copy:
        dest: /etc/systemd/system/kubelet.service.d/20-standalone.conf
        mode: "0644"
        content: |
          # Standalone mode for static pods before kubeadm init/join
          # This drop-in is removed after kubeadm init/join
          [Service]
          ExecStart=
          ExecStart=/usr/bin/kubelet --config=/var/lib/kubelet/config.yaml
      when: not is_joined
      register: kubelet_standalone_dropin

    - name: Reload systemd and restart kubelet
      systemd:
        daemon_reload: true
        name: kubelet
        state: restarted
      when:
        - not is_joined
        - kubelet_standalone_dropin.changed or kubelet_standalone_config.changed

    - name: Wait for kubelet to be ready
      uri:
        url: "http://127.0.0.1:10248/healthz"
        status_code: 200
      register: kubelet_health
      until: kubelet_health.status == 200
      retries: 10
      delay: 2
      when:
        - not is_joined
        - kubelet_standalone_dropin.changed or kubelet_standalone_config.changed

    # =========================================================================
    # WAIT FOR HAPROXY
    # =========================================================================
    - name: Set haproxy_needs_wait fact
      set_fact:
        haproxy_needs_wait: >-
          {{
            haproxy_config_result.changed or
            haproxy_manifest_result.changed or
            (kubelet_standalone_dropin.changed | default(false)) or
            (kubelet_standalone_config.changed | default(false))
          }}

    - name: Wait for HAProxy static pod to be ready
      include_tasks: tasks/tasks-haproxy-health-wait.yaml
      when: haproxy_needs_wait

    # =========================================================================
    # CLEANUP STANDALONE MODE (for nodes before kubeadm init/join)
    # HAProxy is running via containerd, kubelet no longer needed in standalone mode.
    # Stop kubelet and remove drop-in so kubeadm init/join can start fresh.
    # HAProxy container will continue running (containerd manages it).
    # =========================================================================
    - name: Remove standalone kubelet drop-in
      file:
        path: /etc/systemd/system/kubelet.service.d/20-standalone.conf
        state: absent
      when:
        - not is_joined
        - kubelet_standalone_dropin.changed | default(false)

    - name: Remove standalone kubelet config
      file:
        path: /var/lib/kubelet/config.yaml
        state: absent
      when:
        - not is_joined
        - kubelet_standalone_config.changed | default(false)

    - name: Reload systemd and restart kubelet
      systemd:
        daemon_reload: true
        name: kubelet
        state: restarted
      when:
        - not is_joined
        - kubelet_standalone_dropin.changed | default(false)
      failed_when: false

    - name: Print cleanup status
      debug:
        msg: "Kubelet stopped, standalone drop-in removed. Ready for kubeadm init/join."
      when:
        - not is_joined
        - kubelet_standalone_dropin.changed | default(false)
