---
# =============================================================================
# Drain node for maintenance
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/node-drain-on.yaml --limit k8s-worker-3
#
# This playbook:
#   1. Cordons the node (disables scheduling)
#   2. Drains all pods (with Longhorn eviction support)
#
# After running this playbook, you can safely:
#   - Reboot the node
#   - Perform maintenance (disk replacement, OS upgrade, etc.)
# =============================================================================

- name: Cordon and Drain node
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-limit.yaml

    # =========================================================================
    # GATHER CLUSTER FACTS
    # =========================================================================
    - name: Gather cluster facts
      include_tasks: tasks/tasks-gather-cluster-facts.yaml

    # =========================================================================
    # PRE-CHECK: Verify node is joined
    # =========================================================================
    - name: Fail if node not in cluster
      fail:
        msg: "Node {{ new_hostname }} not found in cluster"
      when: not is_node_joined

    # =========================================================================
    # CORDON: Disable scheduling on node
    # =========================================================================
    - name: Cordon node
      command: kubectl cordon {{ new_hostname }}
      delegate_to: "{{ master_manager_fact }}"
      register: cordon_result
      changed_when: "'cordoned' in cordon_result.stdout"

    - name: Show cordon result
      debug:
        msg: "{{ cordon_result.stdout }}"

    # =========================================================================
    # DRAIN: Evict all pods from node
    # =========================================================================
    - name: Drain node (this may take a while if Longhorn needs to evict replicas)
      command: >
        kubectl drain {{ new_hostname }}
        --ignore-daemonsets
        --delete-emptydir-data
        --timeout={{ node_drain_timeout }}
      delegate_to: "{{ master_manager_fact }}"
      register: drain_result
      failed_when: false

    - name: Show drain result
      debug:
        msg: "{{ drain_result.stdout_lines | default(['Drain completed']) }}"

    - name: Show drain warnings (if any)
      debug:
        msg: "WARNING: {{ drain_result.stderr_lines }}"
      when: drain_result.stderr_lines is defined and drain_result.stderr_lines | length > 0

    - name: Check drain success
      set_fact:
        drain_success: "{{ drain_result.rc == 0 }}"

    - name: Warn if drain failed
      debug:
        msg: |
          WARNING: Drain did not complete successfully!
          This may happen if Longhorn is still evicting replicas.
          You can proceed with maintenance, but be aware of potential issues.
          
          To force continue anyway, kubelet will be stopped.
      when: not drain_success
