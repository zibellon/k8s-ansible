# =============================================================================
# Update HAProxy config on all joined hosts
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/haproxy-apiserver-lb-update.yaml
#
# This playbook:
#   1. Checks which nodes are joined to cluster via kubectl on master_manager
#   2. Updates HAProxy config only on joined nodes (sequentially via serial: 1)
#   3. Skips nodes not yet joined (e.g., new node being added)
#
# Use case: Before adding a new manager, update HAProxy config on all existing
# hosts so they know about the new manager IP.
# =============================================================================

# =============================================================================
# PLAY 1: Check which nodes are joined (parallel)
# =============================================================================
---
- name: "HAProxy Update - Play 1: Check joined nodes"
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Check which nodes are joined to cluster
      include_tasks: tasks/tasks-check-node-joined.yaml

# =============================================================================
# PLAY 2: Update HAProxy config (serial: 1)
# =============================================================================
- name: "HAProxy Update - Play 2: Update config"
  hosts: all
  become: true
  gather_facts: false
  serial: 1

  tasks:
    - name: Update HAProxy config and wait
      include_tasks: tasks/tasks-haproxy-config-update-and-wait.yaml
      when: is_node_joined

    - name: Print skip message for not joined nodes
      debug:
        msg: "SKIP: {{ inventory_hostname }} ({{ internal_ip }}) - not joined to cluster"
      when: not is_node_joined
