# =============================================================================
# Pre-check: validate target is a secondary manager (not master)
# =============================================================================
# Shared tasks for validating playbook target
#
# Used by manager-join.yaml for joining additional control-plane nodes
#
# Requires:
#   - Run with --limit <manager_node>
#   - Target must be in 'managers' group
#   - Target must NOT have is_master: true
# =============================================================================

- name: Find master manager
  set_fact:
    master_manager_fact: "{{ item }}"
  loop: "{{ groups['managers'] }}"
  when: hostvars[item].is_master | default(false)
  run_once: true

- name: Fail if no master manager found
  fail:
    msg: "ERROR: No manager with is_master: true found in hosts.yaml"
  when: master_manager_fact is not defined
  run_once: true

- name: Fail if no limit specified
  fail:
    msg: "ERROR: --limit required. Use: ansible-playbook -i hosts.yaml <playbook> --limit <manager_node>"
  when: ansible_limit is not defined
  run_once: true

- name: Fail if not a manager node
  fail:
    msg: "ERROR: {{ inventory_hostname }} is not in 'managers' group"
  when: inventory_hostname not in groups['managers']

- name: Fail if target is the master manager
  fail:
    msg: "ERROR: {{ inventory_hostname }} is the master manager. Use init-cluster.yaml instead."
  when: inventory_hostname == master_manager_fact

- name: Confirm target
  debug:
    msg: "Target: {{ inventory_hostname }} (secondary manager)"
