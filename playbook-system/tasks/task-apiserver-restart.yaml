# =============================================================================
# Restart kube-apiserver on current host
# =============================================================================
# Used with serial: 1 play for sequential execution across hosts
# =============================================================================

---
# Move manifest out - apiserver will stop
- name: "Move kube-apiserver manifest to /tmp"
  command: mv /etc/kubernetes/manifests/kube-apiserver.yaml /tmp/

# Wait for apiserver to stop (expect error)
- name: "Wait for kube-apiserver to stop"
  command: curl -sk --max-time 5 https://localhost:6443/healthz
  register: stop_check
  until: stop_check.rc != 0
  retries: 12
  delay: 5
  failed_when: false

# Move manifest back - apiserver will start
- name: "Move kube-apiserver manifest back"
  command: mv /tmp/kube-apiserver.yaml /etc/kubernetes/manifests/

# Wait for apiserver to be healthy
- name: "Wait for kube-apiserver to be healthy"
  command: curl -sk --max-time 5 https://localhost:6443/healthz
  register: health_check
  until: health_check.rc == 0 and health_check.stdout == "ok"
  retries: 30
  delay: 10
