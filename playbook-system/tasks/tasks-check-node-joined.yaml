# =============================================================================
# Check if nodes are joined to Kubernetes cluster
# =============================================================================
# Sets fact: joined_node_ips (list of IPs of joined nodes)
# Sets fact: is_node_joined (true/false for current host)
#
# Used by:
#   - haproxy-apiserver-lb-update.yaml (update config on joined nodes only)
#   - apiserver-sans-update.yaml (update SANS on joined managers only)
#
# Detection: kubectl get nodes on master_manager
# Compares internal_ip with INTERNAL-IP from cluster
# =============================================================================

# Find master_manager
- name: Find master manager
  include_tasks: tasks/tasks-find-master-manager.yaml

# Get nodes from cluster (delegate_to master_manager)
- name: Get cluster nodes with IPs
  command: >-
    kubectl get nodes
    -o jsonpath='{range .items[*]}{.status.addresses[?(@.type=="InternalIP")].address}{"\n"}{end}'
  delegate_to: "{{ master_manager_fact }}"
  register: cluster_nodes_result
  changed_when: false

# Build list of joined IPs
- name: Set joined_node_ips fact
  set_fact:
    joined_node_ips: "{{ cluster_nodes_result.stdout_lines | select | list }}"

- name: Print joined node IPs
  debug:
    msg: "Joined node IPs: {{ joined_node_ips }}"
  run_once: true

# Each host checks itself (NO run_once - runs on each host)
- name: Set is_node_joined fact for each host
  set_fact:
    is_node_joined: "{{ internal_ip in joined_node_ips }}"

- name: Print node join status
  debug:
    msg: "Node {{ inventory_hostname }} ({{ internal_ip }}): joined={{ is_node_joined }}"
