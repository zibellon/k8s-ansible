# =============================================================================
# Check if nodes are joined to Kubernetes cluster
# =============================================================================
# Sets fact: joined_node_ips (list of IPs of joined nodes)
# Sets fact: is_node_joined (true/false for current host)
#
# Used by:
#   - haproxy-apiserver-lb-update.yaml (update config on joined nodes only)
#   - update-apiserver-sans.yaml (update SANS on joined managers only)
#
# Detection: kubectl get nodes on master_manager
# Compares internal_ip with INTERNAL-IP from cluster
# =============================================================================

# Find master_manager (run_once)
- name: Find master manager
  set_fact:
    master_manager_fact: "{{ item }}"
  loop: "{{ groups['managers'] }}"
  when: hostvars[item].is_master | default(false)
  run_once: true

- name: Fail if no master manager found
  fail:
    msg: "ERROR: No manager with is_master: true found in hosts.yaml"
  when: master_manager_fact is not defined
  run_once: true

# Get nodes from cluster (delegate_to master_manager, run_once)
- name: Get cluster nodes with IPs
  command: >-
    kubectl get nodes
    -o jsonpath='{range .items[*]}{.status.addresses[?(@.type=="InternalIP")].address}{"\n"}{end}'
  delegate_to: "{{ master_manager_fact }}"
  register: cluster_nodes_result
  changed_when: false
  run_once: true

# Build list of joined IPs (run_once)
- name: Set joined_node_ips fact
  set_fact:
    joined_node_ips: "{{ cluster_nodes_result.stdout_lines | select | list }}"
  run_once: true

- name: Print joined node IPs
  debug:
    msg: "Joined node IPs: {{ joined_node_ips }}"
  run_once: true

# Each host checks itself (NO run_once - runs on each host)
- name: Set is_node_joined fact for each host
  set_fact:
    is_node_joined: "{{ internal_ip in joined_node_ips }}"

- name: Print node join status
  debug:
    msg: "Node {{ inventory_hostname }} ({{ internal_ip }}): joined={{ is_node_joined }}"
