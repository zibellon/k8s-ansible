# =============================================================================
# Generate kubeadm config file
# =============================================================================
# Shared task for generating kubeadm-config.yaml
#
# Used by:
#   - init-cluster.yaml (cluster initialization)
#   - update-apiserver-sans.yaml (update certSANs after adding new control-plane)
#
# Required variables:
#   - kubeadm_config_path: path to save config (defined in hosts.yaml)
# =============================================================================

- name: Fail if kubeadm_config_path not defined
  fail:
    msg: "ERROR: kubeadm_config_path variable is required (should be defined in hosts.yaml)"
  when: kubeadm_config_path is not defined

- name: Ensure kubeadm config directory exists
  file:
    path: "{{ kubeadm_config_path | dirname }}"
    state: directory
    mode: '0755'

# Build certSANs list from all managers in hosts.yaml
- name: Build certSANs list
  set_fact:
    cert_sans: >-
      {{
        [haproxy_apiserver_lb_host, 'localhost', api_server_advertise_address] +
        groups['managers'] | map('extract', hostvars, 'api_server_advertise_address') | list +
        groups['managers'] | map('extract', hostvars, 'ansible_host') | list
      }}

- name: Print certSANs
  debug:
    msg: "certSANs: {{ cert_sans }}"

# Generate full kubeadm config (kubeadm uses only needed sections for each command)
- name: Create kubeadm config
  copy:
    dest: "{{ kubeadm_config_path }}"
    content: |
      apiVersion: kubeadm.k8s.io/v1beta4
      kind: InitConfiguration
      localAPIEndpoint:
        advertiseAddress: "{{ api_server_advertise_address }}"
        bindPort: {{ api_server_bind_port }}
      nodeRegistration:
        criSocket: "unix:///var/run/containerd/containerd.sock"
      ---
      apiVersion: kubeadm.k8s.io/v1beta4
      kind: ClusterConfiguration
      kubernetesVersion: "{{ k8s_full_version }}"
      controlPlaneEndpoint: "{{ haproxy_apiserver_lb_host }}:{{ haproxy_apiserver_lb_port }}"
      apiServer:
        extraArgs:
          - name: service-node-port-range
            value: "{{ node_port_start }}-{{ node_port_end }}"
          - name: encryption-provider-config
            value: "{{ etcd_encryption_config_path }}"
        extraVolumes:
          - name: encryption-config
            hostPath: "{{ etcd_encryption_config_path }}"
            mountPath: "{{ etcd_encryption_config_path }}"
            readOnly: true
            pathType: File
        certSANs: {{ cert_sans | to_json }}
      networking:
        serviceSubnet: "{{ service_subnet }}"
        podSubnet: "{{ pod_subnet }}"
        dnsDomain: "{{ dns_domain }}"
      controllerManager:
        extraArgs:
          - name: allocate-node-cidrs
            value: "false"
          - name: node-monitor-grace-period
            value: "{{ node_monitor_grace_period }}"
      ---
      apiVersion: kubelet.config.k8s.io/v1beta1
      kind: KubeletConfiguration
      cgroupDriver: systemd
      containerLogMaxSize: {{ kubelet_container_log_max_size }}
      containerLogMaxFiles: {{ kubelet_container_log_max_files }}
      featureGates:
        KubeletCrashLoopBackOffMax: true
      crashLoopBackOff:
        maxContainerRestartPeriod: {{ kubelet_crashloop_max_backoff }}
      imageGCHighThresholdPercent: {{ kubelet_image_gc_high_threshold }}
      imageGCLowThresholdPercent: {{ kubelet_image_gc_low_threshold }}
      imageMinimumGCAge: {{ kubelet_image_minimum_gc_age }}
      {% if kubelet_eviction_soft_enabled | default(false) %}
      evictionSoft:
        memory.available: "{{ kubelet_eviction_soft_memory_available }}"
        nodefs.available: "{{ kubelet_eviction_soft_nodefs_available }}"
        imagefs.available: "{{ kubelet_eviction_soft_imagefs_available }}"
      evictionSoftGracePeriod:
        memory.available: "{{ kubelet_eviction_soft_grace_period_memory }}"
        nodefs.available: "{{ kubelet_eviction_soft_grace_period_nodefs }}"
        imagefs.available: "{{ kubelet_eviction_soft_grace_period_imagefs }}"
      {% else %}
      evictionSoft: {}
      {% endif %}
      {% if kubelet_eviction_hard_enabled | default(true) %}
      evictionHard:
        memory.available: "{{ kubelet_eviction_hard_memory_available }}"
        nodefs.available: "{{ kubelet_eviction_hard_nodefs_available }}"
        nodefs.inodesFree: "{{ kubelet_eviction_hard_nodefs_inodes_free }}"
        imagefs.available: "{{ kubelet_eviction_hard_imagefs_available }}"
        pid.available: "{{ kubelet_eviction_hard_pid_available }}"
      {% else %}
      evictionHard: {}
      {% endif %}
      ---
      apiVersion: kubeproxy.config.k8s.io/v1alpha1
      kind: KubeProxyConfiguration
      mode: ipvs
    mode: '0644'

- name: Print kubeadm config path
  debug:
    msg: "kubeadm config created at {{ kubeadm_config_path }}"
