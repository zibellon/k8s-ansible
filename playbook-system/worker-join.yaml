---
# =============================================================================
# Join worker node to the cluster
# =============================================================================
# Usage:
#   ansible-playbook -i hosts.yaml playbook-system/worker-join.yaml --limit k8s-worker-2
# =============================================================================

- name: Join worker to cluster
  hosts: workers
  become: true
  gather_facts: false

  tasks:
    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-limit.yaml

    - name: "[pre-check] Validate target"
      include_tasks: tasks/tasks-require-worker.yaml

    # =========================================================================
    # GATHER CLUSTER FACTS
    # =========================================================================
    - name: Gather cluster facts
      include_tasks: tasks/tasks-gather-cluster-facts.yaml

    - name: Generate join command
      command: kubeadm token create --print-join-command
      delegate_to: "{{ master_manager_fact }}"
      register: join_command_result
      changed_when: false

    - name: Set join command as fact
      set_fact:
        kubeadm_join_command_fact: "{{ join_command_result.stdout }}"

    - name: Print join command
      debug:
        msg: "{{ kubeadm_join_command_fact }}"

    # =========================================================================
    # JOIN WORKER
    # =========================================================================
    - name: Join cluster
      command: "{{ kubeadm_join_command_fact }}"
      register: join_result
      when: not is_node_joined

    - name: Print join result
      debug:
        msg: "{{ join_result.stdout_lines }}"
      when: not is_node_joined and join_result.stdout_lines is defined

    # =========================================================================
    # VERIFY KUBELET
    # =========================================================================
    - name: Wait for kubelet
      pause:
        seconds: 10
      when: not is_node_joined

    - name: Check kubelet status
      command: systemctl is-active kubelet
      register: kubelet_status
      changed_when: false
      failed_when: false

    - name: Assert kubelet is running
      assert:
        that:
          - kubelet_status.stdout == 'active'
        fail_msg: "kubelet is NOT running!"
        success_msg: "{{ new_hostname }}: kubelet running"

    # =========================================================================
    # APPLY NODE LABELS
    # =========================================================================
    - name: Apply node labels
      include_tasks: tasks/tasks-apply-node-labels.yaml
      vars:
        kubectl_delegate_host: "{{ master_manager_fact }}"

    # =========================================================================
    # APPLY LONGHORN DEFAULT NODE TAGS
    # =========================================================================
    - name: Apply Longhorn default node tags
      include_tasks: tasks/tasks-apply-longhorn-tags.yaml
      vars:
        kubectl_delegate_host: "{{ master_manager_fact }}"

    # =========================================================================
    # VERIFICATION
    # =========================================================================
    - name: Wait for node registration
      pause:
        seconds: 10

    - name: Get cluster nodes
      command: kubectl get nodes -o wide
      delegate_to: "{{ master_manager_fact }}"
      register: final_nodes_result
      changed_when: false

    - name: Print cluster status
      debug:
        msg:
          - "=== Cluster Nodes ==="
          - "{{ final_nodes_result.stdout_lines }}"
